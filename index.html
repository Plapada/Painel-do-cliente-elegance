<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Clientes - CRM Elegance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: {
                            DEFAULT: 'hsl(var(--primary))',
                            foreground: 'hsl(var(--primary-foreground))',
                        },
                        secondary: {
                            DEFAULT: 'hsl(var(--secondary))',
                            foreground: 'hsl(var(--secondary-foreground))',
                        },
                        destructive: {
                            DEFAULT: 'hsl(var(--destructive))',
                            foreground: 'hsl(var(--destructive-foreground))',
                        },
                        muted: {
                            DEFAULT: 'hsl(var(--muted))',
                            foreground: 'hsl(var(--muted-foreground))',
                        },
                        accent: {
                            DEFAULT: 'hsl(var(--accent))',
                            foreground: 'hsl(var(--accent-foreground))',
                        },
                        popover: {
                            DEFAULT: 'hsl(var(--popover))',
                            foreground: 'hsl(var(--popover-foreground))',
                        },
                        card: {
                            DEFAULT: 'hsl(var(--card))',
                            foreground: 'hsl(var(--card-foreground))',
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        @layer base {
            :root {
                --radius: 0.75rem;
                --background: 0 0% 100%;
                --foreground: 0 0% 15%;
                --card: 0 0% 100%;
                --card-foreground: 0 0% 15%;
                --popover: 0 0% 100%;
                --popover-foreground: 0 0% 15%;
                --primary: 39 92% 51%;
                --primary-foreground: 0 0% 0%;
                --secondary: 220 14% 96%;
                --secondary-foreground: 215 15% 34%;
                --muted: 220 17% 98%;
                --muted-foreground: 215 14% 47%;
                --accent: 51 100% 96%;
                --accent-foreground: 26 84% 31%;
                --destructive: 0 84% 60%;
                --destructive-foreground: 0 0% 100%;
                --border: 220 13% 91%;
                --input: 220 13% 91%;
                --ring: 39 92% 51%;
            }

            .dark {
                --background: 0 0% 0%;
                --foreground: 0 0% 100%;
                --card: 0 0% 8%;
                --card-foreground: 0 0% 100%;
                --popover: 0 0% 15%;
                --popover-foreground: 0 0% 100%;
                --primary: 39 92% 51%;
                --primary-foreground: 0 0% 0%;
                --secondary: 0 0% 15%;
                --secondary-foreground: 0 0% 100%;
                --muted: 0 0% 15%;
                --muted-foreground: 0 0% 80%;
                --accent: 26 84% 31%;
                --accent-foreground: 46 95% 76%;
                --destructive: 0 84% 60%;
                --destructive-foreground: 0 0% 100%;
                --border: 0 0% 25%;
                --input: 0 0% 25%;
                --ring: 39 92% 51%;
            }
        }
        
        #auth-section .tracking-wider {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }
        .page-section h1, #login-form h1 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        /* Mapeamento das variáveis de cor para o novo componente */
        :root {
            --color-bg: hsl(var(--background));
            --color-surface: hsl(var(--card));
            --color-muted-surface: hsl(var(--muted));
            --color-border: hsl(var(--border));
            --color-text-secondary: hsl(var(--muted-foreground));
            --color-text-primary: hsl(var(--foreground));
            --color-heading: hsl(var(--foreground));
            --color-bg-2: hsl(var(--secondary));
        }

        @layer base {
            * {
                @apply border-border;
            }

            body {
                @apply bg-background text-foreground;
                font-family: 'Manrope', sans-serif;
            }

            .active-chat-indicator::before {
                content: '';
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 4px;
                height: 60%;
                background-color: hsl(var(--primary));
                border-radius: 0 4px 4px 0;
            }

            .nav-link.active {
                background-color: hsl(var(--primary) / 0.1);
                color: hsl(var(--primary));
                font-weight: 600;
            }

            .nav-link.active svg {
                color: hsl(var(--primary));
            }

            .dark .nav-link:not(.active) span {
                color: hsl(0 0% 90%);
            }

            .dark .nav-link:not(.active) svg {
                color: hsl(0 0% 90%);
            }

            .dark .nav-link:not(.active):hover span,
            .dark .nav-link:not(.active):hover svg {
                color: hsl(var(--primary));
            }

            .dark #user-profile-link-wrapper .nav-text {
                color: hsl(var(--foreground));
            }

            .light .dashboard-card {
                background-color: hsl(var(--secondary));
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            }

            .material-symbols-outlined {
                font-variation-settings:
                    'FILL' 0,
                    'wght' 400,
                    'GRAD' 0,
                    'opsz' 24
            }
        }

        /* View Transition API styles */
        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }
        ::view-transition-old(root) {
            z-index: 1;
        }
        ::view-transition-new(root) {
            z-index: 9999;
        }

        /* Estilos do Kanban */
        .kanban-card {
            @apply rounded-xl border bg-card text-card-foreground shadow-sm p-5 cursor-grab;
        }
        .kanban-card:active {
            @apply cursor-grabbing shadow-lg scale-105;
        }
        .sortable-ghost {
            @apply opacity-40 bg-muted rounded-lg;
        }
        .sortable-chosen {
             @apply shadow-xl scale-105;
        }
        .kanban-badge {
            @apply inline-flex items-center rounded-sm px-1.5 text-[11px] font-semibold;
        }
        .kanban-badge-destructive {
            @apply bg-destructive/20 text-destructive dark:text-red-500;
        }
        .kanban-badge-primary {
            @apply bg-primary/10 text-primary dark:text-amber-400;
        }
        .kanban-badge-warning {
            @apply bg-yellow-400/20 text-yellow-600 dark:text-yellow-400;
        }

        /* Melhorias visuais para o modo claro do Kanban */
        .light .kanban-cards-container {
            background-color: hsl(var(--secondary));
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }
        .light .kanban-card {
            background-color: hsl(var(--card));
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            @apply bg-border rounded-full;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: hsl(var(--primary) / 0.8);
        }

        #new-chat-input:focus {
            outline: none;
            box-shadow: none;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Estilos para o novo container de login */
        #auth-section {
            background-color: var(--color-bg);
            overflow: hidden;
            position: relative;
        }
        
        #login-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }

        .animated-input {
            border: 2px solid var(--color-border);
            background-color: var(--color-surface);
        }
        .animated-input:focus {
            background-color: var(--color-bg);
        }
        
        /* Fix para cor do texto no mobile dark mode */
        .dark #login-form input:-webkit-autofill,
        .dark #login-form input:-webkit-autofill:hover,
        .dark #login-form input:-webkit-autofill:focus,
        .dark #login-form input:-webkit-autofill:active {
            -webkit-text-fill-color: white !important;
            -webkit-box-shadow: 0 0 0 30px hsl(var(--card)) inset !important;
        }
        .dark #login-form input::placeholder {
            color: hsl(var(--muted-foreground));
        }
        .dark #auth-section input {
            color: hsl(var(--foreground));
        }

        /* Oculta a navegação mobile na tela de login */
        #auth-section:not([style*="display: none"]) ~ #new-mobile-nav,
        #auth-section:not([style*="display: none"]) ~ #mobile-profile-modal {
            display: none;
        }

        /* === Dark Mode Visual Enhancements Start === */
        .dark .dashboard-card,
        .dark .kanban-card,
        .dark #clientes-section > .rounded-xl,
        .dark #automacoes-section > .rounded-xl,
        .dark #configuracoes-section > .rounded-xl,
        .dark #desktop-agenda-wrapper > .bg-card,
        .dark #mobile-agenda-wrapper .bg-card.rounded-t-xl,
        .dark #mobile-nav-container,
        .dark #mobile-profile-modal-content,
        .dark #client-list-container .bg-card {
            border-color: transparent !important; /* Force remove border */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.15);
        }

        /* Remove separator lines inside components */
        .dark #app-sidebar,
        .dark #app-sidebar .border-b,
        .dark #app-sidebar .border-t,
        .dark #chat-list-column,
        .dark #chat-details-panel,
        .dark #clientes-section .border-b,
        .dark #agendamentos-section .border-b,
        .dark #chat-active-header,
        .dark #chat-list-container .border-b,
        .dark #client-detail-section .border-y,
        .dark #mobile-profile-modal-content .border-b {
            border-color: transparent !important;
        }

        /* Specific adjustments for Kanban cards to not have double shadows */
        .dark .kanban-card {
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.4), 0 1px 2px -1px rgb(0 0 0 / 0.4);
        }
        
        /* Ensure chat items get the correct background on hover without a border */
        .dark #chat-list-container a:hover {
            background-color: hsl(var(--muted) / 0.5);
        }

        /* Fix for conversation summary text color in dark mode */
        .dark #conversation-summary-text .prose,
        .dark #conversation-summary-text .prose strong {
            color: hsl(var(--foreground));
        }
        /* === Dark Mode Visual Enhancements End === */
        
    </style>
</head>

<body class="antialiased">

    <div id="mobile-menu-overlay" class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm hidden"></div>

    <!-- Seção de Login Aprimorada -->
    <section id="auth-section" class="min-h-screen w-full flex items-center justify-center p-4">
        
        <!-- Animação de gradiente no fundo -->
        <div class="absolute -bottom-1/2 left-1/2 w-[150%] pointer-events-none z-0 -translate-x-1/2 opacity-30 dark:opacity-50" aria-hidden="true">
            <img src="https://i.postimg.cc/Ss6yShGy/glows.png" alt="background glow" class="w-full h-auto">
        </div>
        
        <div id="login-card" class="w-[90%] md:w-[80%] lg:w-[70%] max-w-5xl flex flex-col lg:flex-row h-auto lg:h-[650px] relative z-10">
            <!-- Coluna da Esquerda (Formulário) -->
            <div id="login-form-container" class="w-full lg:w-1/2 px-4 sm:px-8 md:px-16 left h-auto lg:h-full relative overflow-hidden flex items-center justify-center flex-grow">
                <!-- Efeito de hover com gradiente -->
                <div id="gradient-blob" class="absolute pointer-events-none w-[500px] h-[500px] bg-gradient-to-r from-yellow-300/20 via-orange-300/20 to-amber-300/20 rounded-full blur-3xl transition-opacity duration-200 opacity-0"></div>
                
                <form id="login-form" class="text-center grid gap-4 h-full py-10 w-full max-w-sm">
                    <div class="grid gap-4 md:gap-6 mb-2">
                        <h1 class="text-3xl md:text-4xl font-extrabold text-[var(--color-heading)]">Bem-vindo(a)!</h1>
                        <span class="text-sm text-[var(--color-text-secondary)]">ou use sua conta para entrar</span>
                    </div>

                    <div class="grid gap-5 items-center">
                        <!-- Input animado para E-mail -->
                        <div class="w-full min-w-[200px] relative">
                             <div class="relative w-full animated-input-wrapper">
                                <input type="email" id="email-input" name="email" class="peer relative z-10 border-2 border-[var(--color-border)] h-12 w-full rounded-md bg-[var(--color-surface)] px-4 font-normal outline-none drop-shadow-sm transition-all duration-200 ease-in-out focus:bg-[var(--color-bg)] placeholder:font-medium" placeholder="E-mail" required/>
                                <div class="absolute pointer-events-none top-0 left-0 right-0 h-[2px] z-20 rounded-t-md overflow-hidden input-glow-top"></div>
                                <div class="absolute pointer-events-none bottom-0 left-0 right-0 h-[2px] z-20 rounded-b-md overflow-hidden input-glow-bottom"></div>
                            </div>
                        </div>
                        <!-- Input animado para Senha -->
                         <div class="w-full min-w-[200px] relative">
                             <div class="relative w-full animated-input-wrapper">
                                <input type="password" id="password-input" name="password" class="peer relative z-10 border-2 border-[var(--color-border)] h-12 w-full rounded-md bg-[var(--color-surface)] px-4 font-normal outline-none drop-shadow-sm transition-all duration-200 ease-in-out focus:bg-[var(--color-bg)] placeholder:font-medium" placeholder="Senha" required/>
                                <div class="absolute pointer-events-none top-0 left-0 right-0 h-[2px] z-20 rounded-t-md overflow-hidden input-glow-top"></div>
                                <div class="absolute pointer-events-none bottom-0 left-0 right-0 h-[2px] z-20 rounded-b-md overflow-hidden input-glow-bottom"></div>
                                 <button type="button" id="password-toggle" class="absolute inset-y-0 right-3 z-20 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-muted-foreground hover:text-foreground transition-colors eye-off"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-muted-foreground hover:text-foreground transition-colors eye hidden"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                     <div class="flex items-center justify-between text-sm">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="remember-me-checkbox" name="rememberMe" class="h-4 w-4 rounded border-border text-primary focus:ring-primary" />
                            <span class="text-foreground/90">Manter conectado</span>
                        </label>
                        <a href="#" class="font-light text-sm md:text-md text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">Esqueceu a senha?</a>
                     </div>
                    <div id="login-error" class="text-red-500 text-sm text-center h-5"></div>
                    <div class="flex gap-4 justify-center items-center">
                        <button type="submit" class="group/button relative inline-flex justify-center items-center overflow-hidden rounded-md bg-primary px-8 py-3 text-sm font-normal text-primary-foreground transition-all duration-300 ease-in-out hover:scale-105 hover:shadow-lg hover:shadow-primary/50 cursor-pointer">
                            <span class="text-md font-semibold">Entrar</span>
                            <div class="absolute inset-0 flex h-full w-full justify-center [transform:skew(-13deg)_translateX(-100%)] group-hover/button:duration-1000 group-hover/button:[transform:skew(-13deg)_translateX(100%)]">
                                <div class="relative h-full w-8 bg-white/20"></div>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
            <!-- Coluna da Direita (Animação) -->
            <div class="flex w-full h-[300px] lg:h-full lg:w-1/2 right overflow-hidden bg-black relative">
                <div id="neural-network-canvas-container" class="absolute inset-0 w-full h-full"></div>
                <div class="absolute inset-0 w-full h-full flex flex-col items-center justify-center p-8 gap-4 z-10 bg-black/30">
                     <a class="flex flex-col items-center gap-2 font-semibold text-white text-center" href="#">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="hsl(var(--primary))" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12 shrink-0">
                            <path d="M12.4 2.7c.9-1.4 2.3-1.4 3.2 0l6.4 10.5c.9 1.4.2 3.3-1.6 3.3H3.6c-1.8 0-2.5-1.9-1.6-3.3l6.4-10.5Z"></path>
                        </svg>
                        <div>
                            <span class="text-5xl font-bold tracking-wider">Elegance</span>
                            <p class="text-base text-muted-foreground tracking-widest">Marketing Médico em Inovação</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- App Principal (Inalterado) -->
    <div id="app" class="h-screen w-full flex hidden">
        <!-- Sidebar -->
        <aside id="app-sidebar" class="w-64 lg:w-20 border-r bg-card flex-col fixed inset-y-0 z-50 h-full hidden md:flex transition-all duration-300 ease-in-out overflow-hidden">
            <div class="flex flex-col h-full">
                <!-- Top Part: Logo & Nav -->
                <div class="flex-1 flex flex-col overflow-y-auto overflow-x-hidden">
                    <div class="flex h-16 items-center px-6 shrink-0 border-b">
                        <a class="flex items-center gap-2 font-semibold text-foreground" href="#dashboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-primary shrink-0">
                                <path d="M12.4 2.7c.9-1.4 2.3-1.4 3.2 0l6.4 10.5c.9 1.4.2 3.3-1.6 3.3H3.6c-1.8 0-2.5-1.9-1.6-3.3l6.4-10.5Z" />
                            </svg>
                            <span class="nav-text font-semibold whitespace-pre hidden">CRM Elegance</span>
                        </a>
                    </div>
                    <nav id="nav-links" class="flex-1 px-4 py-4 space-y-2">
                        <a href="#dashboard" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0">
                                <rect width="7" height="9" x="3" y="3" rx="1" />
                                <rect width="7" height="5" x="14" y="3" rx="1" />
                                <rect width="7" height="9" x="14" y="12" rx="1" />
                                <rect width="7" height="5" x="3" y="16" rx="1" />
                            </svg>
                            <span class="nav-text whitespace-pre hidden">Dashboard</span>
                        </a>
                        <a href="#funil" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            <span class="nav-text whitespace-pre hidden">Funil</span>
                        </a>
                        <a href="#conversas" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0">
                                <path d="M17 6.1H3" />
                                <path d="M21 12.1H3" />
                                <path d="M15.1 18H3" />
                            </svg>
                            <span class="nav-text whitespace-pre hidden">Conversas</span>
                        </a>
                        <a href="#agendamentos" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0">
                                <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                                <line x1="16" x2="16" y1="2" y2="6" />
                                <line x1="8" x2="8" y1="2" y2="6" />
                                <line x1="3" x2="21" y1="10" y2="10" />
                            </svg>
                            <span class="nav-text whitespace-pre hidden">Agendamentos</span>
                        </a>
                        <a href="#clientes" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                            <span class="nav-text whitespace-pre hidden">Clientes</span>
                        </a>
                        <a href="#automacoes" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0">
                                <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" />
                                <path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" />
                                <path d="M12 2v2" />
                                <path d="M12 22v-2" />
                                <path d="m17 20.66-1-1.73" />
                                <path d="M11 10.27 7 3.34" />
                                <path d="m20.66 17-1.73-1" />
                                <path d="m3.34 7 1.73 1" />
                                <path d="M14 12h8" />
                                <path d="M2 12h2" />
                                <path d="m20.66 7-1.73 1" />
                                <path d="m3.34 17 1.73-1" />
                                <path d="m17 3.34-1 1.73" />
                                <path d="m11 13.73-4 6.93" />
                            </svg>
                            <span class="nav-text whitespace-pre hidden">Automações</span>
                        </a>
                    </nav>
                </div>
                <!-- Bottom Part: Profile & Settings -->
                <div class="p-4 border-t">
                    <nav class="space-y-2">
                        <a href="#configuracoes" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0">
                                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                            <span class="nav-text whitespace-pre hidden">Configurações</span>
                        </a>
                        <a id="logout-link" href="#" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-destructive/10 hover:text-destructive">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                                <polyline points="16 17 21 12 16 7" />
                                <line x1="21" x2="9" y1="12" y2="12" />
                            </svg>
                            <span class="nav-text whitespace-pre hidden">Sair</span>
                        </a>
                    </nav>
                    <div class="mt-4 pt-4 border-t">
                        <a href="#configuracoes" id="user-profile-link-wrapper" class="flex items-center gap-3 rounded-lg p-2 -ml-2 hover:bg-muted">
                            <img id="user-avatar-header" alt="Avatar" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border shrink-0" />
                            <div class="text-sm text-left overflow-hidden">
                                <p class="nav-text font-semibold whitespace-pre hidden" id="user-name-header">Admin</p>
                                <p class="nav-text text-muted-foreground text-xs whitespace-pre hidden" id="user-role-header">Admin</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div id="main-content-wrapper" class="flex flex-col flex-1 md:pl-20 transition-all duration-300 ease-in-out">
            <main id="main-content" class="relative flex-1 bg-background overflow-y-auto pb-16 md:pb-0">
                <div class="absolute top-6 right-6 z-50 flex items-center gap-4">
                    <div id="theme-toggle-container"></div>
                    <button id="mobile-menu-button" class="hidden p-2 rounded-md hover:bg-muted text-foreground">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
                            <line x1="4" x2="20" y1="6" y2="6" />
                            <line x1="4" x2="20" y1="12" y2="12" />
                            <line x1="4" x2="20" y1="18" y2="18" />
                        </svg>
                    </button>
                </div>

                <!-- Seção Dashboard -->
                <section id="dashboard-section" class="page-section hidden p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Dashboard</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <!-- Stats -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                                <div class="dashboard-card flex flex-col gap-2 rounded-xl p-6 bg-card">
                                    <p class="text-muted-foreground text-base font-medium">Faturamento Mensal</p>
                                    <p id="faturamento-mensal-stat" class="text-foreground tracking-light text-2xl font-bold">R$ 0k</p>
                                    <p class="text-green-500 text-base font-medium">+0%</p>
                                </div>
                                <div class="dashboard-card flex flex-col gap-2 rounded-xl p-6 bg-card">
                                    <p class="text-muted-foreground text-base font-medium">Novos Pacientes</p>
                                    <p id="novos-pacientes-stat" class="text-foreground tracking-light text-2xl font-bold">0</p>
                                    <p class="text-green-500 text-base font-medium">+0</p>
                                </div>
                                <div class="dashboard-card flex flex-col gap-2 rounded-xl p-6 bg-card">
                                    <p class="text-muted-foreground text-base font-medium">Agendamentos Hoje</p>
                                    <p id="consultas-para-hoje-stat" class="text-foreground tracking-light text-2xl font-bold">0</p>
                                    <p class="text-red-500 text-base font-medium">--</p>
                                </div>
                                <div class="dashboard-card flex flex-col gap-2 rounded-xl p-6 bg-card">
                                    <p class="text-muted-foreground text-base font-medium">Taxa de Conversão</p>
                                    <p id="taxa-conversao-stat" class="text-foreground tracking-light text-2xl font-bold">0%</p>
                                    <p class="text-green-500 text-base font-medium">+0%</p>
                                </div>
                            </div>
                            <!-- Charts -->
                            <div class="dashboard-card bg-card rounded-xl p-6">
                                <div class="flex flex-col gap-2">
                                    <p class="text-foreground text-base font-medium">Visão Geral de Vendas</p>
                                    <p id="vendas-geral-stat" class="text-foreground tracking-light text-[32px] font-bold leading-tight truncate">R$ 0k</p>
                                    <div class="flex gap-1">
                                        <p class="text-muted-foreground text-base font-normal">Anual</p>
                                        <p class="text-green-500 text-base font-medium">+0%</p>
                                    </div>
                                    <div class="h-[220px] pt-4">
                                        <canvas id="consultasChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="dashboard-card bg-card rounded-xl p-6">
                                    <p class="text-foreground text-base font-medium">Origem dos Clientes</p>
                                    <div class="flex items-center justify-center min-h-[180px] py-4">
                                        <div class="relative w-48 h-48">
                                            <canvas id="conversionChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div id="servicos-procurados-container" class="dashboard-card bg-card rounded-xl p-6">
                                    <p class="text-foreground text-base font-medium leading-normal mb-4">Serviços Mais Procurados</p>
                                    <!-- Progress bars will be rendered here by JS -->
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-1 space-y-8">
                            <div class="dashboard-card bg-card rounded-xl p-6">
                                <h3 class="text-foreground text-base font-medium mb-4">Próximos Agendamentos</h3>
                                <div id="recent-appointments-list" class="space-y-4">
                                    <!-- Appointments will be rendered here by JS -->
                                </div>
                            </div>
                            <div class="dashboard-card bg-card rounded-xl p-6">
                                <h3 class="text-foreground text-base font-medium mb-4">Atividades Recentes</h3>
                                <div id="recent-activities-list" class="space-y-4">
                                    <!-- Atividades serão inseridas aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Funil -->
                <section id="funil-section" class="page-section hidden h-full flex flex-col p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Funil de Vendas</h1>
                    <div id="kanban-board-container" class="flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Columns will be injected by JS -->
                    </div>
                </section>

                <!-- Seção Conversas -->
                <section id="conversas-section" class="page-section hidden h-full">
                    <!-- Desktop View -->
                    <div class="relative overflow-hidden hidden md:flex h-full w-full">
                        <aside id="chat-list-column" class="w-full md:w-[360px] bg-card flex flex-col border-r">
                            <div class="p-4">
                                <h1 class="text-2xl font-bold text-foreground mb-4 pt-12 md:pt-0">Conversas</h1>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">search</span>
                                    <input id="chat-search-input" class="w-full bg-muted border-none rounded-lg h-12 pl-10 pr-4 text-foreground placeholder:text-muted-foreground focus:ring-2 focus:ring-primary" placeholder="Pesquisar por cliente..." type="text" />
                                </div>
                            </div>
                            <nav class="flex-1 overflow-y-auto">
                                <ul id="chat-list-container">
                                    <!-- Chat items will be injected here -->
                                </ul>
                            </nav>
                        </aside>
                        <main id="chat-view-column" class="flex-1 bg-background flex-col hidden md:flex">
                            <div id="new-chat-placeholder" class="flex flex-1 items-center justify-center text-center">
                                <div class="p-8 rounded-lg flex flex-col items-center text-muted-foreground">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-16 w-16 opacity-50">
                                        <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z" />
                                    </svg>
                                    <p class="mt-4 text-lg">Selecione uma conversa para começar</p>
                                </div>
                            </div>
                            <div id="new-chat-view" class="hidden h-full flex-col">
                                <header id="chat-active-header" class="flex items-center p-4 gap-4 bg-card shadow-sm">
                                    <!-- Active chat header rendered by JS -->
                                </header>
                                <div id="new-chat-messages" class="flex-1 p-6 overflow-y-auto space-y-6">
                                    <!-- Messages will be injected here -->
                                </div>
                                <footer class="p-4 bg-card">
                                    <div class="flex items-center gap-4 bg-muted/50 rounded-xl p-2">
                                        <button class="text-muted-foreground hover:text-primary transition-colors p-2">
                                            <span class="material-symbols-outlined">add_circle</span>
                                        </button>
                                        <input id="new-chat-input" class="flex-1 bg-transparent border-none text-foreground placeholder:text-muted-foreground focus:ring-0" placeholder="Digite sua mensagem..." type="text" />
                                        <button id="new-send-button" class="p-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                            <span class="material-symbols-outlined">send</span>
                                        </button>
                                    </div>
                                </footer>
                            </div>
                        </main>
                        <aside id="chat-details-panel" class="w-[380px] bg-card flex-col border-l p-6 space-y-8 overflow-y-auto hidden lg:flex">
                            <!-- Details rendered by JS -->
                        </aside>
                    </div>
                     <!-- Mobile View -->
                    <div id="mobile-conversas-wrapper" class="md:hidden relative h-full w-full overflow-hidden bg-card">
                        <!-- Mobile Chat List and Chat View will be rendered here by JS -->
                    </div>
                </section>

                <!-- Seção Agendamentos -->
                <section id="agendamentos-section" class="page-section hidden flex flex-col h-full p-0 md:p-6 lg:p-8 md:flex-row md:gap-6">
                    <!-- Desktop View -->
                    <div id="desktop-agenda-wrapper" class="hidden md:flex md:flex-row md:gap-6 w-full h-full">
                         <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0 md:absolute">Agendamentos</h1>
                         <div class="flex md:w-auto bg-card p-4 rounded-2xl border flex-shrink-0 h-fit mt-16">
                            <div id="full-calendar-container"></div>
                        </div>
                        <div class="flex-grow bg-card rounded-2xl border p-4 flex flex-col mt-16 md:mt-16">
                            <div class="flex flex-wrap justify-between items-center border-b pb-4 mb-4 gap-4">
                                <div class="flex items-center gap-2">
                                    <button id="today-btn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3">Hoje</button>
                                    <div class="flex items-center gap-1">
                                        <button id="prev-week-btn" class="p-2 rounded-md hover:bg-muted text-muted-foreground"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                                <path d="m15 18-6-6 6-6" />
                                            </svg></button>
                                        <button id="next-week-btn" class="p-2 rounded-md hover:bg-muted text-muted-foreground"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                                <path d="m9 18 6-6-6-6" />
                                            </svg></button>
                                    </div>
                                    <h3 id="weekly-view-date-range" class="text-lg font-semibold whitespace-nowrap text-foreground">
                                    </h3>
                                </div>
                                <div id="view-toggle-buttons" class="flex items-center gap-1 bg-muted p-1 rounded-lg text-sm">
                                    <button class="view-toggle-btn px-3 py-1 rounded-md" data-view="weekly">Semanal</button>
                                    <button class="view-toggle-btn px-3 py-1 rounded-md" data-view="daily">Diário</button>
                                </div>
                            </div>
                            <div id="agenda-views-container" class="flex-grow h-full relative overflow-auto">
                                <div id="weekly-view" class="h-full flex flex-col">
                                    <div id="weekly-header" class="grid grid-cols-7 flex-shrink-0"></div>
                                    <div id="weekly-body" class="flex-grow overflow-y-auto relative h-full"></div>
                                </div>
                                <div id="daily-view" class="h-full hidden flex flex-col">
                                    <div id="daily-body" class="flex-grow overflow-y-auto relative h-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Mobile View -->
                    <div id="mobile-agenda-wrapper" class="md:hidden flex flex-col h-full w-full bg-background">
                        <!-- New mobile HTML will be rendered here by JS -->
                    </div>
                </section>

                <!-- Seção Detalhes do Cliente -->
                <section id="client-detail-section" class="page-section hidden p-4 md:p-6 lg:p-8"></section>

                <!-- Seção Detalhes do Agendamento -->
                <section id="appointment-detail-section" class="page-section hidden p-4 md:p-6 lg:p-8"></section>

                <!-- Seção Clientes -->
                <section id="clientes-section" class="page-section hidden p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Clientes</h1>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-4 border-b flex items-center justify-between">
                            <div class="relative w-full max-w-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground">
                                    <circle cx="11" cy="11" r="8" />
                                    <path d="m21 21-4.3-4.3" />
                                </svg>
                                <input id="client-search-input" placeholder="Filtrar clientes..." class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pl-10">
                            </div>
                            <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 opacity-50 cursor-not-allowed">Adicionar
                                Cliente</button>
                        </div>
                        <div class="p-4 md:hidden" id="client-list-container">
                            <!-- Client cards for mobile will be injected here -->
                        </div>
                        <div class="p-4 hidden md:block">
                            <div class="relative w-full overflow-auto">
                                <table class="w-full caption-bottom text-sm">
                                    <thead class="[&_tr]:border-b">
                                        <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                                            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 w-[40%]">
                                                Nome</th>
                                            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 w-[30%]">
                                                Telefone</th>
                                            <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 w-[30%]">
                                                Data de Cadastro</th>
                                        </tr>
                                    </thead>
                                    <tbody id="client-table-body" class="[&_tr:last-child]:border-0">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Automações -->
                <section id="automacoes-section" class="page-section hidden max-w-4xl mx-auto space-y-8 p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Automações</h1>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-foreground">Envio de Mensagens em Massa</h3>
                            <p class="text-sm text-muted-foreground">Envie mensagens para múltiplos clientes de uma
                                só vez. (Em breve)</p>
                        </div>
                        <div class="p-6 pt-0 space-y-4">
                            <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" disabled>Enviar para X clientes</button>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-foreground">Chatbot / Secretária Virtual</h3>
                            <p class="text-sm text-muted-foreground">Configure respostas automáticas. (Em breve)
                            </p>
                        </div>
                        <div class="p-6 pt-0 space-y-4">
                            <div class="flex items-center justify-between p-4 bg-muted/50 rounded-lg">
                                <label for="chatbot-toggle" class="font-medium text-sm">Ativar Respostas
                                    Automáticas</label>
                                <button type="button" id="chatbot-toggle" role="switch" class="peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input" disabled><span class="pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"></span></button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Configurações/Perfil -->
                <section id="configuracoes-section" class="page-section hidden max-w-2xl mx-auto space-y-8 p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Configurações</h1>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-foreground">Informações da Clínica</h3>
                        </div>
                        <div class="p-6 pt-0 space-y-4">
                            <div><label class="block mb-2 text-sm font-medium">Nome</label><input type="text" value="Elegance" disabled class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                            <div><label class="block mb-2 text-sm font-medium">E-mail de Contato</label><input type="email" value="contato@elegance.com" disabled class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-foreground">Segurança</h3>
                        </div>
                        <form id="password-change-form" class="p-6 pt-0 space-y-4">
                            <div><label for="current-password" class="block mb-2 text-sm font-medium">Senha
                                    Atual</label><input type="password" id="current-password" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                            <div><label for="new-password" class="block mb-2 text-sm font-medium">Nova
                                    Senha</label><input type="password" id="new-password" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                            <div><label for="confirm-password" class="block mb-2 text-sm font-medium">Confirmar
                                    Nova Senha</label><input type="password" id="confirm-password" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                            <div id="password-change-message" class="text-sm h-5"></div>
                            <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Salvar
                                Alterações</button>
                        </form>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Bottom Nav for Mobile -->
    <nav id="new-mobile-nav" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-[calc(100%-2rem)] sm:max-w-sm px-2 md:hidden">
        <div id="mobile-nav-container" class="relative flex items-center justify-around bg-card shadow-xl rounded-full p-1 border border-border/80">
            <div id="mobile-nav-indicator" class="absolute top-1 bottom-1 rounded-full bg-primary/20" style="transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);"></div>
            <a href="#dashboard" class="mobile-nav-item z-10 flex-1 flex items-center justify-center p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </a>
            <a href="#clientes" class="mobile-nav-item z-10 flex-1 flex items-center justify-center p-2 rounded-full">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </a>
            <a href="#agendamentos" class="mobile-nav-item z-10 flex-1 flex items-center justify-center p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
            </a>
            <a href="#conversas" class="mobile-nav-item z-10 flex-1 flex items-center justify-center p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
            </a>
            <button id="mobile-profile-trigger" class="mobile-nav-item z-10 flex-1 flex items-center justify-center p-2 rounded-full text-muted-foreground">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </button>
        </div>
    </nav>

    <!-- Modal de Perfil Mobile -->
    <div id="mobile-profile-modal" class="fixed inset-0 z-[60] bg-black/60 hidden justify-center items-end" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div id="mobile-profile-modal-content" class="bg-card w-full max-w-md mx-auto mb-20 rounded-2xl p-4 space-y-4 transition-transform duration-300 translate-y-full shadow-2xl border">
            <div class="flex items-center gap-3 border-b pb-3">
                <img id="user-avatar-modal" alt="Avatar" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12 border">
                <div>
                    <p id="user-name-modal" class="font-semibold text-foreground"></p>
                    <p id="user-role-modal" class="text-muted-foreground text-sm"></p>
                </div>
            </div>
            <nav class="space-y-1">
                <a href="#configuracoes" id="modal-settings-link" class="flex items-center gap-3 rounded-lg p-3 text-foreground transition-all hover:bg-muted">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    <span>Configurações</span>
                </a>
                <a href="#" id="modal-logout-link" class="flex items-center gap-3 rounded-lg p-3 text-destructive transition-all hover:bg-destructive/10">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    <span>Sair</span>
                </a>
            </nav>
            <button id="mobile-profile-modal-close" class="mt-2 w-full inline-flex items-center justify-center rounded-lg text-sm font-medium bg-muted text-muted-foreground h-10 px-4 py-2">Fechar</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // -----------------------------------------------------------------------------
            // 1. CONSTANTES E INICIALIZAÇÃO
            // -----------------------------------------------------------------------------

            const SUPABASE_URL = "https://zfblhljtfqnopwlffffq.supabase.co";
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmYmxobGp0ZnFub3B3bGZmZmZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjgxNDgsImV4cCI6MjA3MzA0NDE0OH0.m76j7L_49X_8tV0myINjEQIzizOUAa7SLCO1li3MKdg";
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let currentClinicId = null;
            let allAppointments = [];
            let allClients = [];
            let currentChats = [];
            let currentChat = null;
            let currentDate = new Date();
            let currentCalendarView = 'weekly';
            let consultasChartInstance, conversionChartInstance;
            let clientListSubscription = null;
            let neuralNetworkAnimationScene = null;
            let isThemeTransitioning = false;


            const appDiv = document.getElementById('app');
            const authSection = document.getElementById('auth-section');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const passwordToggle = document.getElementById('password-toggle');
            const pageSections = document.querySelectorAll('.page-section');
            const navLinks = document.getElementById('nav-links');
            const clientTableBody = document.getElementById('client-table-body');
            const clientListContainer = document.getElementById('client-list-container');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const appSidebar = document.getElementById('app-sidebar');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const themeToggleContainer = document.getElementById('theme-toggle-container');

            // -----------------------------------------------------------------------------
            // 2. LÓGICA DE UI E TEMA
            // -----------------------------------------------------------------------------

            const renderThemeToggle = () => {
                themeToggleContainer.innerHTML = `
                    <button id="theme-toggle" type="button" aria-label="Switch theme" class="relative flex items-center justify-center p-2 rounded-full outline-none focus:outline-none active:outline-none focus:ring-0 cursor-pointer w-9 h-9 overflow-hidden bg-muted">
                        <span class="sun-icon hidden text-foreground transition-all duration-300">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                        </span>
                        <span class="moon-icon hidden text-foreground transition-all duration-300">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                        </span>
                    </button>
                `;
                document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
                applyInitialTheme();
            };

            const toggleTheme = async () => {
                const buttonRef = document.getElementById('theme-toggle');
                if (!buttonRef || isThemeTransitioning) return;

                if (!document.startViewTransition) {
                    const isDark = document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'light' : 'dark');
                    syncThemeUI(!isDark);
                    return;
                }

                isThemeTransitioning = true;
                const isDark = document.documentElement.classList.contains('dark');
                const { left, top, width, height } = buttonRef.getBoundingClientRect();
                const centerX = left + width / 2;
                const centerY = top + height / 2;
                const maxDistance = Math.hypot(
                    Math.max(centerX, window.innerWidth - centerX),
                    Math.max(centerY, window.innerHeight - centerY)
                );

                const transition = document.startViewTransition(() => {
                    syncThemeUI(!isDark, true); // Update class, skip icon animation
                });

                await transition.ready;
                
                document.documentElement.animate({
                    clipPath: [
                        `circle(0px at ${centerX}px ${centerY}px)`,
                        `circle(${maxDistance}px at ${centerX}px ${centerY}px)`,
                    ],
                }, {
                    duration: 500,
                    easing: 'ease-in-out',
                    pseudoElement: '::view-transition-new(root)',
                });

                transition.finished.then(() => {
                    localStorage.setItem('theme', !isDark ? 'dark' : 'light');
                    animateThemeIcon(!isDark);
                    isThemeTransitioning = false;
                });
            };

            const animateThemeIcon = (isDark) => {
                 const buttonRef = document.getElementById('theme-toggle');
                 if(!buttonRef) return;
                 const sunIcon = buttonRef.querySelector('.sun-icon');
                 const moonIcon = buttonRef.querySelector('.moon-icon');
                 const iconToShow = isDark ? sunIcon : moonIcon;
                 const iconToHide = isDark ? moonIcon : sunIcon;
                 
                 gsap.to(iconToHide, { opacity: 0, scale: 0.5, rotate: isDark ? 25 : -25, duration: 0.2, onComplete: () => {
                    iconToHide.classList.add('hidden');
                    iconToShow.classList.remove('hidden');
                    gsap.fromTo(iconToShow, { opacity: 0, scale: 0.5, rotate: isDark ? -25 : 25 }, { opacity: 1, scale: 1, rotate: 0, duration: 0.3 });
                }});
            }

            const syncThemeUI = (isDark, skipAnimation = false) => {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.classList.remove('light');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                }
                if (!skipAnimation) {
                     const buttonRef = document.getElementById('theme-toggle');
                     if(!buttonRef) return;
                     const sunIcon = buttonRef.querySelector('.sun-icon');
                     const moonIcon = buttonRef.querySelector('.moon-icon');
                     if(isDark) {
                         moonIcon.classList.add('hidden');
                         sunIcon.classList.remove('hidden');
                         gsap.fromTo(sunIcon, { opacity: 0, scale: 0.5, rotate: -25 }, { opacity: 1, scale: 1, rotate: 0, duration: 0.3 });
                     } else {
                         sunIcon.classList.add('hidden');
                         moonIcon.classList.remove('hidden');
                         gsap.fromTo(moonIcon, { opacity: 0, scale: 0.5, rotate: 25 }, { opacity: 1, scale: 1, rotate: 0, duration: 0.3 });
                     }
                }
                updateChartTheme();
            };
            
            const applyInitialTheme = () => {
                const session = localStorage.getItem('clinicSession') || sessionStorage.getItem('clinicSession');
                const savedTheme = session ? (localStorage.getItem('theme') || 'light') : 'dark';
                syncThemeUI(savedTheme === 'dark');
            };

            // -----------------------------------------------------------------------------
            // 3. LÓGICA PRINCIPAL DA APLICAÇÃO (AUTENTICAÇÃO E NAVEGAÇÃO)
            // -----------------------------------------------------------------------------

            const showApp = async (clinicData, rememberMe) => {
                const performTransition = () => {
                    localStorage.setItem('theme', 'light');
                    syncThemeUI(false, true);

                    currentClinicId = clinicData.clinic_id;
                    const storage = rememberMe ? localStorage : sessionStorage;
                    storage.setItem('clinicSession', JSON.stringify(clinicData));

                    if (neuralNetworkAnimationScene && neuralNetworkAnimationScene.animationId) {
                        cancelAnimationFrame(neuralNetworkAnimationScene.animationId);
                    }

                    authSection.style.display = 'none';
                    appDiv.classList.remove('hidden');
                    appDiv.style.display = 'flex';

                    const userName = clinicData.email.split('@')[0];
                    const userInitials = getInitials(userName);
                    document.getElementById('user-name-header').textContent = userName;
                    document.getElementById('user-avatar-header').src = `https://placehold.co/40x40/f59e0b/000000?text=${userInitials}`;

                    showSection(window.location.hash || '#dashboard');
                };

                if (!document.startViewTransition) {
                    performTransition();
                    syncThemeUI(false); 
                    return;
                }

                isThemeTransitioning = true;
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const maxDistance = Math.hypot(
                    Math.max(centerX, window.innerWidth - centerX),
                    Math.max(centerY, window.innerHeight - centerY)
                );

                const transition = document.startViewTransition(performTransition);

                await transition.ready;

                document.documentElement.animate({
                    clipPath: [
                        `circle(0px at ${centerX}px ${centerY}px)`,
                        `circle(${maxDistance}px at ${centerX}px ${centerY}px)`,
                    ],
                }, {
                    duration: 600,
                    easing: 'ease-in-out',
                    pseudoElement: '::view-transition-new(root)',
                });

                transition.finished.then(() => {
                    isThemeTransitioning = false;
                    syncThemeUI(false); 
                });
              };

             const showLogin = () => {
                localStorage.setItem('theme', 'dark');
                syncThemeUI(true);

                 currentClinicId = null;
                sessionStorage.removeItem('clinicSession');
                localStorage.removeItem('clinicSession');
                unsubscribeFromChannels();

                authSection.style.display = 'flex';
                appDiv.classList.add('hidden');
                appDiv.style.display = 'none';
                initNeuralNetworkAnimation();
                };

            const handleLogin = async (event) => {
                event.preventDefault();
                loginError.textContent = '';
                const email = document.getElementById('email-input').value.trim();
                const password = document.getElementById('password-input').value;
                const rememberMe = document.getElementById('remember-me-checkbox').checked;

                const {
                    data,
                    error
                } = await supabase.from('usuarios_site').select('email, senha, clinic_id').eq('email', email).limit(1);

                if (error || !data || data.length === 0) {
                    loginError.textContent = 'E-mail ou senha inválidos.';
                    return;
                }

                const user = data[0];
                if (user.senha === password) {
                    showApp(user, rememberMe);
                } else {
                    loginError.textContent = 'E-mail ou senha inválidos.';
                }
            };

            const checkSession = () => {
                let session = localStorage.getItem('clinicSession') || sessionStorage.getItem('clinicSession');
                if (session) {
                    // Call a simplified version of showApp without animation for session resume
                    const clinicData = JSON.parse(session);
                    const rememberMe = !!localStorage.getItem('clinicSession');
                    
                    localStorage.setItem('theme', localStorage.getItem('theme') || 'light');
                    applyInitialTheme();

                    currentClinicId = clinicData.clinic_id;
                    const storage = rememberMe ? localStorage : sessionStorage;
                    storage.setItem('clinicSession', JSON.stringify(clinicData));

                    authSection.style.display = 'none';
                    appDiv.classList.remove('hidden');
                    appDiv.style.display = 'flex';

                    const userName = clinicData.email.split('@')[0];
                    const userInitials = getInitials(userName);
                    document.getElementById('user-name-header').textContent = userName;
                    document.getElementById('user-avatar-header').src = `https://placehold.co/40x40/f59e0b/000000?text=${userInitials}`;

                    showSection(window.location.hash || '#dashboard');
                } else {
                    showLogin();
                }
            };

            const showSection = async (hash) => {
                unsubscribeFromChannels();
                const currentHash = hash || '#dashboard';
                let baseHash = currentHash.split('-')[0];
                if (baseHash === '#appointment' || baseHash === '#client') {
                    baseHash += '-detail';
                }

                const sectionId = `${baseHash.substring(1)}-section`;
                const section = document.getElementById(sectionId) || document.getElementById('dashboard-section');

                pageSections.forEach(s => s.classList.add('hidden'));
                if (section) {
                    section.classList.remove('hidden');
                    gsap.fromTo(section, {
                        opacity: 0,
                        y: 10
                    }, {
                        opacity: 1,
                        y: 0,
                        duration: 0.3
                    });
                } else {
                    document.getElementById('dashboard-section').classList.remove('hidden');
                }

                appSidebar.querySelectorAll('a.nav-link').forEach(a => a.classList.remove('active'));
                
                const navHash = currentHash.split('-')[0];
                const activeLink = appSidebar.querySelector(`a[href="${navHash}"]`);
                if (activeLink) activeLink.classList.add('active');

                // Update mobile nav as well
                updateFloatingNavIndicator();


                if (!currentClinicId) return;

                const sectionBaseName = baseHash.split('-')[0];

                switch (sectionBaseName) {
                    case '#dashboard':
                        await fetchDashboardData();
                        break;
                    case '#clientes':
                        await fetchClients();
                        break;
                    case '#funil':
                        initializeKanban();
                        break;
                    case '#conversas':
                        await fetchChats();
                        break;
                    case '#agendamentos':
                        await fetchAndRenderAgenda();
                        break;
                    case '#client':
                        const clientId = currentHash.split('-detail-')[1];
                        if (!allClients || allClients.length === 0) await fetchClients(); // Fetch if not available
                        const client = allClients.find(c => (c.telefone || c.telefone_cliente || '').replace(/\D/g, '') === clientId);
                        if (client) await renderClientDetailsPage(client, '#conversas'); // Default back to conversas
                        break;
                    case '#appointment':
                        const appointmentId = currentHash.split('-detail-')[1];
                        if (!allAppointments || allAppointments.length === 0) await fetchAndRenderAgenda(); // Fetch if not available
                        const appointment = allAppointments.find(a => a.id == appointmentId);
                        if (appointment) await renderAppointmentDetailsPage(appointment, '#agendamentos');
                        break;
                }
            };

            function unsubscribeFromChannels() {
                if (clientListSubscription) {
                    supabase.removeChannel(clientListSubscription);
                    clientListSubscription = null;
                }
            }


            // -----------------------------------------------------------------------------
            // 4. FUNCIONALIDADE: DASHBOARD
            // -----------------------------------------------------------------------------

            async function fetchDashboardData(period = 'all') {
                if (!currentClinicId) return;

                try {
                    const todayStart = new Date();
                    todayStart.setHours(0, 0, 0, 0);
                    const todayEnd = new Date();
                    todayEnd.setHours(23, 59, 59, 999);

                    let startDate = new Date();
                    if (period === '7') {
                        startDate.setDate(startDate.getDate() - 7);
                    } else if (period === '30') {
                        startDate.setDate(startDate.getDate() - 30);
                    } else {
                        startDate = new Date(0); // 'all'
                    }

                    const [{
                        count: totalContacts
                    }, {
                        data: appointmentsData
                    }, {
                        count: consultasParaHoje
                    }, {
                        data: recentAppointmentsData
                    }, {
                        data: revenueData
                    }, {
                        count: newPatientsCount
                    }, {
                        data: clientOriginsData
                    }, {
                        data: servicesData
                    }] = await Promise.all([
                        supabase.from('dados_cliente').select('*', {
                            count: 'exact',
                            head: true
                        }).eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('consultas').select('telefone_cliente, status').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('consultas').select('*', {
                            count: 'exact',
                            head: true
                        }).eq('clinic_id', currentClinicId).gte('data_inicio', todayStart.toISOString()).lte('data_inicio', todayEnd.toISOString()),
                        supabase.from('consultas').select('nome_cliente, data_inicio').eq('clinic_id', currentClinicId).order('data_inicio', {
                            ascending: true
                        }).gte('data_inicio', new Date().toISOString()).limit(3),
                        supabase.from('consultas').select('valor').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('dados_cliente').select('*', {
                            count: 'exact',
                            head: true
                        }).eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('dados_cliente').select('origem').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('consultas').select('tipo_consulta').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString())
                    ]);

                    const convertedCount = appointmentsData ? new Set(appointmentsData.map(c => c.telefone_cliente)).size : 0;
                    const taxaConversao = totalContacts > 0 ? ((convertedCount / totalContacts) * 100).toFixed(0) : 0;

                    const faturamentoTotal = revenueData ? revenueData.reduce((acc, curr) => acc + (curr.valor || 150), 0) : 0;
                    document.getElementById('faturamento-mensal-stat').textContent = `R$ ${(faturamentoTotal / 1000).toFixed(1)}k`;
                    document.getElementById('vendas-geral-stat').textContent = `R$ ${(faturamentoTotal / 1000).toFixed(1)}k`;
                    document.getElementById('novos-pacientes-stat').textContent = newPatientsCount || 0;
                    document.getElementById('consultas-para-hoje-stat').textContent = consultasParaHoje || 0;
                    document.getElementById('taxa-conversao-stat').textContent = `${taxaConversao}%`;

                    const recentAppointmentsList = document.getElementById('recent-appointments-list');
                    recentAppointmentsList.innerHTML = '';
                    if (recentAppointmentsData && recentAppointmentsData.length > 0) {
                        recentAppointmentsData.forEach(apt => {
                            const item = document.createElement('div');
                            item.className = 'flex items-center gap-4';
                            const aptDate = new Date(apt.data_inicio);
                            const isToday = aptDate.toDateString() === new Date().toDateString();
                            item.innerHTML = `
                                <div class="${isToday ? 'bg-primary/20 text-primary' : 'bg-muted text-muted-foreground'} p-3 rounded-lg flex flex-col items-center justify-center w-14">
                                    <span class="font-bold">${aptDate.getDate()}</span>
                                    <span class="text-xs">${aptDate.toLocaleDateString('pt-BR', { month: 'short' }).toUpperCase().replace('.', '')}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-foreground">${htmlEncode(apt.nome_cliente)}</p>
                                    <p class="text-sm text-muted-foreground">${formatTimestamp(apt.data_inicio)}</p>
                                </div>`;
                            recentAppointmentsList.appendChild(item);
                        });
                    } else {
                        recentAppointmentsList.innerHTML = '<p class="text-sm text-muted-foreground">Nenhum agendamento próximo.</p>';
                    }

                    const monthlyConsultasData = await getChartDataForPeriod(period);
                    const monthLabels = getChartLabelsForPeriod(period);

                    if (consultasChartInstance) {
                        consultasChartInstance.data.labels = monthLabels;
                        consultasChartInstance.data.datasets[0].data = monthlyConsultasData;
                        consultasChartInstance.update();
                    }

                    const originCounts = (clientOriginsData || []).reduce((acc, client) => {
                        const origin = client.origem || 'Outros';
                        acc[origin] = (acc[origin] || 0) + 1;
                        return acc;
                    }, {
                        'Instagram': 0,
                        'Facebook': 0,
                        'Indicação': 0,
                        'Outros': 0
                    });

                    if (conversionChartInstance) {
                        conversionChartInstance.data.labels = Object.keys(originCounts);
                        conversionChartInstance.data.datasets[0].data = Object.values(originCounts);
                        conversionChartInstance.update();
                    }

                    const serviceCounts = (servicesData || []).reduce((acc, apt) => {
                        const service = apt.tipo_consulta || 'Não especificado';
                        acc[service] = (acc[service] || 0) + 1;
                        return acc;
                    }, {});
                    renderServicosMaisProcurados(serviceCounts, servicesData.length);
                    fetchAndRenderRecentActivities();

                } catch (error) {
                    console.error("Erro ao carregar dados do dashboard:", error);
                }
            }

            function renderServicosMaisProcurados(serviceCounts, total) {
                const container = document.getElementById('servicos-procurados-container');
                if (!container) return;

                const title = container.querySelector('p');
                container.innerHTML = '';
                if (title) container.appendChild(title);

                const sortedServices = Object.entries(serviceCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 4);

                const progressContainer = document.createElement('div');
                progressContainer.className = 'grid min-h-[180px] gap-y-4 items-center py-3';

                if (sortedServices.length > 0) {
                    sortedServices.forEach(([name, count]) => {
                        const percentage = total > 0 ? (count / total) * 100 : 0;
                        progressContainer.innerHTML += `
                            <div class="space-y-1">
                                <p class="text-muted-foreground text-sm font-medium">${name}</p>
                                <div class="w-full bg-muted rounded-full h-2.5"><div class="bg-primary h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                            </div>`;
                    });
                } else {
                    progressContainer.innerHTML = `<p class="text-sm text-muted-foreground">Nenhum serviço registrado no período.</p>`;
                }
                container.appendChild(progressContainer);
            }

            async function fetchAndRenderRecentActivities() {
                const container = document.getElementById('recent-activities-list');
                container.innerHTML = '';

                const [{
                    data: newAppointments
                }, {
                    data: newClients
                }] = await Promise.all([
                    supabase.from('consultas').select('nome_cliente, created_at').eq('clinic_id', currentClinicId).order('created_at', {
                        ascending: false
                    }).limit(2),
                    supabase.from('dados_cliente').select('nomewpp, created_at').eq('clinic_id', currentClinicId).order('created_at', {
                        ascending: false
                    }).limit(2)
                ]);

                const activities = [];
                if (newAppointments) {
                    newAppointments.forEach(apt => activities.push({
                        type: 'agendamento',
                        data: apt,
                        time: new Date(apt.created_at)
                    }));
                }
                if (newClients) {
                    newClients.forEach(client => activities.push({
                        type: 'cliente',
                        data: client,
                        time: new Date(client.created_at)
                    }));
                }

                activities.sort((a, b) => b.time - a.time);

                if (activities.length > 0) {
                    activities.slice(0, 3).forEach(activity => {
                        const item = document.createElement('div');
                        item.className = 'flex gap-4';
                        const name = activity.type === 'agendamento' ? activity.data.nome_cliente : activity.data.nomewpp;
                        const actionText = activity.type === 'agendamento' ? 'agendou uma nova consulta.' : 'se cadastrou como novo cliente.';
                        const initials = getInitials(name);
                        item.innerHTML = `
                            <img src="https://placehold.co/40x40/f59e0b/000000?text=${initials}" class="rounded-full size-10">
                            <div>
                                <p class="text-sm text-foreground"><span class="font-bold">${name}</span> ${actionText}</p>
                                <p class="text-xs text-muted-foreground">${timeAgo(activity.time)}</p>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<p class="text-sm text-muted-foreground">Nenhuma atividade recente.</p>';
                }
            }

            async function getChartDataForPeriod(period) {
                let startDate = new Date(0);
                let labels;
                if (period === '7') {
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);
                    labels = Array.from({
                        length: 7
                    }, (_, i) => {
                        const d = new Date();
                        d.setDate(d.getDate() - (6 - i));
                        return d.toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit'
                        });
                    });
                } else if (period === '30') {
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                    labels = Array.from({
                        length: 30
                    }, (_, i) => {
                        const d = new Date();
                        d.setDate(d.getDate() - (29 - i));
                        return d.toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit'
                        });
                    });
                } else { // all
                    labels = Array.from({
                        length: 6
                    }, (v, i) => {
                        const d = new Date();
                        d.setMonth(d.getMonth() - (5 - i));
                        return d.toLocaleDateString('pt-BR', {
                            month: 'short'
                        });
                    });
                }

                const {
                    data,
                    error
                } = await supabase.from('consultas').select('created_at').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString());
                if (error) return [];

                if (period === 'all') {
                    const counts = labels.reduce((acc, label) => ({ ...acc,
                        [label]: 0
                    }), {});
                    data.forEach(d => {
                        const month = new Date(d.created_at).toLocaleDateString('pt-BR', {
                            month: 'short'
                        });
                        if (counts[month] !== undefined) counts[month]++;
                    });
                    return Object.values(counts);
                } else {
                    const counts = labels.reduce((acc, label) => ({ ...acc,
                        [label]: 0
                    }), {});
                    data.forEach(d => {
                        const day = new Date(d.created_at).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit'
                        });
                        if (counts[day] !== undefined) counts[day]++;
                    });
                    return Object.values(counts);
                }
            }

            function getChartLabelsForPeriod(period) {
                if (period === 'all') {
                    return Array.from({
                        length: 6
                    }, (v, i) => {
                        const d = new Date();
                        d.setMonth(d.getMonth() - (5 - i));
                        return d.toLocaleDateString('pt-BR', {
                            month: 'short'
                        });
                    });
                } else {
                    const days = period === '7' ? 7 : 30;
                    return Array.from({
                        length: days
                    }, (_, i) => {
                        const d = new Date();
                        d.setDate(d.getDate() - (days - 1 - i));
                        return d.toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit'
                        });
                    });
                }
            }

            function initializeCharts() {
                const chartBaseOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                };

                const consultasCtx = document.getElementById('consultasChart')?.getContext('2d');
                if (consultasCtx) {
                    consultasChartInstance = new Chart(consultasCtx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                borderRadius: 4
                            }]
                        },
                        options: { ...chartBaseOptions,
                            scales: {
                                y: {
                                    beginAtZero: true
                                },
                                x: {}
                            }
                        }
                    });
                }

                const conversionCtx = document.getElementById('conversionChart')?.getContext('2d');
                if (conversionCtx) {
                    conversionChartInstance = new Chart(conversionCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Instagram', 'Facebook', 'Indicação', 'Outros'],
                            datasets: [{
                                data: [],
                                borderWidth: 0
                            }]
                        },
                        options: { ...chartBaseOptions,
                            cutout: '70%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        boxWidth: 12
                                    }
                                }
                            }
                        }
                    });
                }

                updateChartTheme();
            }

            function updateChartTheme() {
                setTimeout(() => {
                    const style = getComputedStyle(document.documentElement);
                    const textColor = `hsl(${style.getPropertyValue('--muted-foreground').trim()})`;
                    const gridColor = `hsl(${style.getPropertyValue('--border').trim()})`;
                    const primaryColor = `hsl(${style.getPropertyValue('--primary').trim()})`;

                    if (consultasChartInstance) {
                        consultasChartInstance.options.scales.y.ticks.color = textColor;
                        consultasChartInstance.options.scales.x.ticks.color = textColor;
                        consultasChartInstance.options.scales.y.grid.color = gridColor;
                        consultasChartInstance.options.scales.x.grid.color = 'transparent';
                        consultasChartInstance.data.datasets[0].backgroundColor = primaryColor;
                        consultasChartInstance.update();
                    }
                    if (conversionChartInstance) {
                        conversionChartInstance.options.plugins.legend.labels.color = textColor;
                        conversionChartInstance.data.datasets[0].backgroundColor = [primaryColor, '#34d399', '#f97316', `hsl(${style.getPropertyValue('--muted').trim()})`];
                        conversionChartInstance.update();
                    }
                }, 100);
            }

            // -----------------------------------------------------------------------------
            // 5. FUNCIONALIDADE: CLIENTES
            // -----------------------------------------------------------------------------

            async function fetchClients() {
                if (!currentClinicId) return;

                const {
                    data,
                    error
                } = await supabase.from('dados_cliente').select('*').eq('clinic_id', currentClinicId);

                if (error) {
                    clientTableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-500">Erro ao carregar clientes.</td></tr>`;
                    return;
                }

                allClients = data || [];
                renderClientList(allClients);

                clientListSubscription = supabase.channel('public:dados_cliente')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'dados_cliente',
                        filter: `clinic_id=eq.${currentClinicId}`
                    }, async () => {
                        const {
                            data: updatedData
                        } = await supabase.from('dados_cliente').select('*').eq('clinic_id', currentClinicId);
                        allClients = updatedData || [];
                        renderClientList(allClients);
                    })
                    .subscribe();
            }

            const renderClientList = (clients) => {
                clientTableBody.innerHTML = '';
                clientListContainer.innerHTML = '';

                if (!clients || clients.length === 0) {
                    const noClientsHtml = `<tr><td colspan="3" class="p-4 text-center text-muted-foreground">Nenhum cliente encontrado.</td></tr>`;
                    clientTableBody.innerHTML = noClientsHtml;
                    clientListContainer.innerHTML = `<div class="p-4 text-center text-muted-foreground">Nenhum cliente encontrado.</div>`
                    return;
                }

                clients.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                clients.forEach(client => {
                    // Render for mobile (cards)
                    const card = document.createElement('div');
                    card.className = 'bg-card p-4 rounded-lg shadow mb-2 border flex items-center gap-4 cursor-pointer';
                    card.innerHTML = `
                        <img src="https://placehold.co/40x40/f59e0b/000000?text=${getInitials(client.nomewpp)}" class="w-10 h-10 rounded-full">
                        <div class="flex-1">
                            <p class="font-medium">${htmlEncode(client.nomewpp)}</p>
                            <p class="text-sm text-muted-foreground">${htmlEncode(client.telefone)}</p>
                        </div>
                        <span class="text-xs text-muted-foreground">${new Date(client.created_at).toLocaleDateString('pt-BR')}</span>
                    `;
                    card.addEventListener('click', () => showClientDetailsView(client, '#clientes'));
                    clientListContainer.appendChild(card);

                    // Render for desktop (table)
                    const row = document.createElement('tr');
                    row.className = 'border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted cursor-pointer';
                    row.innerHTML = `<td class="p-4 align-middle font-medium">${htmlEncode(client.nomewpp)}</td><td class="p-4 align-middle text-muted-foreground">${htmlEncode(client.telefone)}</td><td class="p-4 align-middle text-muted-foreground">${new Date(client.created_at).toLocaleDateString('pt-BR')}</td>`;
                    row.addEventListener('click', () => showClientDetailsView(client, '#clientes'));
                    clientTableBody.appendChild(row);
                });
            };
            
            async function showClientDetailsView(client, backHash) {
                if (!currentClinicId) return;

                const clientPhoneNumber = (client.telefone || client.telefone_cliente || '').replace(/\D/g, '');
                if (!clientPhoneNumber) return;

                window.location.hash = `#client-detail-${clientPhoneNumber}`;
            }

            async function showAppointmentDetailsView(appointment, backHash) {
                if (!currentClinicId || !appointment) return;
                window.location.hash = `#appointment-detail-${appointment.id}`;
            }

            async function renderClientDetailsPage(client, backHash) {
                const detailSection = document.getElementById('client-detail-section');
                detailSection.innerHTML = `<div class="text-center p-8">Carregando detalhes...</div>`;

                const clientPhoneNumber = (client.telefone || client.telefone_cliente || '').replace(/\D/g, '');

                const [{
                    data: clientDetailsData
                }, {
                    data: appointmentsData
                }] = await Promise.all([
                    supabase.from('dados_cliente').select('*').eq('telefone', clientPhoneNumber).eq('clinic_id', currentClinicId).limit(1),
                    supabase.from('consultas').select('*').eq('telefone_cliente', clientPhoneNumber).eq('clinic_id', currentClinicId).order('data_inicio', {
                        ascending: false
                    })
                ]);

                const clientData = (clientDetailsData && clientDetailsData.length > 0) ? clientDetailsData[0] : client;
                const clientName = clientData.nomewpp || clientData.nome_cliente;
                const clientInitials = getInitials(clientName);
                const age = calculateAge(clientData.data_nascimento);
                const formattedBirthdate = clientData.data_nascimento ? new Date(clientData.data_nascimento).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'Não informado';

                const futureAppointments = appointmentsData ? appointmentsData.filter(a => new Date(a.data_inicio) > new Date()) : [];
                const pastAppointments = appointmentsData ? appointmentsData.filter(a => new Date(a.data_inicio) <= new Date()) : [];

                const renderAppointmentCard = (apt) => {
                    const aptDate = new Date(apt.data_inicio);
                    const statusColors = {
                        'Confirmado': 'text-green-600 dark:text-green-400',
                        'Pendente': 'text-yellow-600 dark:text-yellow-400',
                        'Cancelado': 'text-red-600 dark:text-red-400',
                    };
                    const statusColor = statusColors[apt.status] || 'text-muted-foreground';

                    return `
                    <div class="bg-card p-4 rounded-lg shadow-sm border">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-primary font-bold">${htmlEncode(apt.tipo_consulta)}</p>
                                <p class="text-sm text-muted-foreground">Dr. Ricardo</p>
                            </div>
                            <div class="text-right">
                                <p class="text-foreground font-semibold">${aptDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric'})}</p>
                                <p class="text-sm text-muted-foreground">${aptDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</p>
                            </div>
                        </div>
                        <div class="mt-2 text-sm font-medium ${statusColor}">${htmlEncode(apt.status)}</div>
                    </div>`;
                }

                detailSection.innerHTML = `
                    <header class="flex items-center bg-card p-4 pb-2 justify-between sticky top-0 z-10 -mx-4 md:-mx-6 lg:-mx-8 border-b">
                        <button id="back-to-previous-view-btn" class="flex items-center justify-center text-foreground size-12 shrink-0">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <h1 class="text-foreground text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Detalhes do Cliente</h1>
                        <div class="flex w-12 items-center justify-end"></div>
                    </header>
                    <main class="flex-1">
                        <div class="p-4">
                            <div class="flex w-full flex-col gap-4 sm:flex-row sm:justify-between sm:items-center">
                                <div class="flex gap-4 items-center">
                                    <img src="https://placehold.co/96x96/f59e0b/000000?text=${clientInitials}" alt="Foto do cliente" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full h-24 w-24 shrink-0" />
                                    <div class="flex flex-col justify-center">
                                        <p class="text-foreground text-[22px] font-bold leading-tight">${htmlEncode(clientName)}</p>
                                        <p class="text-muted-foreground text-base font-normal leading-normal">${htmlEncode(clientData.email) || ''}</p>
                                    </div>
                                </div>
                                <div class="flex w-full max-w-[480px] gap-3 sm:w-auto">
                                    <a href="tel:${clientPhoneNumber}" class="flex min-w-[84px] items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-muted text-foreground text-sm font-bold leading-normal flex-1 sm:flex-auto">
                                        <span>Ligar</span>
                                    </a>
                                    <a href="#conversas" data-phone="${clientData.telefone}@c.us" id="send-message-btn" class="flex min-w-[84px] items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-primary-foreground text-sm font-bold leading-normal flex-1 sm:flex-auto">
                                        <span>Enviar Mensagem</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 grid grid-cols-2 border-y">
                            <div class="flex flex-col gap-1 py-4 pr-2">
                                <p class="text-muted-foreground text-sm font-normal">Telefone</p>
                                <p class="text-foreground text-sm font-normal">${htmlEncode(clientData.telefone)}</p>
                            </div>
                            <div class="flex flex-col gap-1 py-4 pl-2">
                                <p class="text-muted-foreground text-sm font-normal">Data de Nascimento</p>
                                <p class="text-foreground text-sm font-normal">${formattedBirthdate} ${age ? `(${age} anos)` : ''}</p>
                            </div>
                        </div>
                        <div class="bg-card p-6 rounded-xl m-4 shadow-xl">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-foreground">Resumo da Conversa</h4>
                                <button id="update-summary-btn" title="Atualizar resumo da conversa" class="text-muted-foreground hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg id="update-summary-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                                </button>
                            </div>
                            <div id="conversation-summary-text" class="text-sm text-muted-foreground space-y-3">Clique no botão acima para gerar um resumo da conversa.</div>
                        </div>
                        <h2 class="text-foreground text-[22px] font-bold leading-tight px-4 pb-3 pt-5">Consultas</h2>
                        <div class="flex px-4 py-3">
                            <div class="flex h-10 flex-1 items-center justify-center rounded-lg bg-muted p-1">
                                <label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-md px-2 has-[:checked]:bg-card has-[:checked]:shadow-sm has-[:checked]:text-foreground text-muted-foreground text-sm font-medium">
                                    <span class="truncate">Próximas</span>
                                    <input checked class="invisible w-0" name="consultas-tab" type="radio" value="Próximas"/>
                                </label>
                                <label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-md px-2 has-[:checked]:bg-card has-[:checked]:shadow-sm has-[:checked]:text-foreground text-muted-foreground text-sm font-medium">
                                    <span class="truncate">Histórico</span>
                                    <input class="invisible w-0" name="consultas-tab" type="radio" value="Histórico"/>
                                </label>
                            </div>
                        </div>
                        <div class="px-4 space-y-4">
                            <div id="upcoming-appointments-list">
                                ${futureAppointments.length > 0 ? futureAppointments.map(renderAppointmentCard).join('') : '<p class="text-center text-sm text-muted-foreground py-4">Nenhuma consulta futura.</p>'}
                            </div>
                            <div id="past-appointments-list" class="hidden">
                                 ${pastAppointments.length > 0 ? pastAppointments.map(renderAppointmentCard).join('') : '<p class="text-center text-sm text-muted-foreground py-4">Nenhum histórico de consultas.</p>'}
                            </div>
                        </div>
                    </main>
                `;
                
                const summaryText = detailSection.querySelector('#conversation-summary-text');
                
                // Initial display
                if(clientData.resumo_conversa) {
                    summaryText.innerHTML = formatSummary(clientData.resumo_conversa);
                    summaryText.classList.remove('text-muted-foreground');
                } else {
                    summaryText.textContent = 'Clique no botão para gerar um resumo da conversa.';
                }

                detailSection.querySelector('#back-to-previous-view-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.history.back();
                });

                const updateSummaryBtn = detailSection.querySelector('#update-summary-btn');
                if (updateSummaryBtn) {
                    const summaryIcon = detailSection.querySelector('#update-summary-icon');

                    updateSummaryBtn.addEventListener('click', async () => {
                        if (updateSummaryBtn.disabled) return;

                        updateSummaryBtn.disabled = true;
                        summaryIcon.classList.add('animate-spin');
                        summaryText.textContent = 'Solicitação de resumo enviada. Atualizando em 7 segundos...';
                        
                        try {
                             await fetch('https://n8n-webhook.jje6ux.easypanel.host/webhook/webhookresumirconversas', {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ telefone: clientPhoneNumber }),
                            });
                        } catch(e) {
                            console.error("Webhook trigger error (no-cors mode, expected)", e);
                        }

                        // Add a 7-second timeout to fetch the summary manually as a fallback
                        setTimeout(async () => {
                            const { data: updatedClientData, error } = await supabase
                                .from('dados_cliente')
                                .select('resumo_conversa')
                                .eq('id', clientData.id)
                                .single();

                            updateSummaryBtn.disabled = false;
                            summaryIcon.classList.remove('animate-spin');

                            if (error) {
                                console.error('Error fetching updated summary:', error);
                                summaryText.textContent = 'Erro ao buscar o resumo. Tente novamente.';
                                return;
                            }

                            if (updatedClientData && updatedClientData.resumo_conversa) {
                                summaryText.innerHTML = formatSummary(updatedClientData.resumo_conversa);
                                summaryText.classList.remove('text-muted-foreground');
                            } else {
                                // Only update the text if it hasn't been updated by the realtime listener already.
                                if (summaryText.textContent.startsWith('Solicitação de resumo')) {
                                    summaryText.textContent = 'Resumo ainda não disponível. Tente novamente em alguns instantes.';
                                }
                            }
                        }, 7000);
                    });
                }

                // Real-time subscription for summary updates
                unsubscribeFromChannels(); // Clear any previous subscription
                clientListSubscription = supabase.channel(`client-summary-${clientData.id}`)
                    .on('postgres_changes', {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'dados_cliente',
                        filter: `id=eq.${clientData.id}`
                    }, payload => {
                        const newSummary = payload.new.resumo_conversa;
                        if (newSummary && summaryText) {
                            summaryText.innerHTML = formatSummary(newSummary);
                            summaryText.classList.remove('text-muted-foreground');
                        }
                    })
                    .subscribe();

                const tabs = detailSection.querySelectorAll('input[name="consultas-tab"]');
                const upcomingList = detailSection.querySelector('#upcoming-appointments-list');
                const pastList = detailSection.querySelector('#past-appointments-list');
                tabs.forEach(tab => {
                    tab.addEventListener('change', () => {
                        if (tab.value === 'Próximas' && tab.checked) {
                            upcomingList.classList.remove('hidden');
                            pastList.classList.add('hidden');
                        } else {
                            upcomingList.classList.add('hidden');
                            pastList.classList.remove('hidden');
                        }
                    });
                });
            }

            async function renderAppointmentDetailsPage(appointment, backHash) {
                const detailSection = document.getElementById('appointment-detail-section');
                detailSection.innerHTML = `<div class="text-center p-8">Carregando detalhes...</div>`;

                const {
                    data: clientData,
                    error
                } = await supabase.from('dados_cliente')
                    .select('*')
                    .eq('telefone', appointment.telefone_cliente)
                    .eq('clinic_id', currentClinicId)
                    .single();

                const clientInfoHtml = error || !clientData ?
                    '<p>Detalhes do cliente não encontrados.</p>' :
                    ` <h3 class="text-lg font-semibold text-foreground">${htmlEncode(clientData.nomewpp)}</h3>
                            <p class="text-sm text-muted-foreground">${htmlEncode(clientData.email) || ''}</p>
                            <p class="text-sm text-muted-foreground">${htmlEncode(clientData.telefone)}</p>`;

                detailSection.innerHTML = `
                    <div class="max-w-6xl mx-auto pt-8 md:pt-0">
                        <div class="flex items-center mb-6">
                            <button id="back-to-previous-view-btn" class="p-2 mr-4 rounded-full hover:bg-muted text-foreground"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                            <h1 class="text-3xl font-bold tracking-tight text-foreground">Detalhes da Consulta</h1>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 bg-card p-6 rounded-xl border">
                                <h2 class="text-xl font-bold text-foreground mb-4">${htmlEncode(appointment.tipo_consulta)}</h2>
                                <div class="space-y-4 text-muted-foreground">
                                    <p><strong>Data:</strong> ${new Date(appointment.data_inicio).toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'short' })}</p>
                                    <p><strong>Status:</strong> <span class="px-2 py-1 text-xs font-medium rounded-full bg-primary/20 text-primary">${htmlEncode(appointment.status)}</span></p>
                                    <p><strong>Valor:</strong> R$ ${appointment.valor || 'Não definido'}</p>
                                    <p><strong>Observações:</strong> ${htmlEncode(appointment.observacoes) || 'Nenhuma.'}</p>
                                </div>
                            </div>
                            <div class="lg:col-span-1 bg-card p-6 rounded-xl border flex flex-col items-center text-center">
                                <img class="h-24 w-24 rounded-full object-cover mb-4" src="https://placehold.co/96x96/f59e0b/000000?text=${getInitials(appointment.nome_cliente)}" alt="Foto de perfil">
                                ${clientInfoHtml}
                                <a href="#client-detail-${appointment.telefone_cliente.replace(/\D/g, '')}" class="mt-4 text-sm text-primary hover:underline">Ver perfil completo</a>
                            </div>
                        </div>
                    </div>
                `;
                detailSection.querySelector('#back-to-previous-view-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = backHash;
                });
            }

            // -----------------------------------------------------------------------------
            // 6. FUNCIONALIDADE: CONVERSAS
            // -----------------------------------------------------------------------------

            async function fetchChats() {
                if (!currentClinicId) return;

                const {
                    data: allMessages,
                    error
                } = await supabase.from('n8n_chat_histories').select('session_id, created_at, content, patient_name, role').eq('clinic_id', currentClinicId).order('created_at', {
                    ascending: false
                });

                if (error) {
                    document.getElementById('chat-list-container').innerHTML = `<div class="p-4 text-center text-red-400">Falha ao carregar conversas.</div>`;
                } else {
                    const latestChats = new Map();
                    allMessages.forEach(msg => {
                        if (!latestChats.has(msg.session_id)) {
                            latestChats.set(msg.session_id, {
                                phone: `${msg.session_id}@c.us`,
                                updated_at: msg.created_at,
                                last_message: msg.content || '...',
                                nomewpp: msg.patient_name || msg.session_id
                            });
                        }
                    });
                    currentChats = Array.from(latestChats.values());
                    renderChatList(currentChats);
                    renderMobileChatList(currentChats);
                }
            };

            const renderMobileChatList = (chats) => {
                const wrapper = document.getElementById('mobile-conversas-wrapper');
                wrapper.innerHTML = `
                    <div id="mobile-chat-list-view" class="flex flex-col h-full bg-card">
                         <header class="flex items-center justify-between p-4 bg-primary text-white shadow-md">
                            <h1 class="text-xl font-bold">Conversas</h1>
                            <div class="flex items-center gap-2">
                                <button class="p-2 rounded-full hover:bg-white/20"><span class="material-symbols-outlined">search</span></button>
                                <button class="p-2 rounded-full hover:bg-white/20"><span class="material-symbols-outlined">more_vert</span></button>
                            </div>
                        </header>
                        <div id="mobile-chat-list-container" class="flex-1 overflow-y-auto"></div>
                    </div>
                `;
                
                const container = document.getElementById('mobile-chat-list-container');
                if (chats.length === 0) {
                    container.innerHTML = `<li class="p-8 text-center text-muted-foreground">Nenhuma conversa.</li>`;
                    return;
                }

                chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'flex items-start gap-3 p-3 cursor-pointer border-b border-border hover:bg-muted';
                    item.dataset.chatId = chat.phone;
                    const initials = getInitials(chat.nomewpp);

                    item.innerHTML = `
                        <img class="h-12 w-12 rounded-full object-cover mt-1" src="https://placehold.co/48x48/f59e0b/000000?text=${initials}" alt="Foto de ${htmlEncode(chat.nomewpp)}">
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-base text-foreground">${htmlEncode(chat.nomewpp)}</p>
                                <p class="text-xs text-green-500 font-semibold">${formatTimestamp(chat.updated_at)}</p>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-sm text-muted-foreground line-clamp-1">${htmlEncode(chat.last_message)}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });

                container.querySelectorAll('.cursor-pointer').forEach(item => {
                    item.addEventListener('click', () => {
                         currentChat = currentChats.find(c => c.phone == item.dataset.chatId);
                         if (currentChat) renderMobileChatView(currentChat);
                    });
                });
            };

            const renderMobileChatView = async (chat) => {
                const wrapper = document.getElementById('mobile-conversas-wrapper');
                
                const chatView = document.createElement('div');
                chatView.className = 'absolute inset-0 flex flex-col h-full bg-background transition-transform duration-300 ease-in-out translate-x-full';
                wrapper.appendChild(chatView);

                const initials = getInitials(chat.nomewpp);
                const phoneForDetail = chat.phone.replace(/\D/g, '');

                chatView.innerHTML = `
                    <header class="flex items-center p-2 bg-card shadow-sm z-10 sticky top-0 border-b">
                        <button class="back-to-list-btn p-2 rounded-full hover:bg-muted">
                            <span class="material-symbols-outlined text-foreground">arrow_back</span>
                        </button>
                        <a href="#client-detail-${phoneForDetail}" class="flex items-center gap-3">
                            <img class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/40x40/f59e0b/000000?text=${initials}" alt="Foto de ${htmlEncode(chat.nomewpp)}">
                            <div class="flex-1">
                                <h3 class="font-semibold text-base text-foreground">${htmlEncode(chat.nomewpp)}</h3>
                            </div>
                        </a>
                        <div class="flex items-center ml-auto">
                            <button class="p-2 rounded-full hover:bg-muted">
                                <span class="material-symbols-outlined text-foreground">more_vert</span>
                            </button>
                        </div>
                    </header>
                    <div class="chat-messages-container flex-1 p-4 space-y-2 overflow-y-auto">
                        <div class="text-center text-xs text-muted-foreground my-2"><span class="bg-muted rounded-md px-2 py-1">Hoje</span></div>
                    </div>
                    <footer class="p-2 bg-transparent sticky bottom-0">
                        <div class="flex items-end gap-2">
                            <div class="flex-1 flex items-center bg-card rounded-full px-2 border">
                                <input class="chat-input flex-1 bg-transparent border-none focus:ring-0 py-2.5" placeholder="Mensagem" type="text"/>
                            </div>
                            <button class="send-btn bg-primary text-primary-foreground p-3 rounded-full hover:bg-primary/90 shadow-md">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </div>
                    </footer>
                `;

                // Animate slide-in
                setTimeout(() => chatView.classList.remove('translate-x-full'), 10);
                
                chatView.querySelector('.back-to-list-btn').addEventListener('click', () => {
                    chatView.classList.add('translate-x-full');
                    setTimeout(() => chatView.remove(), 300);
                });

                const messagesContainer = chatView.querySelector('.chat-messages-container');
                const sessionId = chat.phone.split('@')[0];
                const { data } = await supabase.from('n8n_chat_histories').select('created_at, content, role').eq('session_id', sessionId).eq('clinic_id', currentClinicId).order('created_at', { ascending: true });

                if (data) {
                    data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    data.forEach(msg => {
                        if (!msg.content) return;
                        const isFromClient = msg.role?.toLowerCase() === 'user';
                        const messageEl = document.createElement('div');
                        messageEl.className = `flex ${isFromClient ? 'justify-start' : 'justify-end'}`;
                        messageEl.innerHTML = `
                             <div class="max-w-[85%]">
                                <div class="${isFromClient ? 'bg-card' : 'bg-primary text-primary-foreground'} p-2 rounded-xl ${isFromClient ? 'rounded-tl-none' : 'rounded-br-none'} shadow-sm border">
                                    <p class="text-sm">${htmlEncode(msg.content)}</p>
                                    <p class="text-xs text-right ${isFromClient ? 'text-muted-foreground/70' : 'text-primary-foreground/70'} mt-1">${formatTimestamp(msg.created_at, isUserMessage)}</p>
                                </div>
                            </div>
                        `;
                        messagesContainer.appendChild(messageEl);
                    });
                     messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            };
            
            const renderChatList = (chats) => {
                const chatListContainer = document.getElementById('chat-list-container');
                chatListContainer.innerHTML = '';
                chatListContainer.className = 'flex-1 overflow-y-auto';

                if (chats.length === 0) {
                    chatListContainer.innerHTML = `<li class="p-8 text-center text-muted-foreground">Nenhuma conversa.</li>`;
                    return;
                }

                chats.forEach(chat => {
                    const chatLi = document.createElement('li');
                    const initials = getInitials(chat.nomewpp);

                    chatLi.innerHTML = `
                        <a class="flex items-center gap-4 p-4 border-b hover:bg-muted transition-colors" href="#" data-chat-id="${chat.phone}">
                            <img class="h-12 w-12 rounded-full object-cover" src="https://placehold.co/56x56/f59e0b/000000?text=${initials}" alt="Foto de perfil de ${htmlEncode(chat.nomewpp)}">
                            <div class="flex-1 overflow-hidden">
                                <div class="flex justify-between items-baseline">
                                    <p class="font-semibold text-foreground truncate">${htmlEncode(chat.nomewpp)}</p>
                                    <span class="text-xs text-muted-foreground ml-2 shrink-0">${formatTimestamp(chat.updated_at)}</span>
                                </div>
                                <p class="text-sm text-muted-foreground truncate mt-0.5">${htmlEncode(chat.last_message)}</p>
                            </div>
                        </a>
                    `;
                    chatListContainer.appendChild(chatLi);
                });

                chatListContainer.querySelectorAll('a').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        chatListContainer.querySelectorAll('a').forEach(el => el.classList.remove('bg-primary/20'));
                        item.classList.add('bg-primary/20');

                        currentChat = currentChats.find(c => c.phone == item.dataset.chatId);
                        if (!currentChat) return;

                        document.getElementById('new-chat-placeholder').style.display = 'none';
                        document.getElementById('new-chat-view').classList.remove('hidden');
                        document.getElementById('new-chat-view').classList.add('flex');

                        fetchMessagesForChat(currentChat.phone);
                        renderChatDetails(currentChat);
                    });
                });
            };

            async function renderChatDetails(chat) {
                const detailsContainer = document.getElementById('chat-details-panel');
                detailsContainer.innerHTML = '<p class="text-center text-muted-foreground">Carregando...</p>';

                const phone = chat.phone.split('@')[0];
                const {
                    data: clientData,
                    error
                } = await supabase.from('dados_cliente')
                    .select('*')
                    .eq('telefone', phone)
                    .eq('clinic_id', currentClinicId)
                    .single();

                if (error || !clientData) {
                    detailsContainer.innerHTML = '<p class="text-center text-muted-foreground">Detalhes do cliente não encontrados.</p>';
                    return;
                }
                const initials = getInitials(clientData.nomewpp);
                detailsContainer.innerHTML = `
                    <h2 class="text-xl font-bold text-foreground text-center">Detalhes do Cliente</h2>
                    <div class="flex flex-col items-center">
                        <img class="h-24 w-24 rounded-full object-cover mb-4" src="https://placehold.co/96x96/f59e0b/000000?text=${initials}" alt="Foto de perfil de ${htmlEncode(clientData.nomewpp)}">
                        <h3 class="text-lg font-semibold text-foreground">${htmlEncode(clientData.nomewpp)}</h3>
                        <p class="text-sm text-muted-foreground">${htmlEncode(clientData.email) || ''}</p>
                        <p class="text-sm text-muted-foreground">${htmlEncode(clientData.telefone)}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-foreground mb-4">Próximos Agendamentos</h4>
                        <div id="client-upcoming-appointments" class="space-y-3">
                            <p class="text-sm text-muted-foreground">Nenhum agendamento próximo.</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-foreground mb-4">Histórico</h4>
                        <ul id="client-history" class="space-y-4">
                           <p class="text-sm text-muted-foreground">Nenhum histórico encontrado.</p>
                        </ul>
                    </div>`;

                const {
                    data: appointments
                } = await supabase.from('consultas').select('*').eq('telefone_cliente', phone).eq('clinic_id', currentClinicId).order('data_inicio', {
                    ascending: true
                });

                const upcomingAppointmentsContainer = document.getElementById('client-upcoming-appointments');
                upcomingAppointmentsContainer.innerHTML = '';
                const upcoming = appointments.filter(a => new Date(a.data_inicio) > new Date());
                if (upcoming.length > 0) {
                    upcoming.slice(0, 1).forEach(apt => {
                        upcomingAppointmentsContainer.innerHTML += `
                        <div class="bg-muted p-4 rounded-lg flex items-center justify-between">
                            <div>
                                <p class="font-medium text-foreground">${htmlEncode(apt.tipo_consulta)}</p>
                                <p class="text-sm text-muted-foreground">${new Date(apt.data_inicio).toLocaleString('pt-BR', {day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit'})}</p>
                            </div>
                        </div>`;
                    });
                } else {
                    upcomingAppointmentsContainer.innerHTML = '<p class="text-sm text-muted-foreground">Nenhum agendamento próximo.</p>';
                }

                const historyContainer = document.getElementById('client-history');
                historyContainer.innerHTML = '';
                const pastAppointments = appointments.filter(a => new Date(a.data_inicio) <= new Date());
                if (pastAppointments.length > 0) {
                    pastAppointments.slice(0, 2).forEach(apt => {
                        historyContainer.innerHTML += `
                        <li class="flex items-start gap-4">
                            <div class="bg-primary/20 rounded-full p-2">
                                <span class="material-symbols-outlined text-primary">calendar_month</span>
                            </div>
                            <div>
                                <p class="font-medium text-foreground">Consulta Realizada</p>
                                <p class="text-sm text-muted-foreground">${new Date(apt.data_inicio).toLocaleDateString('pt-BR')}</p>
                            </div>
                        </li>`;
                    });
                } else {
                    historyContainer.innerHTML = '<p class="text-sm text-muted-foreground">Nenhum histórico encontrado.</p>';
                }

            }

            async function fetchMessagesForChat(chatId) {
                if (!currentClinicId) return;

                const messagesContainer = document.getElementById('new-chat-messages');
                const chatHeader = document.getElementById('chat-active-header');
                messagesContainer.innerHTML = '';

                const client = currentChats.find(c => c.phone === chatId);
                const initials = getInitials(client.nomewpp);

                chatHeader.innerHTML = `
                    <button id="back-to-chat-list" class="p-2 -ml-2 rounded-md hover:bg-muted text-foreground md:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <img class="h-12 w-12 rounded-full object-cover" src="https://placehold.co/48x48/f59e0b/000000?text=${initials}" alt="Foto de ${htmlEncode(client.nomewpp)}">
                    <div>
                        <h3 class="font-bold text-lg text-foreground">${htmlEncode(client.nomewpp)}</h3>
                        <p class="text-sm text-green-500">Online</p>
                    </div>
                    <a id="chat-details-button" href="#" class="p-2 rounded-full hover:bg-muted text-foreground ml-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    </a>
                `;
                
                const phoneForDetail = client.phone.replace(/\D/g, '');
                chatHeader.querySelector('#chat-details-button').href = `#client-detail-${phoneForDetail}`;

                chatHeader.querySelector('#back-to-chat-list')?.addEventListener('click', () => {
                    document.getElementById('chat-list-column').classList.remove('hidden');
                    document.getElementById('chat-view-column').classList.add('hidden');
                });


                const sessionId = chatId.split('@')[0];
                const {
                    data,
                    error
                } = await supabase.from('n8n_chat_histories').select('created_at, content, role').eq('session_id', sessionId).eq('clinic_id', currentClinicId).order('created_at', {
                    ascending: true
                });

                if (error) {
                    messagesContainer.innerHTML = `<div class="text-center text-red-400">Erro ao carregar mensagens.</div>`;
                } else if (data && data.length > 0) {
                    data.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    data.forEach(msg => appendMessageToNewChat(msg, client.nomewpp));
                } else {
                    messagesContainer.innerHTML = `<div class="text-center text-muted-foreground">Sem mensagens nesta conversa.</div>`;
                }
            }

            async function sendMessage() {
                const chatInput = document.getElementById('new-chat-input');
                if (!currentClinicId || !currentChat || chatInput.value.trim() === '') return;

                const text = chatInput.value.trim();
                const newMessage = {
                    session_id: currentChat.phone.split('@')[0],
                    content: text,
                    role: 'AI',
                    patient_name: currentChat.nomewpp,
                    clinic_id: currentClinicId
                };

                const {
                    error
                } = await supabase.from('n8n_chat_histories').insert([newMessage]);

                if (!error) {
                    appendMessageToNewChat({ ...newMessage,
                        created_at: new Date().toISOString()
                    });
                    chatInput.value = '';
                } else {
                    console.error("Erro ao enviar mensagem:", error);
                }
            }

            const appendMessageToNewChat = (message, clientName) => {
                if (!message.content) return;
                const messagesContainer = document.getElementById('new-chat-messages');
                const isFromClient = message.role?.toLowerCase() === 'user';
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex items-end gap-3 max-w-lg ${isFromClient ? '' : 'ml-auto flex-row-reverse'}`;

                const initials = getInitials(isFromClient ? clientName : 'Admin');
                const avatarSrc = isFromClient ? `https://placehold.co/40x40/f59e0b/000000?text=${initials}` : document.getElementById('user-avatar-header').src;
                const timeAlignment = isFromClient ? 'text-left' : 'text-right';
                const bubbleClasses = isFromClient ? 'bg-card text-card-foreground rounded-xl rounded-tl-none border' : 'bg-primary text-primary-foreground rounded-xl rounded-br-none';


                messageWrapper.innerHTML = `
                    <img class="h-10 w-10 rounded-full object-cover shrink-0" src="${avatarSrc}" alt="Avatar">
                    <div class="flex flex-col">
                        <div class="${bubbleClasses} p-4 rounded-xl">
                            <p>${htmlEncode(message.content)}</p>
                        </div>
                        <span class="text-xs text-muted-foreground mt-1 px-2 ${timeAlignment}">${formatTimestamp(message.created_at, isFromClient)}</span>
                    </div>
                `;

                messagesContainer.appendChild(messageWrapper);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            // -----------------------------------------------------------------------------
            // 7. FUNCIONALIDADE: FUNIL (KANBAN)
            // -----------------------------------------------------------------------------
             function initializeKanban() {
                const container = document.getElementById('kanban-board-container');
                if (!container || container.dataset.initialized) return;
                container.dataset.initialized = 'true';

                const kanbanData = {
                    lead: [
                         { id: '1', title: 'Maria Silva', priority: 'medium', assignee: 'Marketing', description: 'Interessada em consulta de avaliação.' },
                         { id: '2', title: 'Carlos Andrade', priority: 'low', assignee: 'Marketing', description: 'Pediu informações via Instagram.' },
                    ],
                    contact: [
                        { id: '3', title: 'João Pereira', priority: 'high', assignee: 'Secretária', description: 'Agendou primeira consulta para amanhã.' },
                    ],
                    negotiation: [],
                    closed: [
                        { id: '4', title: 'Ana Costa', priority: 'high', assignee: 'Dr. Ricardo', description: 'Fechou pacote de 3 sessões.' },
                    ]
                };

                const columnTitles = {
                    lead: 'Lead',
                    contact: 'Contato Inicial',
                    negotiation: 'Negociação',
                    closed: 'Fechado'
                };
                
                container.innerHTML = ''; // Clear previous static content

                Object.keys(columnTitles).forEach(columnId => {
                    const columnEl = document.createElement('div');
                    columnEl.className = 'flex flex-col';
                    const tasks = kanbanData[columnId] || [];
                    
                    columnEl.innerHTML = `
                        <div class="flex items-center justify-between p-2 mb-2">
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold text-foreground">${columnTitles[columnId]}</h3>
                                <span class="text-sm px-2 py-0.5 bg-muted rounded-full text-muted-foreground">${tasks.length}</span>
                            </div>
                            <button class="kanban-column-handle p-2 text-muted-foreground hover:text-foreground cursor-grab active:cursor-grabbing">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M12 5v14"/><path d="M8 5v14"/><path d="M16 5v14"/></svg>
                            </button>
                        </div>
                        <div class="kanban-cards-container flex-grow space-y-3 p-1 min-h-[200px] bg-muted/50 rounded-lg" data-column-id="${columnId}">
                            ${tasks.map(task => `
                                <div class="kanban-card" data-task-id="${task.id}">
                                    <div class="flex flex-col gap-2.5">
                                        <div class="flex items-center justify-between gap-2">
                                            <span class="font-medium text-sm text-foreground">${htmlEncode(task.title)}</span>
                                            <span class="kanban-badge ${task.priority === 'high' ? 'kanban-badge-destructive' : task.priority === 'medium' ? 'kanban-badge-primary' : 'kanban-badge-warning'}">${htmlEncode(task.priority)}</span>
                                        </div>
                                        <p class="text-xs text-muted-foreground">${htmlEncode(task.description)}</p>
                                        <div class="flex items-center gap-2 text-xs text-muted-foreground mt-1">
                                            <img src="https://placehold.co/20x20/64748b/FFFFFF?text=${getInitials(task.assignee)}" class="w-5 h-5 rounded-full">
                                            <span>${htmlEncode(task.assignee)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(columnEl);
                });

                const cardContainers = container.querySelectorAll('.kanban-cards-container');
                cardContainers.forEach(el => {
                    new Sortable(el, {
                        group: 'kanban-tasks',
                        animation: 150,
                        ghostClass: 'sortable-ghost'
                    });
                });
                
                new Sortable(container, {
                    handle: '.kanban-column-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost'
                });
            }


            // -----------------------------------------------------------------------------
            // 8. FUNCIONALIDADE: AGENDAMENTOS
            // -----------------------------------------------------------------------------

            async function fetchAndRenderAgenda() {
                const {
                    data,
                    error
                } = await supabase
                    .from('consultas')
                    .select('*')
                    .eq('clinic_id', '457e67c0-55ca-456d-8762-cc94df166e6d')
                    .eq('status', 'confirmada');

                allAppointments = error ? [] : data;
                renderAgendaView();
            }

            function renderAgendaView() {
                // Desktop
                renderFullCalendar();
                renderWeeklyView();
                renderDailyView();
                // Mobile
                renderMobileAgendaLayout();

                const dateRange = document.getElementById('weekly-view-date-range');
                const dailyBtn = document.querySelector('.view-toggle-btn[data-view="daily"]');
                const weeklyBtn = document.querySelector('.view-toggle-btn[data-view="weekly"]');

                document.getElementById('weekly-view').classList.toggle('hidden', currentCalendarView !== 'weekly');
                document.getElementById('daily-view').classList.toggle('hidden', currentCalendarView !== 'daily');
                weeklyBtn.classList.toggle('bg-background', currentCalendarView === 'weekly');
                weeklyBtn.classList.toggle('text-foreground', currentCalendarView === 'weekly');
                weeklyBtn.classList.toggle('shadow-sm', currentCalendarView === 'weekly');
                dailyBtn.classList.toggle('bg-background', currentCalendarView !== 'weekly');
                dailyBtn.classList.toggle('text-foreground', currentCalendarView !== 'weekly');
                dailyBtn.classList.toggle('shadow-sm', currentCalendarView !== 'weekly');

                if (currentCalendarView === 'weekly') {
                    const startOfWeek = new Date(currentDate);
                    startOfWeek.setDate(currentDate.getDate() - startOfWeek.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(endOfWeek.getDate() + 6);
                    dateRange.textContent = `${startOfWeek.toLocaleDateString('pt-BR', {month: 'long', day: 'numeric'})} - ${endOfWeek.toLocaleDateString('pt-BR', {day: 'numeric', month: 'long', year: 'numeric'})}`;
                } else {
                    dateRange.textContent = `${currentDate.toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'})}`;
                }
            }

            function renderMobileAgendaLayout() {
                const container = document.getElementById('mobile-agenda-wrapper');
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const calendarDays = () => {
                    let daysHtml = '';
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const today = new Date();
                    
                    for (let i = 0; i < firstDayOfMonth; i++) {
                        daysHtml += '<div></div>';
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const thisDate = new Date(year, month, day);
                        const isSelected = thisDate.toDateString() === currentDate.toDateString();
                        const hasAppointments = allAppointments.some(apt => new Date(apt.data_inicio).toDateString() === thisDate.toDateString());

                        daysHtml += `
                            <button data-day="${day}" class="h-12 w-full text-sm font-medium leading-normal ${isSelected ? 'text-primary-foreground' : 'text-foreground hover:bg-muted'}">
                                <div class="flex size-full items-center justify-center rounded-full relative ${isSelected ? 'bg-primary' : ''}">
                                    ${hasAppointments ? `<div class="absolute bottom-1.5 h-1 w-1 rounded-full ${isSelected ? 'bg-primary-foreground' : 'bg-primary'}"></div>` : ''}
                                    ${day}
                                </div>
                            </button>
                        `;
                    }
                    return daysHtml;
                };

                const dailyAppointments = allAppointments
                    .filter(apt => new Date(apt.data_inicio).toDateString() === currentDate.toDateString())
                    .sort((a,b) => new Date(a.data_inicio) - new Date(b.data_inicio));

                const statusIndicator = (status) => {
                    if (status === 'Confirmado') return 'bg-green-500';
                    if (status === 'Pendente') return 'bg-yellow-500';
                    if (status === 'Cancelado') return 'bg-red-500';
                    return 'bg-gray-400';
                }
                
                let appointmentsHtml = dailyAppointments.map(apt => `
                    <div class="flex gap-4 bg-card px-4 py-3 justify-between border-b" data-appointment-id="${apt.id}">
                        <div class="flex items-start gap-4">
                            <div class="text-foreground flex items-center justify-center rounded-lg bg-muted shrink-0 size-12">
                                <span class="material-symbols-outlined">schedule</span>
                            </div>
                            <div class="flex flex-1 flex-col justify-center">
                                <p class="text-foreground text-base font-medium leading-normal">${formatTimestamp(apt.data_inicio)} - ${htmlEncode(apt.nome_cliente)}</p>
                                <p class="text-muted-foreground text-sm font-normal leading-normal">${htmlEncode(apt.tipo_consulta)}</p>
                            </div>
                        </div>
                        <div class="shrink-0">
                            <div class="flex size-7 items-center justify-center">
                                <div class="size-3 rounded-full ${statusIndicator(apt.status)}"></div>
                            </div>
                        </div>
                    </div>
                `).join('');

                if (dailyAppointments.length === 0) {
                    appointmentsHtml = `<p class="text-center text-muted-foreground p-8">Nenhum agendamento para este dia.</p>`;
                }

                container.innerHTML = `
                    <div class="sticky top-0 z-10 bg-background">
                        <div class="flex items-center p-4 pb-2 justify-between">
                            <h2 class="text-foreground text-lg font-bold flex-1 text-center">Agendamentos</h2>
                        </div>
                        <div class="p-4">
                            <div class="flex flex-col gap-0.5">
                                <div class="flex items-center p-1 justify-between">
                                    <button id="mobile-calendar-prev-month">
                                        <div class="text-foreground flex size-10 items-center justify-center"><span class="material-symbols-outlined text-lg">chevron_left</span></div>
                                    </button>
                                    <p class="text-foreground text-base font-bold text-center">${new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</p>
                                    <button id="mobile-calendar-next-month">
                                        <div class="text-foreground flex size-10 items-center justify-center"><span class="material-symbols-outlined text-lg">chevron_right</span></div>
                                    </button>
                                </div>
                                <div class="grid grid-cols-7 text-center text-xs font-bold text-muted-foreground h-12 items-center">
                                    <span>D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span>
                                </div>
                                <div class="grid grid-cols-7">${calendarDays()}</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow bg-card rounded-t-xl shadow-lg pt-4">
                        <h3 class="text-foreground text-lg font-bold px-4 pb-2">Agendamentos para ${currentDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long'})}</h3>
                        <div class="flex flex-col gap-px">${appointmentsHtml}</div>
                    </div>
                `;

                container.querySelector('#mobile-calendar-prev-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    fetchAndRenderAgenda();
                });
                container.querySelector('#mobile-calendar-next-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    fetchAndRenderAgenda();
                });
                container.querySelectorAll('button[data-day]').forEach(button => {
                    button.addEventListener('click', () => {
                        currentDate = new Date(year, month, parseInt(button.dataset.day));
                        renderMobileAgendaLayout(); // Re-render only the mobile view for speed
                    });
                });
                container.querySelectorAll('[data-appointment-id]').forEach(item => {
                     item.addEventListener('click', () => {
                        const appointment = allAppointments.find(a => a.id == item.dataset.appointmentId);
                        if (appointment) showAppointmentDetailsView(appointment, '#agendamentos');
                     });
                });
            }

            function renderFullCalendar() {
                const container = document.getElementById('full-calendar-container');
                container.innerHTML = '';

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const header = document.createElement('div');
                header.className = 'relative mb-1 flex h-9 items-center justify-center z-20';
                header.innerHTML = `
                    <div class="absolute top-0 inset-x-0 flex h-9 items-center justify-between z-10 px-1">
                        <button id="calendar-prev-month" class="size-9 p-0 inline-flex items-center justify-center whitespace-nowrap rounded-lg text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground text-muted-foreground/80">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <button id="calendar-next-month" class="size-9 p-0 inline-flex items-center justify-center whitespace-nowrap rounded-lg text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground text-muted-foreground/80">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                    <span class="text-sm font-medium text-foreground">${new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</span>
                `;
                container.appendChild(header);

                header.querySelector('#calendar-prev-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    fetchAndRenderAgenda();
                });
                header.querySelector('#calendar-next-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    fetchAndRenderAgenda();
                });

                const weekdays = document.createElement('div');
                weekdays.className = 'grid grid-cols-7';
                ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].forEach(day => {
                    weekdays.innerHTML += `<div class="size-9 p-0 text-xs font-medium text-muted-foreground/80 flex items-center justify-center">${day}</div>`;
                });
                container.appendChild(weekdays);


                const daysGrid = document.createElement('div');
                daysGrid.className = 'grid grid-cols-7';

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                for (let i = 0; i < firstDayOfMonth; i++) daysGrid.appendChild(document.createElement('div'));

                for (let day = 1; day <= daysInMonth; day++) {
                    const thisDate = new Date(year, month, day);
                    const dayGroup = document.createElement('div');
                    dayGroup.className = 'group size-9 px-0 text-sm flex items-center justify-center';

                    const dayButton = document.createElement('button');
                    dayButton.className = "relative flex size-9 items-center justify-center whitespace-nowrap rounded-lg p-0 text-foreground outline-offset-2 hover:bg-accent focus:outline-none focus-visible:z-10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-ring/70";

                    if (thisDate.toDateString() === currentDate.toDateString()) {
                        dayButton.classList.add('bg-primary', 'text-primary-foreground', 'font-bold');
                    }

                    dayButton.innerHTML = `<span>${day}</span>`;

                    if (allAppointments.some(apt => new Date(apt.data_inicio).toDateString() === thisDate.toDateString())) {
                        const dot = document.createElement('span');
                        dot.className = "pointer-events-none absolute bottom-1 start-1/2 z-10 size-[3px] -translate-x-1/2 rounded-full";
                        dot.classList.add(thisDate.toDateString() === currentDate.toDateString() ? 'bg-background' : 'bg-primary');
                        dayButton.appendChild(dot);
                    }
                    if (thisDate.toDateString() === today.toDateString()) {
                        dayButton.classList.add('border', 'border-primary');
                    }


                    dayButton.addEventListener('click', () => {
                        currentDate = thisDate;
                        renderAgendaView();
                    });
                    dayGroup.appendChild(dayButton);
                    daysGrid.appendChild(dayGroup);
                }
                container.appendChild(daysGrid);
            }

            function renderWeeklyView() {
                const header = document.getElementById('weekly-header');
                const body = document.getElementById('weekly-body');
                header.innerHTML = '';
                body.innerHTML = '';

                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - startOfWeek.getDay());

                const weekDays = Array.from({
                    length: 7
                }, (_, i) => {
                    const d = new Date(startOfWeek);
                    d.setDate(d.getDate() + i);
                    return d;
                });

                weekDays.forEach(day => {
                    const isToday = day.toDateString() === new Date().toDateString();
                    header.innerHTML += `<div class="text-center py-2 border-b"><p class="text-xs text-muted-foreground">${day.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(0,1).toUpperCase()}</p><p class="text-lg font-bold mt-1 ${isToday ? 'bg-primary text-primary-foreground rounded-full w-8 h-8 mx-auto flex items-center justify-center' : ''}">${day.getDate()}</p></div>`;
                });

                const startHour = 8,
                    endHour = 18,
                    hourHeight = 80;
                let hourLinesHTML = '';
                for (let hour = startHour; hour <= endHour; hour++) {
                    hourLinesHTML += `<div class="relative" style="height: ${hourHeight}px;"><div class="absolute left-0 -top-2.5 -ml-12 text-right w-10"><span class="text-xs text-muted-foreground">${hour}:00</span></div><div class="h-full border-t"></div></div>`;
                }

                let appointmentsHTML = '<div class="absolute inset-0 grid grid-cols-7 ml-12">';
                weekDays.forEach((day, dayIndex) => {
                    appointmentsHTML += `<div class="relative border-r">`;
                    const dayAppointments = allAppointments.filter(apt => new Date(apt.data_inicio).toDateString() === day.toDateString());
                    dayAppointments.forEach((apt, aptIndex) => {
                        const startDate = new Date(apt.data_inicio);
                        const top = (startDate.getHours() + startDate.getMinutes() / 60 - startHour) * hourHeight;
                        const height = (60 / 60) * hourHeight - 2;
                        appointmentsHTML += `<div class="absolute w-[calc(100%-0.5rem)] ml-1" style="top: ${top}px; height: ${height}px;"><div class="appointment-item h-full p-1 rounded-md bg-primary/80 text-primary-foreground cursor-pointer hover:opacity-80 flex flex-col justify-center" data-appointment='${htmlEncode(JSON.stringify(apt))}'><p class="text-xs font-bold truncate px-1">${htmlEncode(apt.nome_cliente)}</p><p class="text-[10px] px-1">${formatTimestamp(apt.data_inicio)}</p></div></div>`;
                    });
                    appointmentsHTML += `</div>`;
                });
                appointmentsHTML += '</div>';

                body.innerHTML = `<div class="relative" style="height: ${(endHour - startHour + 1) * hourHeight}px"><div class="ml-12">${hourLinesHTML}</div>${appointmentsHTML}</div>`;
                body.querySelectorAll('.appointment-item').forEach(item => item.addEventListener('click', () => {
                    if (item.dataset.appointment) showAppointmentDetailsView(JSON.parse(item.dataset.appointment), '#agendamentos');
                }));
            }

            function renderDailyView() {
                const body = document.getElementById('daily-body');
                body.innerHTML = '';

                const startHour = 8,
                    endHour = 18,
                    hourHeight = 80;
                let hourLinesHTML = '';
                for (let hour = startHour; hour <= endHour; hour++) {
                    hourLinesHTML += `<div class="relative" style="height: ${hourHeight}px;"><div class="absolute left-0 -top-2.5 -ml-12 text-right w-10"><span class="text-xs text-muted-foreground">${hour}:00</span></div><div class="h-full border-t"></div></div>`;
                }

                let appointmentsHTML = '<div class="absolute inset-0 ml-12">';
                const dayAppointments = allAppointments.filter(apt => new Date(apt.data_inicio).toDateString() === currentDate.toDateString());
                dayAppointments.forEach((apt, aptIndex) => {
                    const startDate = new Date(apt.data_inicio);
                    const top = (startDate.getHours() + startDate.getMinutes() / 60 - startHour) * hourHeight;
                    const height = (60 / 60) * hourHeight - 4;
                    appointmentsHTML += `<div class="absolute w-[calc(100%-1rem)]" style="top: ${top}px; height: ${height}px; left: 1rem;"><div class="appointment-item h-full p-3 rounded-lg bg-primary/80 text-primary-foreground cursor-pointer hover:opacity-80 flex flex-col justify-center" data-appointment='${htmlEncode(JSON.stringify(apt))}'><p class="font-bold truncate">${htmlEncode(apt.nome_cliente)}</p><p class="text-sm">${formatTimestamp(apt.data_inicio)}</p></div></div>`;
                });
                appointmentsHTML += '</div>';

                body.innerHTML = `<div class="relative" style="height: ${(endHour - startHour + 1) * hourHeight}px"><div class="ml-12">${hourLinesHTML}</div>${appointmentsHTML}</div>`;
                body.querySelectorAll('.appointment-item').forEach(item => item.addEventListener('click', () => {
                    if (item.dataset.appointment) showAppointmentDetailsView(JSON.parse(item.dataset.appointment), '#agendamentos');
                }));
            }

            // -----------------------------------------------------------------------------
            // 9. SHADER/LOGIN ANIMATION
            // -----------------------------------------------------------------------------
            function initNeuralNetworkAnimation() {
                const container = document.getElementById('neural-network-canvas-container');
                 if (!container || !window.THREE) {
                    console.log("Container or Three.js not found for neural network animation.");
                    return;
                }

                if (neuralNetworkAnimationScene && neuralNetworkAnimationScene.renderer) {
                    if (container.contains(neuralNetworkAnimationScene.renderer.domElement)) {
                        container.removeChild(neuralNetworkAnimationScene.renderer.domElement);
                    }
                    neuralNetworkAnimationScene.renderer.dispose();
                }


                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.z = 1;

                const renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: false
                });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                container.appendChild(renderer.domElement);

                const vertexShader = `
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `;

                const fragmentShader = `
                    #ifdef GL_ES
                        precision lowp float;
                    #endif
                    uniform float iTime;
                    uniform vec2 iResolution;
                    varying vec2 vUv;
                    
                    vec4 buf[8];
                    
                    vec4 sigmoid(vec4 x) { return 1. / (1. + exp(-x)); }
                    
                    vec4 cppn_fn(vec2 coordinate, float in0, float in1, float in2) {
                        buf[6] = vec4(coordinate.x, coordinate.y, 0.3948333106474662 + in0, 0.36 + in1);
                        buf[7] = vec4(0.14 + in2, sqrt(coordinate.x * coordinate.x + coordinate.y * coordinate.y), 0., 0.);
                        buf[0]=mat4(vec4(6.5404263,-3.6126034,0.7590882,-1.13613),vec4(2.4582713,3.1660357,1.2219609,0.06276096),vec4(-5.478085,-6.159632,1.8701609,-4.7742867),vec4(6.039214,-5.542865,-0.90925294,3.251348))*buf[6]+mat4(vec4(0.8473259,-5.722911,3.975766,1.6522468),vec4(-0.24321538,0.5839259,-1.7661959,-5.350116),vec4(0.,0.,0.,0.),vec4(0.,0.,0.,0.))*buf[7]+vec4(0.21808943,1.1243913,-1.7969975,5.0294676);
                        buf[1]=mat4(vec4(-3.3522482,-6.0612736,0.55641043,-4.4719114),vec4(0.8631464,1.7432913,5.643898,1.6106541),vec4(2.4941394,-3.5012043,1.7184316,6.357333),vec4(3.310376,8.209261,1.1355612,-1.165539))*buf[6]+mat4(vec4(5.24046,-13.034365,0.009859298,15.870829),vec4(2.987511,3.129433,-0.89023495,-1.6822904),vec4(0.,0.,0.,0.),vec4(0.,0.,0.,0.))*buf[7]+vec4(-5.9457836,-6.573602,-0.8812491,1.5436668);
                        buf[0]=sigmoid(buf[0]);
                        buf[1]=sigmoid(buf[1]);
                        buf[2]=mat4(vec4(-15.219568,8.095543,-2.429353,-1.9381982),vec4(-5.951362,4.3115187,2.6393783,1.274315),vec4(-7.3145227,6.7297835,5.2473326,5.9411426),vec4(5.0796127,8.979051,-1.7278991,-1.158976))*buf[6]+mat4(vec4(-11.967154,-11.608155,6.1486754,11.237008),vec4(2.124141,-6.263192,-1.7050359,-0.7021966),vec4(0.,0.,0.,0.),vec4(0.,0.,0.,0.))*buf[7]+vec4(-4.17164,-3.2281182,-4.576417,-3.6401186);
                        buf[3]=mat4(vec4(3.1832156,-13.738922,1.879223,3.233465),vec4(0.64300746,12.768129,1.9141049,0.50990224),vec4(-0.049295485,4.4807224,1.4733979,1.801449),vec4(5.0039253,13.000481,3.3991797,-4.5561905))*buf[6]+mat4(vec4(-0.1285731,7.720628,-3.1425676,4.742367),vec4(0.6393625,3.714393,-0.8108378,-0.39174938),vec4(0.,0.,0.,0.),vec4(0.,0.,0.,0.))*buf[7]+vec4(-1.1811101,-21.621881,0.7851888,1.2329718);
                        buf[2]=sigmoid(buf[2]);
                        buf[3]=sigmoid(buf[3]);
                        buf[4]=mat4(vec4(5.214916,-7.183024,2.7228765,2.6592617),vec4(-5.601878,-25.3591,4.067988,0.4602802),vec4(-10.57759,24.286327,21.102104,37.546658),vec4(4.3024497,-1.9625226,2.3458803,-1.372816))*buf[0]+mat4(vec4(-17.6526,-10.507558,2.2587414,12.462782),vec4(6.265566,-502.75443,-12.642513,0.9112289),vec4(-10.983244,20.741234,-9.701768,-0.7635988),vec4(5.383626,1.4819539,-4.1911616,-4.8444734))*buf[1]+mat4(vec4(12.785233,-16.345072,-0.39901125,1.7955981),vec4(-30.48365,-1.8345358,1.4542528,-1.1118771),vec4(19.872723,-7.337935,-42.941723,-98.52709),vec4(8.337645,-2.7312303,-2.2927687,-36.142323))*buf[2]+mat4(vec4(-16.298317,3.5471997,-0.44300047,-9.444417),vec4(57.5077,-35.609753,16.163465,-4.1534753),vec4(-0.07470326,-3.8656476,-7.0901804,3.1523974),vec4(-12.559385,-7.077619,1.490437,-0.8211543))*buf[3]+vec4(-7.67914,15.927437,1.3207729,-1.6686112);
                        buf[5]=mat4(vec4(-1.4109162,-0.372762,-3.770383,-21.367174),vec4(-6.2103205,-9.35908,0.92529047,8.82561),vec4(11.460242,-22.348068,13.625772,-18.693201),vec4(-0.3429052,-3.9905605,-2.4626114,-0.45033523))*buf[0]+mat4(vec4(7.3481627,-4.3661838,-6.3037653,-3.868115),vec4(1.5462853,6.5488915,1.9701879,-0.58291394),vec4(6.5858274,-2.2180402,3.7127688,-1.3730392),vec4(-5.7973905,10.134961,-2.3395722,-5.965605))*buf[1]+mat4(vec4(-2.5132585,-6.6685553,-1.4029363,-0.16285264),vec4(-0.37908727,0.53738135,4.389061,-1.3024765),vec4(-0.70647055,2.0111287,-5.1659346,-3.728635),vec4(-13.562562,10.487719,-0.9173751,-2.6487076))*buf[2]+mat4(vec4(-8.645013,6.5546675,-6.3944063,-5.5933375),vec4(-0.57783127,-1.077275,36.91025,5.736769),vec4(14.283112,3.7146652,7.1452246,-4.5958776),vec4(2.7192075,3.6021907,-4.366337,-2.3653464))*buf[3]+vec4(-5.9000807,-4.329569,1.2427121,8.59503);
                        buf[4]=sigmoid(buf[4]);
                        buf[5]=sigmoid(buf[5]);
                        buf[6]=mat4(vec4(-1.61102,0.7970257,1.4675229,0.20917463),vec4(-28.793737,-7.1390953,1.5025433,4.656581),vec4(-10.94861,39.66238,0.74318546,-10.095605),vec4(-0.7229728,-1.5483948,0.7301322,2.1687684))*buf[0]+mat4(vec4(3.2547753,21.489103,-1.0194173,-3.3100595),vec4(-3.7316632,-3.3792162,-7.223193,-0.23685838),vec4(13.1804495,0.7916005,5.338587,5.687114),vec4(-4.167605,-17.798311,-6.815736,-1.6451967))*buf[1]+mat4(vec4(0.604885,-7.800309,-7.213122,-2.741014),vec4(-3.522382,-0.12359311,-0.5258442,0.43852118),vec4(9.6752825,-22.853785,2.062431,0.099892326),vec4(-4.3196306,-17.730087,2.5184598,5.30267))*buf[2]+mat4(vec4(-6.545563,-15.790176,-6.0438633,-5.415399),vec4(-43.591583,28.551912,-16.00161,18.84728),vec4(4.212382,8.394307,3.0958717,8.657522),vec4(-5.0237565,-4.450633,-4.4768,-5.5010443))*buf[3]+mat4(vec4(1.6985557,-67.05806,6.897715,1.9004834),vec4(1.8680354,2.3915145,2.5231109,4.081538),vec4(11.158006,1.7294737,2.0738268,7.386411),vec4(-4.256034,-306.24686,8.258898,-17.132736))*buf[4]+mat4(vec4(1.6889864,-4.5852966,3.8534803,-6.3482175),vec4(1.3543309,-1.2640043,9.932754,2.9079645),vec4(-5.2770967,0.07150358,-0.13962056,3.3269649),vec4(28.34703,-4.918278,6.1044083,4.085355))*buf[5]+vec4(6.6818056,12.522166,-3.7075126,-4.104386);
                        buf[7]=mat4(vec4(-8.265602,-4.7027016,5.098234,0.7509808),vec4(8.6507845,-17.15949,16.51939,-8.884479),vec4(-4.036479,-2.3946867,-2.6055532,-1.9866527),vec4(-2.2167742,-1.8135649,-5.9759874,4.8846445))*buf[0]+mat4(vec4(6.7790847,3.5076547,-2.8191125,-2.7028968),vec4(-5.743024,-0.27844876,1.4958696,-5.0517144),vec4(13.122226,15.735168,-2.9397483,-4.101023),vec4(-14.375265,-5.030483,-6.2599335,2.9848232))*buf[1]+mat4(vec4(4.0950394,-0.94011575,-5.674733,4.755022),vec4(4.3809423,4.8310084,1.7425908,-3.437416),vec4(2.117492,0.16342592,-104.56341,16.949184),vec4(-5.22543,-2.994248,3.8350096,-1.9364246))*buf[2]+mat4(vec4(-5.900337,1.7946124,-13.604192,-3.8060522),vec4(6.6583457,31.911177,25.164474,91.81147),vec4(11.840538,4.1503043,-0.7314397,6.768467),vec4(-6.3967767,4.034772,6.1714606,-0.32874924))*buf[3]+mat4(vec4(3.4992442,-196.91893,-8.923708,2.8142626),vec4(3.4806502,-3.1846354,5.1725626,5.1804223),vec4(-2.4009497,15.585794,1.2863957,2.0252278),vec4(-71.25271,-62.441242,-8.138444,0.50670296))*buf[4]+mat4(vec4(-12.291733,-11.176166,-7.3474145,4.390294),vec4(10.805477,5.6337385,-0.9385842,-4.7348723),vec4(-12.869276,-7.039391,5.3029537,7.5436664),vec4(1.4593618,8.91898,3.5101583,5.840625))*buf[5]+vec4(2.2415268,-6.705987,-0.98861027,-2.117676);
                        buf[6]=sigmoid(buf[6]);
                        buf[7]=sigmoid(buf[7]);
                        buf[0]=mat4(vec4(1.6794263,1.3817469,2.9625452,0.),vec4(-1.8834411,-1.4806935,-3.5924516,0.),vec4(-1.3279216,-1.0918057,-2.3124623,0.),vec4(0.2662234,0.23235129,0.44178495,0.))*buf[0]+mat4(vec4(-0.6299101,-0.5945583,-0.9125601,0.),vec4(0.17828953,0.18300213,0.18182953,0.),vec4(-2.96544,-2.5819945,-4.9001055,0.),vec4(1.4195864,1.1868085,2.5176322,0.))*buf[1]+mat4(vec4(-1.2584374,-1.0552157,-2.1688404,0.),vec4(-0.7200217,-0.52666044,-1.438251,0.),vec4(0.15345335,0.15196142,0.272854,0.),vec4(0.945728,0.8861938,1.2766753,0.))*buf[2]+mat4(vec4(-2.4218085,-1.968602,-4.35166,0.),vec4(-22.683098,-18.0544,-41.954372,0.),vec4(0.63792,0.5470648,1.1078634,0.),vec4(-1.5489894,-1.3075932,-2.6444845,0.))*buf[3]+mat4(vec4(-0.49252132,-0.39877754,-0.91366625,0.),vec4(0.95609266,0.7923952,1.640221,0.),vec4(0.30616966,0.15693925,0.8639857,0.),vec4(1.1825981,0.94504964,2.176963,0.))*buf[4]+mat4(vec4(0.35446745,0.3293795,0.59547555,0.),vec4(-0.58784515,-0.48177817,-1.0614829,0.),vec4(2.5271258,1.9991658,4.6846647,0.),vec4(0.13042648,0.08864098,0.30187556,0.))*buf[5]+mat4(vec4(-1.7718065,-1.4033192,-3.3355875,0.),vec4(3.1664357,2.638297,5.378702,0.),vec4(-3.1724713,-2.6107926,-5.549295,0.),vec4(-2.851368,-2.249092,-5.3013067,0.))*buf[6]+mat4(vec4(1.5203838,1.2212278,2.8404984,0.),vec4(1.5210563,1.2651345,2.683903,0.),vec4(2.9789467,2.4364579,5.2347264,0.),vec4(2.2270417,1.8825914,3.8028636,0.))*buf[7]+vec4(-1.5468478,-3.6171484,0.24762098,0.);
                        buf[0] = sigmoid(buf[0]);
                        return vec4(buf[0].x, buf[0].y, buf[0].z, 1.0);
                    }
                    
                    void main() {
                        vec2 uv = vUv * 2.0 - 1.0; uv.y *= -1.0;
                        vec4 original_color = cppn_fn(uv, 0.1 * sin(0.3 * iTime), 0.1 * sin(0.69 * iTime), 0.1 * sin(0.44 * iTime));
                        vec3 gold_color = vec3(1.0, 0.75, 0.1);
                        float luminance = dot(original_color.rgb, vec3(0.299, 0.587, 0.114));
                        vec3 final_color = gold_color * luminance;
                        gl_FragColor = vec4(final_color, 1.0);
                    }
                `;

                const uniforms = {
                    iTime: {
                        value: 0
                    },
                    iResolution: {
                        value: new THREE.Vector2(container.clientWidth, container.clientHeight)
                    },
                };

                const material = new THREE.ShaderMaterial({
                    uniforms: uniforms,
                    vertexShader,
                    fragmentShader,
                });

                const plane = new THREE.Mesh(new THREE.PlaneGeometry(4, 4), material);
                plane.position.set(0, -0.75, -0.5);
                scene.add(plane);

                let animationId;
                const clock = new THREE.Clock();

                function animate() {
                    animationId = requestAnimationFrame(animate);
                    uniforms.iTime.value = clock.getElapsedTime();
                    renderer.render(scene, camera);
                     if (neuralNetworkAnimationScene) {
                        neuralNetworkAnimationScene.animationId = animationId;
                    }
                }

                function onWindowResize() {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                    uniforms.iResolution.value.set(container.clientWidth, container.clientHeight);
                }

                window.addEventListener('resize', onWindowResize, false);
                
                neuralNetworkAnimationScene = { renderer, animationId: 0, removeListeners: () => window.removeEventListener("resize", onWindowResize) };
                animate();
            }

            // -----------------------------------------------------------------------------
            // 10. FUNCIONALIDADE: CONFIGURAÇÕES
            // -----------------------------------------------------------------------------

            const handleChangePassword = async (event) => {
                event.preventDefault();
                const msgEl = document.getElementById('password-change-message');
                msgEl.textContent = '';
                msgEl.className = 'text-sm h-5';

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (newPassword !== confirmPassword) {
                    msgEl.textContent = 'As novas senhas não coincidem.';
                    msgEl.classList.add('text-red-500');
                    return;
                }
                if (newPassword.length < 6) {
                    msgEl.textContent = 'A nova senha deve ter no mínimo 6 caracteres.';
                    msgEl.classList.add('text-red-500');
                    return;
                }

                const sessionData = JSON.parse(localStorage.getItem('clinicSession') || sessionStorage.getItem('clinicSession'));
                if (sessionData.senha !== currentPassword) {
                    msgEl.textContent = 'A senha atual está incorreta.';
                    msgEl.classList.add('text-red-500');
                    return;
                }

                const {
                    error
                } = await supabase.from('usuarios_site').update({
                    senha: newPassword
                }).eq('email', sessionData.email);

                if (error) {
                    msgEl.textContent = 'Erro ao atualizar a senha. Tente novamente.';
                    msgEl.classList.add('text-red-500');
                } else {
                    msgEl.textContent = 'Senha alterada com sucesso!';
                    msgEl.classList.add('text-green-500');
                    sessionData.senha = newPassword;
                    const storage = localStorage.getItem('clinicSession') ? localStorage : sessionStorage;
                    storage.setItem('clinicSession', JSON.stringify(sessionData));
                    document.getElementById('password-change-form').reset();
                }
            };


            // -----------------------------------------------------------------------------
            // 11. UTILITÁRIOS E FUNÇÕES AUXILIARES
            // -----------------------------------------------------------------------------
            const timeAgo = (date) => {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " anos atrás";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " meses atrás";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " dias atrás";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " horas atrás";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutos atrás";
                return Math.floor(seconds) + " segundos atrás";
            };
            const htmlEncode = (str) => typeof str !== 'string' ? '' : str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const getInitials = (name) => {
                if (!name) return '??';
                const cleanName = name.split('@')[0].replace(/[^a-zA-Z\s]/g, '').trim();
                if (!cleanName) return '??';
                const parts = cleanName.split(/\s+/);
                if (parts.length > 1) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                return parts[0].length > 1 ? parts[0].substring(0, 2).toUpperCase() : parts[0].toUpperCase();
            };
            const calculateAge = (birthdate) => {
                if (!birthdate) return null;
                try {
                    const birthDate = new Date(birthdate);
                    const ageDifMs = Date.now() - birthDate.getTime();
                    const ageDate = new Date(ageDifMs);
                    return Math.abs(ageDate.getUTCFullYear() - 1970);
                } catch (e) {
                    return null;
                }
            };
            const formatTimestamp = (iso, isUserMessage = false) => {
                if (!iso) return '';
                const date = new Date(iso);
                if (isUserMessage) {
                    date.setHours(date.getHours() + 3);
                }
                return date.toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            const togglePasswordVisibility = () => {
                const passwordInput = document.getElementById('password-input');
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                passwordToggle.querySelector('.eye-off').classList.toggle('hidden', isPassword);
                passwordToggle.querySelector('.eye').classList.toggle('hidden', !isPassword);
            };
            const formatSummary = (text) => {
                if (!text || typeof text !== 'string') {
                    return '<p class="text-muted-foreground">Resumo indisponível.</p>';
                }
                // Escapa HTML, depois aplica formatação
                const escapedText = htmlEncode(text);
                const formattedText = escapedText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Negrito para **texto**
                    .replace(/\n/g, '<br>'); // Novas linhas
                return `<div class="prose prose-sm dark:prose-invert max-w-none">${formattedText}</div>`;
            };

            // -----------------------------------------------------------------------------
            // 12. EVENT LISTENERS & UI LOGIC
            // -----------------------------------------------------------------------------

            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const navTexts = appSidebar.querySelectorAll('.nav-text');

            const expandSidebar = () => {
                if (window.innerWidth < 1024) return;
                appSidebar.classList.remove('lg:w-20');
                appSidebar.classList.add('w-64');
                mainContentWrapper.classList.remove('lg:pl-20');
                mainContentWrapper.classList.add('lg:pl-64');
                navTexts.forEach(text => text.classList.remove('hidden'));
            };

            const collapseSidebar = () => {
                if (window.innerWidth < 1024) return;
                appSidebar.classList.remove('w-64');
                appSidebar.classList.add('lg:w-20');
                mainContentWrapper.classList.remove('lg:pl-64');
                mainContentWrapper.classList.add('lg:pl-20');
                navTexts.forEach(text => text.classList.add('hidden'));
            };
            
            const updateFloatingNavIndicator = () => {
                const container = document.getElementById('mobile-nav-container');
                const indicator = document.getElementById('mobile-nav-indicator');
                if (!container || !indicator) return;

                let currentHash = (window.location.hash || '#dashboard').split('-')[0];
                if (currentHash === '#client') {
                    currentHash = '#clientes'; 
                }
                const activeItem = container.querySelector(`a[href="${currentHash}"]`);
                
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    item.classList.remove('text-primary');
                    item.classList.add('text-muted-foreground');
                });

                if (activeItem) {
                    const containerRect = container.getBoundingClientRect();
                    const itemRect = activeItem.getBoundingClientRect();
                    indicator.style.width = `${itemRect.width}px`;
                    indicator.style.left = `${itemRect.left - containerRect.left}px`;
                    activeItem.classList.add('text-primary');
                    activeItem.classList.remove('text-muted-foreground');
                } else {
                     // If no link is active (e.g. profile button), hide indicator
                     indicator.style.width = '0px';
                }
            };
            
            const initializeFloatingNav = () => {
                 window.addEventListener('resize', updateFloatingNavIndicator);
                 window.addEventListener('hashchange', updateFloatingNavIndicator);
                 updateFloatingNavIndicator(); // Initial call
            };


            appSidebar.addEventListener('mouseenter', expandSidebar);
            appSidebar.addEventListener('mouseleave', collapseSidebar);
            if (window.innerWidth >= 1024) {
                collapseSidebar();
            }


            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('logout-link').addEventListener('click', (e) => {
                e.preventDefault();
                showLogin();
            });
            passwordToggle.addEventListener('click', togglePasswordVisibility);
            document.getElementById('password-change-form').addEventListener('submit', handleChangePassword);

            window.addEventListener('hashchange', () => showSection(window.location.hash));

            const handleNavClick = (e) => {
                const link = e.target.closest('a');
                if (link && link.hash) {
                    e.preventDefault();
                    window.location.hash = link.hash;
                    if (window.innerWidth < 768) { 
                        appSidebar.classList.add('hidden');
                        mobileMenuOverlay.classList.add('hidden');
                    }
                }
            };

            navLinks.addEventListener('click', handleNavClick);
            
            document.getElementById('new-mobile-nav').addEventListener('click', (e) => {
                 const link = e.target.closest('a');
                 if (link && link.hash) {
                    e.preventDefault();
                    window.location.hash = link.hash;
                 }
            });


            document.getElementById('user-profile-link-wrapper').addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link && link.hash) {
                    e.preventDefault();
                    window.location.hash = link.hash;
                }
            });

            mobileMenuButton.addEventListener('click', () => {
                appSidebar.classList.remove('hidden'); // Ensure it's visible for mobile
                appSidebar.classList.remove('lg:w-20');
                appSidebar.classList.add('w-64');
                navTexts.forEach(text => text.classList.remove('hidden'));
                mobileMenuOverlay.classList.remove('hidden');
            });
            mobileMenuOverlay.addEventListener('click', () => {
                appSidebar.classList.add('hidden');
                mobileMenuOverlay.classList.add('hidden');
            });


            const agendaSection = document.getElementById('agendamentos-section');
            if (agendaSection) {
                agendaSection.addEventListener('click', (e) => {
                    if (e.target.closest('#today-btn')) {
                        currentDate = new Date();
                        fetchAndRenderAgenda();
                    }
                    if (e.target.closest('#prev-week-btn')) {
                         currentDate.setDate(currentDate.getDate() - 7);
                        fetchAndRenderAgenda();
                    }
                    if (e.target.closest('#next-week-btn')) {
                        currentDate.setDate(currentDate.getDate() + 7);
                        fetchAndRenderAgenda();
                    }
                    if (e.target.matches('.view-toggle-btn')) {
                        currentCalendarView = e.target.dataset.view;
                        renderAgendaView();
                    }
                });
            }


            const newChatInput = document.getElementById('new-chat-input');
            const newSendButton = document.getElementById('new-send-button');

            if (newSendButton) newSendButton.addEventListener('click', sendMessage);
            if (newChatInput) newChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            const chatSearchInput = document.getElementById('chat-search-input');
            if (chatSearchInput) {
                chatSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredChats = currentChats.filter(chat => chat.nomewpp.toLowerCase().includes(searchTerm) || chat.phone.includes(searchTerm));
                    renderChatList(filteredChats);
                });
            }

            const clientSearchInput = document.getElementById('client-search-input');
            if (clientSearchInput) {
                clientSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredClients = allClients.filter(client => client.nomewpp.toLowerCase().includes(searchTerm) || client.telefone.includes(searchTerm));
                    renderClientList(filteredClients);
                });
            }
            
            // --- EFEITOS DO NOVO LOGIN ---
            const loginFormContainer = document.getElementById('login-form-container');
            const gradientBlob = document.getElementById('gradient-blob');

            loginFormContainer.addEventListener('mousemove', (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                gradientBlob.style.transform = `translate(${x - 250}px, ${y - 250}px)`;
            });

            loginFormContainer.addEventListener('mouseenter', () => {
                gradientBlob.style.opacity = '1';
            });

            loginFormContainer.addEventListener('mouseleave', () => {
                gradientBlob.style.opacity = '0';
            });
            
            document.querySelectorAll('.animated-input-wrapper').forEach(wrapper => {
                const input = wrapper.querySelector('input');
                const glowTop = wrapper.querySelector('.input-glow-top');
                const glowBottom = wrapper.querySelector('.input-glow-bottom');

                wrapper.addEventListener('mousemove', (e) => {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    glowTop.style.background = `radial-gradient(30px circle at ${x}px 0px, hsl(var(--primary)) 0%, transparent 70%)`;
                    glowBottom.style.background = `radial-gradient(30px circle at ${x}px 2px, hsl(var(--primary)) 0%, transparent 70%)`;
                });

                 wrapper.addEventListener('mouseleave', () => {
                    glowTop.style.background = 'none';
                    glowBottom.style.background = 'none';
                 });
            });

            // --- LÓGICA DO MODAL DE PERFIL MOBILE ---
            const mobileProfileTrigger = document.getElementById('mobile-profile-trigger');
            const mobileProfileModal = document.getElementById('mobile-profile-modal');
            const mobileProfileModalContent = document.getElementById('mobile-profile-modal-content');
            const closeModalButton = document.getElementById('mobile-profile-modal-close');
            const modalLogoutLink = document.getElementById('modal-logout-link');
            const modalSettingsLink = document.getElementById('modal-settings-link');

            if (mobileProfileTrigger) {
                mobileProfileTrigger.addEventListener('click', () => {
                    document.getElementById('user-avatar-modal').src = document.getElementById('user-avatar-header').src;
                    document.getElementById('user-name-modal').textContent = document.getElementById('user-name-header').textContent;
                    document.getElementById('user-role-modal').textContent = document.getElementById('user-role-header').textContent;
                    
                    mobileProfileModal.classList.remove('hidden');
                    mobileProfileModal.classList.add('flex');
                    setTimeout(() => {
                        mobileProfileModalContent.classList.remove('translate-y-full');
                    }, 10);
                });

                const closeModal = () => {
                    mobileProfileModalContent.classList.add('translate-y-full');
                    setTimeout(() => {
                        mobileProfileModal.classList.add('hidden');
                        mobileProfileModal.classList.remove('flex');
                    }, 300);
                };
                
                closeModalButton.addEventListener('click', closeModal);
                mobileProfileModal.addEventListener('click', (e) => {
                    if (e.target === mobileProfileModal) closeModal();
                });
                modalLogoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    closeModal();
                    setTimeout(showLogin, 350); 
                });
                modalSettingsLink.addEventListener('click', () => {
                    closeModal();
                });
            }


            // -----------------------------------------------------------------------------
            // 13. INICIALIZAÇÃO DA APLICAÇÃO
            // -----------------------------------------------------------------------------

            initializeCharts();
            renderThemeToggle();
            initializeFloatingNav();
            checkSession();
        });
    </script>
</body>

</html>