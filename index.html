<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Clientes - CRM Elegance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: 'hsl(var(--border))',
                        input: 'hsl(var(--input))',
                        ring: 'hsl(var(--ring))',
                        background: 'hsl(var(--background))',
                        foreground: 'hsl(var(--foreground))',
                        primary: {
                            DEFAULT: 'hsl(var(--primary))',
                            foreground: 'hsl(var(--primary-foreground))',
                        },
                        secondary: {
                            DEFAULT: 'hsl(var(--secondary))',
                            foreground: 'hsl(var(--secondary-foreground))',
                        },
                        destructive: {
                            DEFAULT: 'hsl(var(--destructive))',
                            foreground: 'hsl(var(--destructive-foreground))',
                        },
                        muted: {
                            DEFAULT: 'hsl(var(--muted))',
                            foreground: 'hsl(var(--muted-foreground))',
                        },
                        accent: {
                            DEFAULT: 'hsl(var(--accent))',
                            foreground: 'hsl(var(--accent-foreground))',
                        },
                        popover: {
                            DEFAULT: 'hsl(var(--popover))',
                            foreground: 'hsl(var(--popover-foreground))',
                        },
                        card: {
                            DEFAULT: 'hsl(var(--card))',
                            foreground: 'hsl(var(--card-foreground))',
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        @layer base {
             :root {
                --background: 0 0% 100%;
                --foreground: 0 0% 15%;
                --card: 0 0% 100%;
                --card-foreground: 0 0% 15%;
                --popover: 0 0% 100%;
                --popover-foreground: 0 0% 15%;
                --primary: 39 92% 51%;
                --primary-foreground: 0 0% 0%;
                --secondary: 220 14% 96%;
                --secondary-foreground: 215 15% 34%;
                --muted: 220 17% 98%;
                --muted-foreground: 215 14% 47%;
                --accent: 51 100% 96%;
                --accent-foreground: 26 84% 31%;
                --destructive: 0 84% 60%;
                --destructive-foreground: 0 0% 100%;
                --border: 220 13% 91%;
                --input: 220 13% 91%;
                --ring: 39 92% 51%;
                --radius: 0.375rem;
            }

            .dark {
                --background: 0 0% 0%;
                --foreground: 0 0% 100%;
                --card: 0 0% 8%;
                --card-foreground: 0 0% 100%;
                --popover: 0 0% 15%;
                --popover-foreground: 0 0% 100%;
                --primary: 39 92% 51%;
                --primary-foreground: 0 0% 0%;
                --secondary: 0 0% 15%;
                --secondary-foreground: 0 0% 100%;
                --muted: 0 0% 15%;
                --muted-foreground: 0 0% 80%;
                --accent: 26 84% 31%;
                --accent-foreground: 46 95% 76%;
                --destructive: 0 84% 60%;
                --destructive-foreground: 0 0% 100%;
                --border: 0 0% 25%;
                --input: 0 0% 25%;
                --ring: 39 92% 51%;
            }
        }

        @layer base {
            * {
                @apply border-border;
            }

            body {
                @apply bg-background text-foreground;
                font-family: 'Manrope', sans-serif;
            }
            
             .active-chat-indicator::before {
                content: '';
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 4px;
                height: 60%;
                background-color: hsl(var(--primary));
                border-radius: 0 4px 4px 0;
            }
             .nav-link.active {
                background-color: hsl(var(--primary) / 0.1);
                color: hsl(var(--primary));
                font-weight: 600;
            }
             .nav-link.active svg {
                 color: hsl(var(--primary));
             }

            .dark .nav-link:not(.active) span {
                color: hsl(0 0% 90%);
            }
             .dark .nav-link:not(.active) svg {
                color: hsl(0 0% 90%);
            }
            .dark .nav-link:not(.active):hover span,
            .dark .nav-link:not(.active):hover svg {
                 color: hsl(var(--primary));
            }

            .light .dashboard-card {
                background-color: hsl(var(--secondary));
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            }

             .material-symbols-outlined {
                font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
            }
            
            #mobile-bottom-nav .nav-link.active {
                color: hsl(var(--primary));
            }
            #mobile-bottom-nav .nav-link.active .material-symbols-outlined {
                font-variation-settings: 'FILL' 1;
            }

        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            @apply bg-border rounded-full;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: hsl(var(--primary) / 0.8);
        }
        
        #new-chat-input:focus {
            outline: none;
            box-shadow: none;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="antialiased">

    <div id="mobile-menu-overlay" class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm hidden"></div>

    <!-- Seção de Login Aprimorada -->
    <section id="auth-section" class="min-h-screen w-full bg-background flex flex-col md:flex-row">
        <!-- Coluna da Esquerda (Formulário) -->
        <div class="flex-1 flex items-center justify-center p-8">
            <div class="w-full max-w-md">
                <div class="flex flex-col gap-6">
                    <h1 class="text-4xl md:text-5xl font-semibold leading-tight tracking-tighter">Bem-vindo(a)</h1>
                    <p class="text-muted-foreground">Acesse sua conta para continuar.</p>

                    <form class="space-y-5" id="login-form">
                        <div>
                            <label class="text-sm font-medium text-muted-foreground">Endereço de E-mail</label>
                            <div class="rounded-2xl border bg-foreground/5 backdrop-blur-sm transition-colors focus-within:border-primary/70 focus-within:bg-primary/10">
                                <input id="email-input" name="email" type="email" placeholder="Digite seu e-mail" class="w-full bg-transparent text-sm p-4 rounded-2xl focus:outline-none" />
                            </div>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-muted-foreground">Senha</label>
                             <div class="rounded-2xl border bg-foreground/5 backdrop-blur-sm transition-colors focus-within:border-primary/70 focus-within:bg-primary/10">
                                <div class="relative">
                                    <input id="password-input" name="password" type="password" placeholder="Digite sua senha" class="w-full bg-transparent text-sm p-4 pr-12 rounded-2xl focus:outline-none" />
                                    <button type="button" id="password-toggle" class="absolute inset-y-0 right-3 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-muted-foreground hover:text-foreground transition-colors eye-off"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-muted-foreground hover:text-foreground transition-colors eye hidden"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between text-sm">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="remember-me-checkbox" name="rememberMe" class="h-4 w-4 rounded border-border text-primary focus:ring-primary" />
                                <span class="text-foreground/90">Manter conectado</span>
                            </label>
                            <a href="#" class="hover:underline text-primary/90 transition-colors">Esqueceu a senha?</a>
                        </div>
                         <div id="login-error" class="text-red-500 text-sm text-center h-5"></div>
                        <button type="submit" class="w-full rounded-2xl bg-primary py-4 font-medium text-primary-foreground hover:bg-primary/90 transition-colors">
                            Entrar
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <!-- Coluna da Direita (Animação) -->
        <div class="hidden md:block flex-1 relative">
             <div id="shader-container" class="absolute inset-0"></div>
        </div>
    </section>

    <!-- App Principal -->
    <div id="app" class="h-screen w-full flex hidden">
        <!-- Sidebar -->
        <aside id="app-sidebar"
            class="w-64 lg:w-20 border-r bg-card flex-col fixed inset-y-0 z-50 h-full hidden md:flex transition-all duration-300 ease-in-out overflow-hidden">
            <div class="flex flex-col h-full">
                <!-- Top Part: Logo & Nav -->
                <div class="flex-1 flex flex-col overflow-y-auto overflow-x-hidden">
                    <div class="flex h-16 items-center px-6 shrink-0 border-b">
                         <a class="flex items-center gap-2 font-semibold text-foreground" href="#dashboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="h-6 w-6 text-primary shrink-0">
                                <path
                                    d="M12.4 2.7c.9-1.4 2.3-1.4 3.2 0l6.4 10.5c.9 1.4.2 3.3-1.6 3.3H3.6c-1.8 0-2.5-1.9-1.6-3.3l6.4-10.5Z" />
                            </svg>
                            <span class="nav-text font-semibold whitespace-pre hidden">CRM Elegance</span>
                        </a>
                    </div>
                    <nav id="nav-links" class="flex-1 px-4 py-4 space-y-2">
                        <a href="#dashboard" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                            <span class="nav-text whitespace-pre hidden">Dashboard</span>
                        </a>
                        <a href="#funil" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4s1.8-1.7 1.8-3c0-1.5-1.1-2.8-2.6-3.2-.2-1.2-1.3-2.3-2.8-2.3z"/></svg>
                            <span class="nav-text whitespace-pre hidden">Funil</span>
                        </a>
                        <a href="#conversas" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><path d="M17 6.1H3" /><path d="M21 12.1H3" /><path d="M15.1 18H3" /></svg>
                            <span class="nav-text whitespace-pre hidden">Conversas</span>
                        </a>
                        <a href="#agendamentos" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>
                            <span class="nav-text whitespace-pre hidden">Agendamentos</span>
                        </a>
                        <a href="#clientes" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>
                            <span class="nav-text whitespace-pre hidden">Clientes</span>
                        </a>
                        <a href="#automacoes" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" /><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" /><path d="M12 2v2" /><path d="M12 22v-2" /><path d="m17 20.66-1-1.73" /><path d="M11 10.27 7 3.34" /><path d="m20.66 17-1.73-1" /><path d="m3.34 7 1.73 1" /><path d="M14 12h8" /><path d="M2 12h2" /><path d="m20.66 7-1.73 1" /><path d="m3.34 17 1.73-1" /><path d="m17 3.34-1 1.73" /><path d="m11 13.73-4 6.93" /></svg>
                            <span class="nav-text whitespace-pre hidden">Automações</span>
                        </a>
                    </nav>
                </div>
                <!-- Bottom Part: Profile & Settings -->
                <div class="p-4 border-t">
                    <nav class="space-y-2">
                        <a href="#configuracoes" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-primary/5 hover:text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>
                            <span class="nav-text whitespace-pre hidden">Configurações</span>
                        </a>
                        <a id="logout-link" href="#" class="nav-link flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground transition-all hover:bg-destructive/10 hover:text-destructive">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 shrink-0"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                            <span class="nav-text whitespace-pre hidden">Sair</span>
                        </a>
                    </nav>
                    <div class="mt-4 pt-4 border-t">
                        <a href="#configuracoes" id="user-profile-link-wrapper" class="flex items-center gap-3 rounded-lg p-2 -ml-2 hover:bg-muted">
                            <img id="user-avatar-header" alt="Avatar" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border shrink-0"/>
                            <div class="text-sm text-left overflow-hidden">
                                <p class="nav-text font-semibold whitespace-pre hidden" id="user-name-header">Admin</p>
                                <p class="nav-text text-muted-foreground text-xs whitespace-pre hidden" id="user-role-header">Admin</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div id="main-content-wrapper" class="flex flex-col flex-1 md:pl-20 transition-all duration-300 ease-in-out">
            <main id="main-content" class="relative flex-1 bg-background overflow-y-auto pb-16 md:pb-0">
                 <div class="absolute top-6 right-6 z-50 flex items-center gap-4">
                     <div id="theme-toggle-container"></div>
                     <button id="mobile-menu-button" class="md:hidden p-2 rounded-md hover:bg-muted text-foreground">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                     </button>
                 </div>

                 <!-- Seção Dashboard -->
                 <section id="dashboard-section" class="page-section hidden p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Dashboard</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <!-- Stats -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                                <div class="dashboard-card flex flex-col gap-2 rounded-xl p-6 bg-card">
                                    <p class="text-muted-foreground text-base font-medium">Faturamento Mensal</p>
                                    <p id="faturamento-mensal-stat" class="text-foreground tracking-light text-2xl font-bold">R$ 0k</p>
                                    <p class="text-green-500 text-base font-medium">+0%</p>
                                </div>
                                <div class="dashboard-card flex flex-col gap-2 rounded-xl p-6 bg-card">
                                    <p class="text-muted-foreground text-base font-medium">Novos Pacientes</p>
                                    <p id="novos-pacientes-stat" class="text-foreground tracking-light text-2xl font-bold">0</p>
                                    <p class="text-green-500 text-base font-medium">+0</p>
                                </div>
                                <div class="dashboard-card flex flex-col gap-2 rounded-xl p-6 bg-card">
                                    <p class="text-muted-foreground text-base font-medium">Agendamentos Hoje</p>
                                    <p id="consultas-para-hoje-stat" class="text-foreground tracking-light text-2xl font-bold">0</p>
                                    <p class="text-red-500 text-base font-medium">--</p>
                                </div>
                                <div class="dashboard-card flex flex-col gap-2 rounded-xl p-6 bg-card">
                                    <p class="text-muted-foreground text-base font-medium">Taxa de Conversão</p>
                                    <p id="taxa-conversao-stat" class="text-foreground tracking-light text-2xl font-bold">0%</p>
                                    <p class="text-green-500 text-base font-medium">+0%</p>
                                </div>
                            </div>
                            <!-- Charts -->
                            <div class="dashboard-card bg-card rounded-xl p-6">
                                <div class="flex flex-col gap-2">
                                    <p class="text-foreground text-base font-medium">Visão Geral de Vendas</p>
                                    <p id="vendas-geral-stat" class="text-foreground tracking-light text-[32px] font-bold leading-tight truncate">R$ 0k</p>
                                    <div class="flex gap-1">
                                        <p class="text-muted-foreground text-base font-normal">Anual</p>
                                        <p class="text-green-500 text-base font-medium">+0%</p>
                                    </div>
                                    <div class="h-[220px] pt-4">
                                        <canvas id="consultasChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="dashboard-card bg-card rounded-xl p-6">
                                    <p class="text-foreground text-base font-medium">Origem dos Clientes</p>
                                    <div class="flex items-center justify-center min-h-[180px] py-4">
                                        <div class="relative w-48 h-48">
                                            <canvas id="conversionChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div id="servicos-procurados-container" class="dashboard-card bg-card rounded-xl p-6">
                                    <p class="text-foreground text-base font-medium leading-normal mb-4">Serviços Mais Procurados</p>
                                    <!-- Progress bars will be rendered here by JS -->
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-1 space-y-8">
                            <div class="dashboard-card bg-card rounded-xl p-6">
                                <h3 class="text-foreground text-base font-medium mb-4">Próximos Agendamentos</h3>
                                <div id="recent-appointments-list" class="space-y-4">
                                    <!-- Appointments will be rendered here by JS -->
                                </div>
                            </div>
                            <div class="dashboard-card bg-card rounded-xl p-6">
                                <h3 class="text-foreground text-base font-medium mb-4">Atividades Recentes</h3>
                                <div id="recent-activities-list" class="space-y-4">
                                     <!-- Atividades serão inseridas aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Funil -->
                <section id="funil-section" class="page-section hidden h-full p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Funil de Vendas</h1>
                    <div class="flex flex-col h-full">
                        <div class="flex-grow flex gap-4 overflow-x-auto pb-4">
                            <!-- Coluna -->
                            <div class="w-72 md:w-80 flex-shrink-0">
                                <div class="flex justify-between items-center p-2 mb-2">
                                    <h3 class="font-semibold">Lead <span
                                            class="text-sm font-normal text-muted-foreground">(Em
                                            breve)</span></h3>
                                </div>
                                <div class="space-y-3 p-1 h-full bg-muted/50 rounded-lg">
                                    <div
                                        class="rounded-lg border bg-card text-card-foreground shadow-sm p-3 cursor-grab active:cursor-grabbing">
                                        <p class="font-semibold text-sm">Maria Silva</p>
                                        <p class="text-xs text-muted-foreground mt-1">Interessada em consulta de
                                            avaliação</p>
                                        <div class="mt-2"><span
                                                class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground">Potencial</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Coluna -->
                            <div class="w-72 md:w-80 flex-shrink-0">
                                <div class="flex justify-between items-center p-2 mb-2">
                                    <h3 class="font-semibold">Contato Inicial <span
                                            class="text-sm font-normal text-muted-foreground">(Em
                                            breve)</span></h3>
                                </div>
                                <div class="space-y-3 p-1 h-full bg-muted/50 rounded-lg">
                                    <div
                                        class="rounded-lg border bg-card text-card-foreground shadow-sm p-3 cursor-grab active:cursor-grabbing">
                                        <p class="font-semibold text-sm">João Pereira</p>
                                        <p class="text-xs text-muted-foreground mt-1">Agendou primeira consulta</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Coluna -->
                            <div class="w-72 md:w-80 flex-shrink-0">
                                <div class="flex justify-between items-center p-2 mb-2">
                                    <h3 class="font-semibold">Negociação</h3>
                                </div>
                                <div class="p-1 h-full bg-muted/50 rounded-lg"></div>
                            </div>
                            <!-- Coluna -->
                            <div class="w-72 md:w-80 flex-shrink-0">
                                <div class="flex justify-between items-center p-2 mb-2">
                                    <h3 class="font-semibold">Fechado</h3>
                                </div>
                                <div class="p-1 h-full bg-muted/50 rounded-lg"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Conversas -->
                <section id="conversas-section" class="page-section hidden h-full">
                     <div class="flex h-full w-full">
                         <!-- Coluna da Lista de Conversas -->
                        <aside id="chat-list-column" class="w-full md:w-[360px] bg-card flex flex-col border-r">
                            <div class="p-4">
                                <h1 class="text-2xl font-bold text-foreground mb-4 pt-12 md:pt-0">Conversas</h1>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">search</span>
                                    <input id="chat-search-input" class="w-full bg-muted border-none rounded-lg h-12 pl-10 pr-4 text-foreground placeholder:text-muted-foreground focus:ring-2 focus:ring-primary" placeholder="Pesquisar por cliente..." type="text"/>
                                </div>
                            </div>
                            <nav class="flex-1 overflow-y-auto">
                                <ul id="chat-list-container" class="p-2 space-y-1">
                                   <!-- Chat items will be injected here -->
                                </ul>
                            </nav>
                        </aside>
                        <!-- Coluna do Chat Ativo -->
                        <main id="chat-view-column" class="flex-1 bg-background flex-col hidden md:flex">
                            <div id="new-chat-placeholder" class="flex flex-1 items-center justify-center text-center">
                                 <div class="p-8 rounded-lg flex flex-col items-center text-muted-foreground">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-16 w-16 opacity-50"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>
                                    <p class="mt-4 text-lg">Selecione uma conversa para começar</p>
                                </div>
                            </div>
                             <div id="new-chat-view" class="hidden h-full flex-col">
                                <header id="chat-active-header" class="flex items-center p-4 gap-4 bg-card shadow-sm">
                                    <!-- Active chat header rendered by JS -->
                                </header>
                                <div id="new-chat-messages" class="flex-1 p-6 overflow-y-auto space-y-6">
                                    <!-- Messages will be injected here -->
                                </div>
                                <footer class="p-4 bg-card">
                                    <div class="flex items-center gap-4 bg-muted/50 rounded-xl p-2">
                                        <button class="text-muted-foreground hover:text-primary transition-colors p-2">
                                            <span class="material-symbols-outlined">add_circle</span>
                                        </button>
                                        <input id="new-chat-input" class="flex-1 bg-transparent border-none text-foreground placeholder:text-muted-foreground focus:ring-0" placeholder="Digite sua mensagem..." type="text"/>
                                        <button id="new-send-button" class="p-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                            <span class="material-symbols-outlined">send</span>
                                        </button>
                                    </div>
                                </footer>
                            </div>
                        </main>
                        <!-- Coluna de Detalhes do Cliente -->
                        <aside id="chat-details-panel" class="w-[380px] bg-card flex-col border-l p-6 space-y-8 overflow-y-auto hidden lg:flex">
                            <!-- Details rendered by JS -->
                        </aside>
                    </div>
                </section>

                <!-- Seção Agendamentos -->
                <section id="agendamentos-section" class="page-section hidden flex flex-col md:flex-row gap-6 h-full p-4 md:p-6 lg:p-8">
                        <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 absolute pt-8 md:pt-0">Agendamentos</h1>
                         <div class="md:w-auto bg-card p-4 rounded-lg border flex-shrink-0 h-fit mt-16">
                             <div id="full-calendar-container"></div>
                        </div>
                        <div class="flex-grow bg-card rounded-lg border p-4 flex flex-col mt-16">
                        <div
                            class="flex flex-wrap justify-between items-center border-b pb-4 mb-4 gap-4">
                            <div class="flex items-center gap-2">
                                <button id="today-btn"
                                    class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3">Hoje</button>
                                <div class="flex items-center gap-1">
                                    <button id="prev-week-btn" class="p-2 rounded-md hover:bg-muted text-muted-foreground"><svg
                                            xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                            class="h-5 w-5">
                                            <path d="m15 18-6-6 6-6" />
                                        </svg></button>
                                    <button id="next-week-btn" class="p-2 rounded-md hover:bg-muted text-muted-foreground"><svg
                                            xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                            class="h-5 w-5">
                                            <path d="m9 18 6-6-6-6" />
                                        </svg></button>
                                </div>
                                <h3 id="weekly-view-date-range"
                                    class="text-lg font-semibold whitespace-nowrap text-foreground">
                                </h3>
                            </div>
                            <div id="view-toggle-buttons"
                                class="flex items-center gap-1 bg-muted p-1 rounded-lg text-sm">
                                <button class="view-toggle-btn px-3 py-1 rounded-md"
                                    data-view="weekly">Semanal</button>
                                <button class="view-toggle-btn px-3 py-1 rounded-md"
                                    data-view="daily">Diário</button>
                            </div>
                        </div>
                        <div id="agenda-views-container" class="flex-grow h-full relative overflow-hidden">
                            <div id="weekly-view" class="h-full flex flex-col">
                                <div id="weekly-header" class="grid grid-cols-7 flex-shrink-0"></div>
                                <div id="weekly-body" class="flex-grow overflow-y-auto relative h-full"></div>
                            </div>
                            <div id="daily-view" class="h-full hidden flex flex-col">
                                <div id="daily-body" class="flex-grow overflow-y-auto relative h-full"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Detalhes do Cliente -->
                <section id="client-detail-section" class="page-section hidden p-4 md:p-6 lg:p-8"></section>
                
                <!-- Seção Detalhes do Agendamento -->
                <section id="appointment-detail-section" class="page-section hidden p-4 md:p-6 lg:p-8"></section>

                <!-- Seção Clientes -->
                <section id="clientes-section" class="page-section hidden p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Clientes</h1>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-4 border-b flex items-center justify-between">
                            <div class="relative w-full max-w-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground">
                                    <circle cx="11" cy="11" r="8" />
                                    <path d="m21 21-4.3-4.3" />
                                </svg>
                                <input id="client-search-input" placeholder="Filtrar clientes..."
                                    class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pl-10">
                            </div>
                             <button
                                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 opacity-50 cursor-not-allowed">Adicionar
                                Cliente</button>
                        </div>
                        <div class="p-4 md:hidden" id="client-list-container">
                             <!-- Client cards for mobile will be injected here -->
                        </div>
                        <div class="p-4 hidden md:block">
                            <div class="relative w-full overflow-auto">
                                <table class="w-full caption-bottom text-sm">
                                    <thead class="[&_tr]:border-b">
                                        <tr
                                            class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                                            <th
                                                class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 w-[40%]">
                                                Nome</th>
                                            <th
                                                class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 w-[30%]">
                                                Telefone</th>
                                            <th
                                                class="h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 w-[30%]">
                                                Data de Cadastro</th>
                                        </tr>
                                    </thead>
                                    <tbody id="client-table-body" class="[&_tr:last-child]:border-0">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Automações -->
                <section id="automacoes-section" class="page-section hidden max-w-4xl mx-auto space-y-8 p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Automações</h1>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-foreground">Envio de Mensagens em Massa</h3>
                            <p class="text-sm text-muted-foreground">Envie mensagens para múltiplos clientes de uma
                                só vez. (Em breve)</p>
                        </div>
                        <div class="p-6 pt-0 space-y-4">
                            <button
                                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
                                disabled>Enviar para X clientes</button>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-foreground">Chatbot / Secretária Virtual</h3>
                            <p class="text-sm text-muted-foreground">Configure respostas automáticas. (Em breve)
                            </p>
                        </div>
                        <div class="p-6 pt-0 space-y-4">
                            <div class="flex items-center justify-between p-4 bg-muted/50 rounded-lg">
                                <label for="chatbot-toggle" class="font-medium text-sm">Ativar Respostas
                                    Automáticas</label>
                                <button type="button" id="chatbot-toggle" role="switch"
                                    class="peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input"
                                    disabled><span
                                        class="pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0"></span></button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Seção Configurações/Perfil -->
                <section id="configuracoes-section" class="page-section hidden max-w-2xl mx-auto space-y-8 p-4 md:p-6 lg:p-8">
                    <h1 class="text-3xl font-bold tracking-tight text-foreground mb-8 pt-8 md:pt-0">Configurações</h1>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-foreground">Informações da Clínica</h3>
                        </div>
                        <div class="p-6 pt-0 space-y-4">
                            <div><label class="block mb-2 text-sm font-medium">Nome</label><input type="text"
                                    value="Elegance" disabled
                                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                            <div><label class="block mb-2 text-sm font-medium">E-mail de Contato</label><input
                                    type="email" value="contato@elegance.com" disabled
                                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-foreground">Segurança</h3>
                        </div>
                        <form id="password-change-form" class="p-6 pt-0 space-y-4">
                            <div><label for="current-password"
                                    class="block mb-2 text-sm font-medium">Senha
                                    Atual</label><input type="password" id="current-password" required
                                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                            <div><label for="new-password" class="block mb-2 text-sm font-medium">Nova
                                    Senha</label><input type="password" id="new-password" required
                                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                            <div><label for="confirm-password"
                                    class="block mb-2 text-sm font-medium">Confirmar
                                    Nova Senha</label><input type="password" id="confirm-password" required
                                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            </div>
                            <div id="password-change-message" class="text-sm h-5"></div>
                            <button type="submit"
                                class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Salvar
                                Alterações</button>
                        </form>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
     <!-- Bottom Nav for Mobile -->
    <nav id="mobile-bottom-nav" class="fixed bottom-0 left-0 right-0 h-16 bg-card border-t flex md:hidden z-50">
         <a href="#dashboard" class="nav-link flex-1 flex flex-col items-center justify-center text-muted-foreground">
             <span class="material-symbols-outlined">dashboard</span>
             <span class="text-xs">Dashboard</span>
         </a>
         <a href="#clientes" class="nav-link flex-1 flex flex-col items-center justify-center text-muted-foreground">
             <span class="material-symbols-outlined">group</span>
             <span class="text-xs">Clientes</span>
         </a>
         <a href="#agendamentos" class="nav-link flex-1 flex flex-col items-center justify-center text-muted-foreground">
             <span class="material-symbols-outlined">calendar_month</span>
             <span class="text-xs">Agenda</span>
         </a>
         <a href="#conversas" class="nav-link flex-1 flex flex-col items-center justify-center text-muted-foreground">
             <span class="material-symbols-outlined">chat</span>
             <span class="text-xs">Conversas</span>
         </a>
         <a href="#configuracoes" class="nav-link flex-1 flex flex-col items-center justify-center text-muted-foreground">
             <span class="material-symbols-outlined">settings</span>
             <span class="text-xs">Ajustes</span>
         </a>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // -----------------------------------------------------------------------------
            // 1. CONSTANTES E INICIALIZAÇÃO
            // -----------------------------------------------------------------------------

            const SUPABASE_URL = "https://zfblhljtfqnopwlffffq.supabase.co";
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmYmxobGp0ZnFub3B3bGZmZmZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjgxNDgsImV4cCI6MjA3MzA0NDE0OH0.m76j7L_49X_8tV0myINjEQIzizOUAa7SLCO1li3MKdg";
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let currentClinicId = null;
            let allAppointments = [];
            let allClients = [];
            let currentChats = [];
            let currentChat = null;
            let currentDate = new Date();
            let currentCalendarView = 'weekly';
            let consultasChartInstance, conversionChartInstance;
            let clientListSubscription = null;
            let shaderAnimationScene = null;

            const appDiv = document.getElementById('app');
            const authSection = document.getElementById('auth-section');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const passwordToggle = document.getElementById('password-toggle');
            const pageSections = document.querySelectorAll('.page-section');
            const navLinks = document.getElementById('nav-links');
            const mobileNavLinks = document.getElementById('mobile-bottom-nav');
            const clientTableBody = document.getElementById('client-table-body');
            const clientListContainer = document.getElementById('client-list-container');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const appSidebar = document.getElementById('app-sidebar');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const themeToggleContainer = document.getElementById('theme-toggle-container');

            // -----------------------------------------------------------------------------
            // 2. LÓGICA DE UI E TEMA
            // -----------------------------------------------------------------------------

             const renderThemeToggle = () => {
                 themeToggleContainer.innerHTML = `
                     <div id="theme-toggle" class="flex w-14 h-7 p-1 rounded-full cursor-pointer transition-all duration-300">
                         <div class="flex justify-between items-center w-full">
                             <div id="theme-toggle-indicator" class="flex justify-center items-center w-5 h-5 rounded-full transition-transform duration-300">
                                 <!-- Icons will be injected here -->
                             </div>
                             <div id="theme-toggle-placeholder" class="flex justify-center items-center w-5 h-5 rounded-full transition-transform duration-300">
                                 <!-- Icons will be injected here -->
                             </div>
                         </div>
                     </div>
                 `;
                 document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
                 applyInitialTheme();
            };
            
            const syncThemeUI = (isDark) => {
                const toggle = document.getElementById('theme-toggle');
                const indicator = document.getElementById('theme-toggle-indicator');
                const placeholder = document.getElementById('theme-toggle-placeholder');

                if (!toggle || !indicator || !placeholder) return;

                if (isDark) {
                    document.documentElement.classList.add('dark');
                    document.documentElement.classList.remove('light');
                    toggle.classList.add('bg-zinc-950', 'border', 'border-zinc-800');
                    toggle.classList.remove('bg-white', 'border', 'border-zinc-200');
                    indicator.style.transform = 'translateX(0px)';
                    indicator.classList.add('bg-zinc-800');
                    indicator.classList.remove('bg-gray-200');
                    indicator.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;
                    placeholder.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;

                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.classList.add('light');
                    toggle.classList.remove('bg-zinc-950', 'border', 'border-zinc-800');
                    toggle.classList.add('bg-white', 'border', 'border-zinc-200');
                    indicator.style.transform = 'translateX(24px)';
                    indicator.classList.remove('bg-zinc-800');
                    indicator.classList.add('bg-gray-200');
                    indicator.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4b5563" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
                    placeholder.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;
                }
                updateChartTheme();
            };

            const applyInitialTheme = () => {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                syncThemeUI(savedTheme === 'dark');
            };

            const toggleTheme = () => {
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'light' : 'dark');
                syncThemeUI(!isDark);
            };


            // -----------------------------------------------------------------------------
            // 3. LÓGICA PRINCIPAL DA APLICAÇÃO (AUTENTICAÇÃO E NAVEGAÇÃO)
            // -----------------------------------------------------------------------------

            const showApp = (clinicData, rememberMe) => {
                currentClinicId = clinicData.clinic_id;
                const storage = rememberMe ? localStorage : sessionStorage;
                storage.setItem('clinicSession', JSON.stringify(clinicData));

                if (shaderAnimationScene && shaderAnimationScene.animationId) {
                    cancelAnimationFrame(shaderAnimationScene.animationId);
                }

                authSection.style.display = 'none';
                appDiv.classList.remove('hidden');
                appDiv.style.display = 'flex';

                const userName = clinicData.email.split('@')[0];
                const userInitials = getInitials(userName);
                document.getElementById('user-name-header').textContent = userName;
                document.getElementById('user-avatar-header').src = `https://placehold.co/40x40/f59e0b/000000?text=${userInitials}`;

                showSection(window.location.hash || '#dashboard');
            };

            const showLogin = () => {
                currentClinicId = null;
                sessionStorage.removeItem('clinicSession');
                localStorage.removeItem('clinicSession');
                unsubscribeFromChannels(); 

                authSection.style.display = 'flex';
                appDiv.classList.add('hidden');
                appDiv.style.display = 'none';
                initShaderAnimation();
            };

            const handleLogin = async (event) => {
                event.preventDefault();
                loginError.textContent = '';
                const email = document.getElementById('email-input').value.trim();
                const password = document.getElementById('password-input').value;
                const rememberMe = document.getElementById('remember-me-checkbox').checked;

                const { data, error } = await supabase.from('usuarios_site').select('email, senha, clinic_id').eq('email', email).limit(1);

                if (error || !data || data.length === 0) {
                    loginError.textContent = 'E-mail ou senha inválidos.';
                    return;
                }

                const user = data[0];
                if (user.senha === password) {
                    showApp(user, rememberMe);
                } else {
                    loginError.textContent = 'E-mail ou senha inválidos.';
                }
            };

            const checkSession = () => {
                let session = localStorage.getItem('clinicSession') || sessionStorage.getItem('clinicSession');
                if (session) {
                    showApp(JSON.parse(session), !!localStorage.getItem('clinicSession'));
                } else {
                    showLogin();
                }
            };
            
            const showSection = async (hash) => {
                unsubscribeFromChannels();
                const currentHash = hash || '#dashboard';
                let baseHash = currentHash.split('-')[0];
                if (baseHash === '#appointment' || baseHash === '#client') {
                    baseHash += '-detail';
                }

                const sectionId = `${baseHash.substring(1)}-section`;
                const section = document.getElementById(sectionId) || document.getElementById('dashboard-section');

                pageSections.forEach(s => s.classList.add('hidden'));
                if (section) {
                    section.classList.remove('hidden');
                    gsap.fromTo(section, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3 });
                } else {
                    document.getElementById('dashboard-section').classList.remove('hidden');
                }
                
                appSidebar.querySelectorAll('a.nav-link').forEach(a => a.classList.remove('active'));
                mobileNavLinks.querySelectorAll('a.nav-link').forEach(a => a.classList.remove('active'));
                
                const navHash = currentHash.split('-')[0];
                const activeLink = appSidebar.querySelector(`a[href="${navHash}"]`);
                if (activeLink) activeLink.classList.add('active');

                const activeMobileLink = mobileNavLinks.querySelector(`a[href="${navHash}"]`);
                if(activeMobileLink) activeMobileLink.classList.add('active');


                if (!currentClinicId) return;

                const sectionBaseName = baseHash.split('-')[0];

                switch (sectionBaseName) {
                    case '#dashboard': await fetchDashboardData(); break;
                    case '#clientes': await fetchClients(); break;
                    case '#conversas': await fetchChats(); break;
                    case '#agendamentos': await fetchAndRenderAgenda(); break;
                    case '#client': 
                        const clientId = currentHash.split('-detail-')[1];
                        if (!allClients || allClients.length === 0) await fetchClients(); // Fetch if not available
                        const client = allClients.find(c => (c.telefone || c.telefone_cliente || '').replace(/\D/g, '') === clientId);
                        if(client) await renderClientDetailsPage(client, '#clientes');
                        break;
                    case '#appointment': 
                        const appointmentId = currentHash.split('-detail-')[1];
                         if (!allAppointments || allAppointments.length === 0) await fetchAndRenderAgenda(); // Fetch if not available
                        const appointment = allAppointments.find(a => a.id == appointmentId);
                        if(appointment) await renderAppointmentDetailsPage(appointment, '#agendamentos');
                        break;
                }
            };
            
            function unsubscribeFromChannels() {
                if (clientListSubscription) {
                    supabase.removeChannel(clientListSubscription);
                    clientListSubscription = null;
                }
            }


            // -----------------------------------------------------------------------------
            // 4. FUNCIONALIDADE: DASHBOARD
            // -----------------------------------------------------------------------------

            async function fetchDashboardData(period = 'all') {
                if (!currentClinicId) return;
                
                try {
                    const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                    const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
                    
                    let startDate = new Date();
                    if (period === '7') {
                        startDate.setDate(startDate.getDate() - 7);
                    } else if (period === '30') {
                        startDate.setDate(startDate.getDate() - 30);
                    } else {
                         startDate = new Date(0); // 'all'
                    }

                    const [
                        { count: totalContacts }, 
                        { data: appointmentsData }, 
                        { count: consultasParaHoje }, 
                        { data: recentAppointmentsData },
                        { data: revenueData },
                        { count: newPatientsCount },
                        { data: clientOriginsData },
                        { data: servicesData }
                    ] = await Promise.all([
                        supabase.from('dados_cliente').select('*', { count: 'exact', head: true }).eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('consultas').select('telefone_cliente, status').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('consultas').select('*', { count: 'exact', head: true }).eq('clinic_id', currentClinicId).gte('data_inicio', todayStart.toISOString()).lte('data_inicio', todayEnd.toISOString()),
                        supabase.from('consultas').select('nome_cliente, data_inicio').eq('clinic_id', currentClinicId).order('data_inicio', { ascending: true }).gte('data_inicio', new Date().toISOString()).limit(3),
                        supabase.from('consultas').select('valor').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('dados_cliente').select('*', { count: 'exact', head: true }).eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('dados_cliente').select('origem').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString()),
                        supabase.from('consultas').select('tipo_consulta').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString())
                    ]);
                    
                    const convertedCount = appointmentsData ? new Set(appointmentsData.map(c => c.telefone_cliente)).size : 0;
                    const taxaConversao = totalContacts > 0 ? ((convertedCount / totalContacts) * 100).toFixed(0) : 0;
                    
                    const faturamentoTotal = revenueData ? revenueData.reduce((acc, curr) => acc + (curr.valor || 150), 0) : 0;
                    document.getElementById('faturamento-mensal-stat').textContent = `R$ ${(faturamentoTotal / 1000).toFixed(1)}k`;
                    document.getElementById('vendas-geral-stat').textContent = `R$ ${(faturamentoTotal / 1000).toFixed(1)}k`;
                    document.getElementById('novos-pacientes-stat').textContent = newPatientsCount || 0;
                    document.getElementById('consultas-para-hoje-stat').textContent = consultasParaHoje || 0;
                    document.getElementById('taxa-conversao-stat').textContent = `${taxaConversao}%`;

                    const recentAppointmentsList = document.getElementById('recent-appointments-list');
                    recentAppointmentsList.innerHTML = '';
                    if (recentAppointmentsData && recentAppointmentsData.length > 0) {
                        recentAppointmentsData.forEach(apt => {
                            const item = document.createElement('div');
                            item.className = 'flex items-center gap-4';
                            const aptDate = new Date(apt.data_inicio);
                            const isToday = aptDate.toDateString() === new Date().toDateString();
                            item.innerHTML = `
                                <div class="${isToday ? 'bg-primary/20 text-primary' : 'bg-muted text-muted-foreground'} p-3 rounded-lg flex flex-col items-center justify-center w-14">
                                    <span class="font-bold">${aptDate.getDate()}</span>
                                    <span class="text-xs">${aptDate.toLocaleDateString('pt-BR', { month: 'short' }).toUpperCase().replace('.', '')}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-foreground">${htmlEncode(apt.nome_cliente)}</p>
                                    <p class="text-sm text-muted-foreground">${formatTimestamp(apt.data_inicio)}</p>
                                </div>`;
                            recentAppointmentsList.appendChild(item);
                        });
                    } else {
                        recentAppointmentsList.innerHTML = '<p class="text-sm text-muted-foreground">Nenhum agendamento próximo.</p>';
                    }
                    
                    const monthlyConsultasData = await getChartDataForPeriod(period);
                    const monthLabels = getChartLabelsForPeriod(period);

                    if (consultasChartInstance) {
                        consultasChartInstance.data.labels = monthLabels;
                        consultasChartInstance.data.datasets[0].data = monthlyConsultasData;
                        consultasChartInstance.update();
                    }
                    
                    const originCounts = (clientOriginsData || []).reduce((acc, client) => {
                        const origin = client.origem || 'Outros';
                        acc[origin] = (acc[origin] || 0) + 1;
                        return acc;
                    }, { 'Instagram': 0, 'Facebook': 0, 'Indicação': 0, 'Outros': 0 });

                    if (conversionChartInstance) {
                        conversionChartInstance.data.labels = Object.keys(originCounts);
                        conversionChartInstance.data.datasets[0].data = Object.values(originCounts);
                        conversionChartInstance.update();
                    }

                    const serviceCounts = (servicesData || []).reduce((acc, apt) => {
                        const service = apt.tipo_consulta || 'Não especificado';
                        acc[service] = (acc[service] || 0) + 1;
                        return acc;
                    }, {});
                    renderServicosMaisProcurados(serviceCounts, servicesData.length);
                    fetchAndRenderRecentActivities();

                } catch (error) {
                    console.error("Erro ao carregar dados do dashboard:", error);
                }
            }

            function renderServicosMaisProcurados(serviceCounts, total) {
                const container = document.getElementById('servicos-procurados-container');
                if (!container) return;
                
                const title = container.querySelector('p');
                container.innerHTML = '';
                if(title) container.appendChild(title);

                const sortedServices = Object.entries(serviceCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 4); 

                const progressContainer = document.createElement('div');
                progressContainer.className = 'grid min-h-[180px] gap-y-4 items-center py-3';

                if(sortedServices.length > 0) {
                    sortedServices.forEach(([name, count]) => {
                        const percentage = total > 0 ? (count / total) * 100 : 0;
                        progressContainer.innerHTML += `
                            <div class="space-y-1">
                                <p class="text-muted-foreground text-sm font-medium">${name}</p>
                                <div class="w-full bg-muted rounded-full h-2.5"><div class="bg-primary h-2.5 rounded-full" style="width: ${percentage}%"></div></div>
                            </div>`;
                    });
                } else {
                    progressContainer.innerHTML = `<p class="text-sm text-muted-foreground">Nenhum serviço registrado no período.</p>`;
                }
                container.appendChild(progressContainer);
            }

            async function fetchAndRenderRecentActivities() {
                const container = document.getElementById('recent-activities-list');
                container.innerHTML = '';

                const [ {data: newAppointments}, {data: newClients} ] = await Promise.all([
                    supabase.from('consultas').select('nome_cliente, created_at').eq('clinic_id', currentClinicId).order('created_at', { ascending: false }).limit(2),
                    supabase.from('dados_cliente').select('nomewpp, created_at').eq('clinic_id', currentClinicId).order('created_at', { ascending: false }).limit(2)
                ]);

                const activities = [];
                if (newAppointments) {
                    newAppointments.forEach(apt => activities.push({ type: 'agendamento', data: apt, time: new Date(apt.created_at) }));
                }
                if (newClients) {
                    newClients.forEach(client => activities.push({ type: 'cliente', data: client, time: new Date(client.created_at) }));
                }

                activities.sort((a, b) => b.time - a.time);

                if(activities.length > 0) {
                    activities.slice(0, 3).forEach(activity => {
                        const item = document.createElement('div');
                        item.className = 'flex gap-4';
                        const name = activity.type === 'agendamento' ? activity.data.nome_cliente : activity.data.nomewpp;
                        const actionText = activity.type === 'agendamento' ? 'agendou uma nova consulta.' : 'se cadastrou como novo cliente.';
                        const initials = getInitials(name);
                        item.innerHTML = `
                            <img src="https://placehold.co/40x40/f59e0b/000000?text=${initials}" class="rounded-full size-10">
                            <div>
                                <p class="text-sm text-foreground"><span class="font-bold">${name}</span> ${actionText}</p>
                                <p class="text-xs text-muted-foreground">${timeAgo(activity.time)}</p>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<p class="text-sm text-muted-foreground">Nenhuma atividade recente.</p>';
                }
            }
            
            async function getChartDataForPeriod(period){
                 let startDate = new Date(0);
                 let labels;
                 if (period === '7') {
                     startDate = new Date(); startDate.setDate(startDate.getDate() - 7);
                     labels = Array.from({length: 7}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (6-i)); return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit'}); });
                 } else if (period === '30') {
                     startDate = new Date(); startDate.setDate(startDate.getDate() - 30);
                      labels = Array.from({length: 30}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (29-i)); return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit'}); });
                 } else { // all
                    labels = Array.from({length: 6}, (v, i) => { const d = new Date(); d.setMonth(d.getMonth() - (5 - i)); return d.toLocaleDateString('pt-BR', { month: 'short' }); });
                 }
                
                const { data, error } = await supabase.from('consultas').select('created_at').eq('clinic_id', currentClinicId).gte('created_at', startDate.toISOString());
                if(error) return [];
                
                if (period === 'all') {
                    const counts = labels.reduce((acc, label) => ({...acc, [label]: 0}), {});
                    data.forEach(d => {
                        const month = new Date(d.created_at).toLocaleDateString('pt-BR', { month: 'short' });
                        if(counts[month] !== undefined) counts[month]++;
                    });
                    return Object.values(counts);
                } else {
                    const counts = labels.reduce((acc, label) => ({...acc, [label]: 0}), {});
                     data.forEach(d => {
                          const day = new Date(d.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                          if(counts[day] !== undefined) counts[day]++;
                     });
                     return Object.values(counts);
                }
            }
            
              function getChartLabelsForPeriod(period) {
                  if (period === 'all') {
                      return Array.from({length: 6}, (v, i) => { const d = new Date(); d.setMonth(d.getMonth() - (5 - i)); return d.toLocaleDateString('pt-BR', { month: 'short' }); });
                  } else {
                      const days = period === '7' ? 7 : 30;
                      return Array.from({length: days}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (days - 1 - i)); return d.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});});
                  }
            }

            function initializeCharts() {
                const chartBaseOptions = {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                };
                
                const consultasCtx = document.getElementById('consultasChart')?.getContext('2d');
                if(consultasCtx) {
                    consultasChartInstance = new Chart(consultasCtx, { type: 'bar', data: { labels: [], datasets: [{ data: [], borderRadius: 4 }] }, options: { ...chartBaseOptions, scales: { y: { beginAtZero: true }, x: {} } } });
                }
                
                const conversionCtx = document.getElementById('conversionChart')?.getContext('2d');
                if(conversionCtx) {
                    conversionChartInstance = new Chart(conversionCtx, { type: 'doughnut', data: { labels: ['Instagram', 'Facebook', 'Indicação', 'Outros'], datasets: [{ data: [], borderWidth: 0 }] }, options: { ...chartBaseOptions, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
                }

                updateChartTheme();
            }

            function updateChartTheme() {
                setTimeout(() => {
                    const style = getComputedStyle(document.documentElement);
                    const textColor = `hsl(${style.getPropertyValue('--muted-foreground').trim()})`;
                    const gridColor = `hsl(${style.getPropertyValue('--border').trim()})`;
                    const primaryColor = `hsl(${style.getPropertyValue('--primary').trim()})`;
                    
                    if (consultasChartInstance) {
                        consultasChartInstance.options.scales.y.ticks.color = textColor;
                        consultasChartInstance.options.scales.x.ticks.color = textColor;
                        consultasChartInstance.options.scales.y.grid.color = gridColor;
                        consultasChartInstance.options.scales.x.grid.color = 'transparent';
                        consultasChartInstance.data.datasets[0].backgroundColor = primaryColor;
                        consultasChartInstance.update();
                    }
                    if (conversionChartInstance) {
                        conversionChartInstance.options.plugins.legend.labels.color = textColor;
                        conversionChartInstance.data.datasets[0].backgroundColor = [primaryColor, '#34d399', '#f97316', `hsl(${style.getPropertyValue('--muted').trim()})`];
                        conversionChartInstance.update();
                    }
                }, 100);
            }


            // -----------------------------------------------------------------------------
            // 5. FUNCIONALIDADE: CLIENTES
            // -----------------------------------------------------------------------------
            
            async function fetchClients() {
                if (!currentClinicId) return;

                const { data, error } = await supabase.from('dados_cliente').select('*').eq('clinic_id', currentClinicId);

                if (error) {
                    clientTableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-500">Erro ao carregar clientes.</td></tr>`;
                    return;
                }
                
                allClients = data || [];
                renderClientList(allClients);

                clientListSubscription = supabase.channel('public:dados_cliente')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'dados_cliente', filter: `clinic_id=eq.${currentClinicId}` }, async () => {
                        const { data: updatedData } = await supabase.from('dados_cliente').select('*').eq('clinic_id', currentClinicId);
                        allClients = updatedData || [];
                        renderClientList(allClients);
                    })
                    .subscribe();
            }

            const renderClientList = (clients) => {
                clientTableBody.innerHTML = '';
                clientListContainer.innerHTML = '';

                if (!clients || clients.length === 0) {
                     const noClientsHtml = `<tr><td colspan="3" class="p-4 text-center text-muted-foreground">Nenhum cliente encontrado.</td></tr>`;
                     clientTableBody.innerHTML = noClientsHtml;
                     clientListContainer.innerHTML = `<div class="p-4 text-center text-muted-foreground">Nenhum cliente encontrado.</div>`
                    return;
                }

                clients.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                clients.forEach(client => {
                    // Render for mobile (cards)
                    const card = document.createElement('div');
                    card.className = 'bg-card p-4 rounded-lg shadow mb-2 border flex items-center gap-4';
                    card.innerHTML = `
                         <img src="https://placehold.co/40x40/f59e0b/000000?text=${getInitials(client.nomewpp)}" class="w-10 h-10 rounded-full">
                         <div class="flex-1">
                            <p class="font-medium">${htmlEncode(client.nomewpp)}</p>
                            <p class="text-sm text-muted-foreground">${htmlEncode(client.telefone)}</p>
                         </div>
                         <span class="text-xs text-muted-foreground">${new Date(client.created_at).toLocaleDateString('pt-BR')}</span>
                    `;
                    card.addEventListener('click', () => showClientDetailsView(client, '#clientes'));
                    clientListContainer.appendChild(card);
                    
                    // Render for desktop (table)
                    const row = document.createElement('tr');
                    row.className = 'border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted cursor-pointer';
                    row.innerHTML = `<td class="p-4 align-middle font-medium">${htmlEncode(client.nomewpp)}</td><td class="p-4 align-middle text-muted-foreground">${htmlEncode(client.telefone)}</td><td class="p-4 align-middle text-muted-foreground">${new Date(client.created_at).toLocaleDateString('pt-BR')}</td>`;
                    row.addEventListener('click', () => showClientDetailsView(client, '#clientes'));
                    clientTableBody.appendChild(row);
                });
            };

            async function showClientDetailsView(client, backHash) {
                if (!currentClinicId) return;
                
                const clientPhoneNumber = (client.telefone || client.telefone_cliente || '').replace(/\D/g, '');
                if (!clientPhoneNumber) return;

                window.location.hash = `#client-detail-${clientPhoneNumber}`;
            }
            
            async function showAppointmentDetailsView(appointment, backHash) {
                if (!currentClinicId || !appointment) return;
                window.location.hash = `#appointment-detail-${appointment.id}`;
            }

             async function renderClientDetailsPage(client, backHash) {
                const detailSection = document.getElementById('client-detail-section');
                detailSection.innerHTML = `<div class="text-center p-8">Carregando detalhes...</div>`;

                const clientPhoneNumber = (client.telefone || client.telefone_cliente || '').replace(/\D/g, '');

                const [{ data: clientDetailsData }, { data: appointmentsData }] = await Promise.all([
                    supabase.from('dados_cliente').select('*').eq('telefone', clientPhoneNumber).eq('clinic_id', currentClinicId).limit(1),
                    supabase.from('consultas').select('*').eq('telefone_cliente', clientPhoneNumber).eq('clinic_id', currentClinicId).order('data_inicio', { ascending: false })
                ]);
                
                const clientData = (clientDetailsData && clientDetailsData.length > 0) ? clientDetailsData[0] : client;

                const clientInitials = getInitials(clientData.nomewpp || clientData.nome_cliente);
                const age = calculateAge(clientData.data_nascimento);
                const formattedBirthdate = clientData.data_nascimento ? new Date(clientData.data_nascimento).toLocaleDateString('pt-BR') : 'Não informado';
                
                const futureAppointments = appointmentsData ? appointmentsData.filter(a => new Date(a.data_inicio) > new Date()) : [];
                const pastAppointments = appointmentsData ? appointmentsData.filter(a => new Date(a.data_inicio) <= new Date()) : [];

                const renderAppointment = (apt) => `
                    <details class="group bg-muted/50 rounded-lg">
                        <summary class="p-4 cursor-pointer flex justify-between items-center">
                            <div>
                                <p class="font-medium text-foreground">${htmlEncode(apt.tipo_consulta)}</p>
                                <p class="text-sm text-muted-foreground">${new Date(apt.data_inicio).toLocaleString('pt-BR', { dateStyle: 'long', timeStyle: 'short' })}</p>
                            </div>
                            <span class="material-symbols-outlined transition-transform group-open:rotate-180">expand_more</span>
                        </summary>
                        <div class="p-4 border-t border-border text-sm text-muted-foreground space-y-2">
                            <p><strong>Status:</strong> ${htmlEncode(apt.status)}</p>
                             <p><strong>Valor:</strong> R$ ${apt.valor || 'Não definido'}</p>
                            <p><strong>Observações:</strong> ${htmlEncode(apt.observacoes) || 'Nenhuma.'}</p>
                        </div>
                    </details>
                `;
                
                detailSection.innerHTML = `
                    <div class="max-w-6xl mx-auto space-y-8 pt-8 md:pt-0">
                        <div>
                            <button id="back-to-previous-view-btn" class="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                                Voltar
                            </button>
                            <h1 class="text-3xl font-bold tracking-tight text-foreground">Detalhes do Cliente</h1>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-1 flex flex-col gap-8">
                                <div class="bg-card p-6 rounded-xl border flex flex-col items-center text-center">
                                     <img class="h-24 w-24 rounded-full object-cover mb-4" src="https://placehold.co/96x96/f59e0b/000000?text=${clientInitials}" alt="Foto de perfil">
                                     <h3 class="text-lg font-semibold text-foreground">${htmlEncode(clientData.nomewpp || clientData.nome_cliente)}</h3>
                                     <p class="text-sm text-muted-foreground">${htmlEncode(clientData.telefone)}</p>
                                     <div class="text-sm text-muted-foreground mt-4 space-y-1">
                                         <p><strong>Nascimento:</strong> ${formattedBirthdate}</p>
                                         <p><strong>Idade:</strong> ${age ? `${age} anos` : 'Não informada'}</p>
                                     </div>
                                </div>
                                <div class="bg-card p-6 rounded-xl border">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="font-semibold text-foreground">Resumo da Conversa</h4>
                                        <button title="Atualizar resumo da conversa" class="text-muted-foreground hover:text-primary transition-colors">
                                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                                        </button>
                                    </div>
                                    <p class="text-sm text-muted-foreground">O resumo da conversa com o cliente aparecerá aqui. Esta funcionalidade está em desenvolvimento.</p>
                                </div>
                            </div>
                            <div class="lg:col-span-2 space-y-8">
                                <div>
                                    <h4 class="font-semibold text-foreground mb-4">Consultas Futuras</h4>
                                    <div id="future-appointments" class="space-y-3">
                                        ${futureAppointments.length > 0 ? futureAppointments.map(renderAppointment).join('') : '<p class="text-sm text-muted-foreground">Nenhuma consulta futura.</p>'}
                                    </div>
                                </div>
                                 <div>
                                    <h4 class="font-semibold text-foreground mb-4">Consultas Prévias</h4>
                                    <div id="past-appointments" class="space-y-3">
                                         ${pastAppointments.length > 0 ? pastAppointments.map(renderAppointment).join('') : '<p class="text-sm text-muted-foreground">Nenhuma consulta prévia.</p>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                detailSection.querySelector('#back-to-previous-view-btn').addEventListener('click', (e) => { e.preventDefault(); window.location.hash = backHash; });
            }

            async function renderAppointmentDetailsPage(appointment, backHash){
                 const detailSection = document.getElementById('appointment-detail-section');
                detailSection.innerHTML = `<div class="text-center p-8">Carregando detalhes...</div>`;

                const { data: clientData, error } = await supabase.from('dados_cliente')
                    .select('*')
                    .eq('telefone', appointment.telefone_cliente)
                    .eq('clinic_id', currentClinicId)
                    .single();

                const clientInfoHtml = error || !clientData
                    ? '<p>Detalhes do cliente não encontrados.</p>'
                    : ` <h3 class="text-lg font-semibold text-foreground">${htmlEncode(clientData.nomewpp)}</h3>
                        <p class="text-sm text-muted-foreground">${htmlEncode(clientData.email) || ''}</p>
                        <p class="text-sm text-muted-foreground">${htmlEncode(clientData.telefone)}</p>`;

                detailSection.innerHTML = `
                    <div class="max-w-6xl mx-auto pt-8 md:pt-0">
                        <div class="flex items-center mb-6">
                            <button id="back-to-previous-view-btn" class="p-2 mr-4 rounded-full hover:bg-muted text-foreground"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                            <h1 class="text-3xl font-bold tracking-tight text-foreground">Detalhes da Consulta</h1>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 bg-card p-6 rounded-xl border">
                                <h2 class="text-xl font-bold text-foreground mb-4">${htmlEncode(appointment.tipo_consulta)}</h2>
                                <div class="space-y-4 text-muted-foreground">
                                    <p><strong>Data:</strong> ${new Date(appointment.data_inicio).toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'short' })}</p>
                                    <p><strong>Status:</strong> <span class="px-2 py-1 text-xs font-medium rounded-full bg-primary/20 text-primary">${htmlEncode(appointment.status)}</span></p>
                                    <p><strong>Valor:</strong> R$ ${appointment.valor || 'Não definido'}</p>
                                    <p><strong>Observações:</strong> ${htmlEncode(appointment.observacoes) || 'Nenhuma.'}</p>
                                </div>
                            </div>
                            <div class="lg:col-span-1 bg-card p-6 rounded-xl border flex flex-col items-center text-center">
                                 <img class="h-24 w-24 rounded-full object-cover mb-4" src="https://placehold.co/96x96/f59e0b/000000?text=${getInitials(appointment.nome_cliente)}" alt="Foto de perfil">
                                ${clientInfoHtml}
                                <a href="#client-detail-${appointment.telefone_cliente}" class="mt-4 text-sm text-primary hover:underline">Ver perfil completo</a>
                            </div>
                        </div>
                    </div>
                `;
                 detailSection.querySelector('#back-to-previous-view-btn').addEventListener('click', (e) => { e.preventDefault(); window.location.hash = backHash; });
            }


            // -----------------------------------------------------------------------------
            // 6. FUNCIONALIDADE: CONVERSAS
            // -----------------------------------------------------------------------------
            
            async function fetchChats() {
                if (!currentClinicId) return;
                
                const { data: allMessages, error } = await supabase.from('n8n_chat_histories').select('session_id, created_at, content, patient_name, role').eq('clinic_id', currentClinicId).order('created_at', { ascending: false });

                if (error) {
                    document.getElementById('chat-list-container').innerHTML = `<div class="p-4 text-center text-red-400">Falha ao carregar conversas.</div>`;
                } else {
                    const latestChats = new Map();
                    allMessages.forEach(msg => {
                        if (!latestChats.has(msg.session_id)) {
                            latestChats.set(msg.session_id, {
                                phone: `${msg.session_id}@c.us`,
                                updated_at: msg.created_at,
                                last_message: msg.content || '...',
                                nomewpp: msg.patient_name || msg.session_id
                            });
                        }
                    });
                    currentChats = Array.from(latestChats.values());
                    renderChatList(currentChats);
                }
            };

            const renderChatList = (chats) => {
                const chatListContainer = document.getElementById('chat-list-container');
                chatListContainer.innerHTML = '';
                if (chats.length === 0) {
                    chatListContainer.innerHTML = `<li class="p-8 text-center text-muted-foreground">Nenhuma conversa.</li>`;
                    return;
                }

                chats.forEach(chat => {
                    const chatLi = document.createElement('li');
                    const initials = getInitials(chat.nomewpp);

                    chatLi.innerHTML = `
                        <a class="flex items-center gap-4 p-3 rounded-lg hover:bg-muted transition-colors" href="#" data-chat-id="${chat.phone}">
                            <div class="relative">
                                <img class="h-14 w-14 rounded-full object-cover" src="https://placehold.co/56x56/f59e0b/000000?text=${initials}" alt="Foto de perfil de ${htmlEncode(chat.nomewpp)}">
                                <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-green-500 border-2 border-card"></span>
                            </div>
                            <div class="flex-1 overflow-hidden">
                                <div class="flex justify-between items-start">
                                    <p class="font-semibold text-foreground">${htmlEncode(chat.nomewpp)}</p>
                                    <span class="text-xs text-muted-foreground">${formatTimestamp(chat.updated_at)}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <p class="text-sm text-muted-foreground truncate">${htmlEncode(chat.last_message)}</p>
                                </div>
                            </div>
                        </a>
                    `;
                    chatListContainer.appendChild(chatLi);
                });

                chatListContainer.querySelectorAll('a').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        chatListContainer.querySelectorAll('a').forEach(el => el.classList.remove('bg-primary/20'));
                        item.classList.add('bg-primary/20');
                        
                        currentChat = currentChats.find(c => c.phone == item.dataset.chatId);
                        if (!currentChat) return;
                        
                        document.getElementById('new-chat-placeholder').style.display = 'none';
                        document.getElementById('new-chat-view').classList.remove('hidden');
                        document.getElementById('new-chat-view').classList.add('flex');
                        
                        fetchMessagesForChat(currentChat.phone);
                        renderChatDetails(currentChat);

                         if (window.innerWidth < 768) {
                             document.getElementById('chat-list-column').classList.add('hidden');
                             document.getElementById('chat-view-column').classList.remove('hidden');
                         }

                    });
                });
            };
            
            async function renderChatDetails(chat) {
                const detailsContainer = document.getElementById('chat-details-panel');
                detailsContainer.innerHTML = '<p class="text-center text-muted-foreground">Carregando...</p>';

                const phone = chat.phone.split('@')[0];
                const { data: clientData, error } = await supabase.from('dados_cliente')
                    .select('*')
                    .eq('telefone', phone)
                    .eq('clinic_id', currentClinicId)
                    .single();
                
                if (error || !clientData) {
                    detailsContainer.innerHTML = '<p class="text-center text-muted-foreground">Detalhes do cliente não encontrados.</p>';
                    return;
                }
                const initials = getInitials(clientData.nomewpp);
                detailsContainer.innerHTML = `
                    <h2 class="text-xl font-bold text-foreground text-center">Detalhes do Cliente</h2>
                    <div class="flex flex-col items-center">
                        <img class="h-24 w-24 rounded-full object-cover mb-4" src="https://placehold.co/96x96/f59e0b/000000?text=${initials}" alt="Foto de perfil de ${htmlEncode(clientData.nomewpp)}">
                        <h3 class="text-lg font-semibold text-foreground">${htmlEncode(clientData.nomewpp)}</h3>
                        <p class="text-sm text-muted-foreground">${htmlEncode(clientData.email) || ''}</p>
                        <p class="text-sm text-muted-foreground">${htmlEncode(clientData.telefone)}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-foreground mb-4">Próximos Agendamentos</h4>
                        <div id="client-upcoming-appointments" class="space-y-3">
                            <p class="text-sm text-muted-foreground">Nenhum agendamento próximo.</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-foreground mb-4">Histórico</h4>
                        <ul id="client-history" class="space-y-4">
                           <p class="text-sm text-muted-foreground">Nenhum histórico encontrado.</p>
                        </ul>
                    </div>`;

                const { data: appointments } = await supabase.from('consultas').select('*').eq('telefone_cliente', phone).eq('clinic_id', currentClinicId).order('data_inicio', { ascending: true });
                
                const upcomingAppointmentsContainer = document.getElementById('client-upcoming-appointments');
                upcomingAppointmentsContainer.innerHTML = '';
                const upcoming = appointments.filter(a => new Date(a.data_inicio) > new Date());
                if(upcoming.length > 0){
                    upcoming.slice(0,1).forEach(apt => {
                        upcomingAppointmentsContainer.innerHTML += `
                        <div class="bg-muted p-4 rounded-lg flex items-center justify-between">
                            <div>
                                <p class="font-medium text-foreground">${htmlEncode(apt.tipo_consulta)}</p>
                                <p class="text-sm text-muted-foreground">${new Date(apt.data_inicio).toLocaleString('pt-BR', {day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit'})}</p>
                            </div>
                        </div>`;
                    });
                } else {
                    upcomingAppointmentsContainer.innerHTML = '<p class="text-sm text-muted-foreground">Nenhum agendamento próximo.</p>';
                }

                const historyContainer = document.getElementById('client-history');
                historyContainer.innerHTML = '';
                const pastAppointments = appointments.filter(a => new Date(a.data_inicio) <= new Date());
                 if(pastAppointments.length > 0){
                    pastAppointments.slice(0,2).forEach(apt => {
                        historyContainer.innerHTML += `
                        <li class="flex items-start gap-4">
                            <div class="bg-primary/20 rounded-full p-2">
                                <span class="material-symbols-outlined text-primary">calendar_month</span>
                            </div>
                            <div>
                                <p class="font-medium text-foreground">Consulta Realizada</p>
                                <p class="text-sm text-muted-foreground">${new Date(apt.data_inicio).toLocaleDateString('pt-BR')}</p>
                            </div>
                        </li>`;
                    });
                } else {
                    historyContainer.innerHTML = '<p class="text-sm text-muted-foreground">Nenhum histórico encontrado.</p>';
                }

            }

            async function fetchMessagesForChat(chatId) {
                if (!currentClinicId) return;

                const messagesContainer = document.getElementById('new-chat-messages');
                const chatHeader = document.getElementById('chat-active-header');
                messagesContainer.innerHTML = '';
                
                const client = currentChats.find(c => c.phone === chatId);
                const initials = getInitials(client.nomewpp);

                chatHeader.innerHTML = `
                    <button id="back-to-chat-list" class="p-2 -ml-2 rounded-md hover:bg-muted text-foreground md:hidden">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <img class="h-12 w-12 rounded-full object-cover" src="https://placehold.co/48x48/f59e0b/000000?text=${initials}" alt="Foto de ${htmlEncode(client.nomewpp)}">
                    <div>
                        <h3 class="font-bold text-lg text-foreground">${htmlEncode(client.nomewpp)}</h3>
                        <p class="text-sm text-green-500">Online</p>
                    </div>
                `;
                
                chatHeader.querySelector('#back-to-chat-list')?.addEventListener('click', () => {
                    document.getElementById('chat-list-column').classList.remove('hidden');
                    document.getElementById('chat-view-column').classList.add('hidden');
                });


                const sessionId = chatId.split('@')[0];
                const { data, error } = await supabase.from('n8n_chat_histories').select('created_at, content, role').eq('session_id', sessionId).eq('clinic_id', currentClinicId).order('created_at', { ascending: true });
                
                if (error) {
                    messagesContainer.innerHTML = `<div class="text-center text-red-400">Erro ao carregar mensagens.</div>`;
                } else if (data && data.length > 0) {
                    data.forEach(msg => appendMessageToNewChat(msg, client.nomewpp));
                } else {
                    messagesContainer.innerHTML = `<div class="text-center text-muted-foreground">Sem mensagens nesta conversa.</div>`;
                }
            }

            async function sendMessage() {
                const chatInput = document.getElementById('new-chat-input');
                if (!currentClinicId || !currentChat || chatInput.value.trim() === '') return;
                
                const text = chatInput.value.trim();
                const newMessage = { 
                    session_id: currentChat.phone.split('@')[0], 
                    content: text, 
                    role: 'AI',
                    patient_name: currentChat.nomewpp, 
                    clinic_id: currentClinicId 
                };

                const { error } = await supabase.from('n8n_chat_histories').insert([newMessage]);

                if (!error) {
                    appendMessageToNewChat({ ...newMessage, created_at: new Date().toISOString() });
                    chatInput.value = '';
                } else {
                    console.error("Erro ao enviar mensagem:", error);
                }
            }

            const appendMessageToNewChat = (message, clientName) => {
                if (!message.content) return;
                const messagesContainer = document.getElementById('new-chat-messages');
                const isFromClient = message.role?.toLowerCase() === 'user';
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex items-end gap-3 max-w-lg ${isFromClient ? '' : 'ml-auto flex-row-reverse'}`;
                
                const initials = getInitials(isFromClient ? clientName : 'Admin');
                const avatarSrc = isFromClient ? `https://placehold.co/40x40/f59e0b/000000?text=${initials}` : document.getElementById('user-avatar-header').src;
                const timeAlignment = isFromClient ? 'text-left' : 'text-right';
                const bubbleClasses = isFromClient ? 'bg-card rounded-tl-none' : 'bg-primary text-white rounded-tr-none';

                messageWrapper.innerHTML = `
                    <img class="h-10 w-10 rounded-full object-cover shrink-0" src="${avatarSrc}" alt="Avatar">
                    <div class="flex flex-col">
                        <div class="${bubbleClasses} p-4 rounded-lg">
                            <p>${htmlEncode(message.content)}</p>
                        </div>
                        <span class="text-xs text-muted-foreground mt-1 px-2 ${timeAlignment}">${formatTimestamp(message.created_at)}</span>
                    </div>
                `;

                messagesContainer.appendChild(messageWrapper);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            // -----------------------------------------------------------------------------
            // 7. FUNCIONALIDADE: AGENDAMENTOS
            // -----------------------------------------------------------------------------
            
            async function fetchAndRenderAgenda() {
                if (!currentClinicId) return;

                const { data, error } = await supabase.from('consultas')
                    .select('*')
                    .eq('clinic_id', currentClinicId)
                    .gte('data_inicio', new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString())
                    .lte('data_inicio', new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString());
                
                allAppointments = error ? [] : data;
                renderAgendaView();
            }
            
            function renderAgendaView() {
                renderFullCalendar();
                
                const dateRange = document.getElementById('weekly-view-date-range');
                const dailyBtn = document.querySelector('.view-toggle-btn[data-view="daily"]');
                const weeklyBtn = document.querySelector('.view-toggle-btn[data-view="weekly"]');
                
                document.getElementById('weekly-view').classList.toggle('hidden', currentCalendarView !== 'weekly');
                document.getElementById('daily-view').classList.toggle('hidden', currentCalendarView !== 'daily');
                weeklyBtn.classList.toggle('bg-background', currentCalendarView === 'weekly');
                weeklyBtn.classList.toggle('text-foreground', currentCalendarView === 'weekly');
                weeklyBtn.classList.toggle('shadow-sm', currentCalendarView === 'weekly');
                dailyBtn.classList.toggle('bg-background', currentCalendarView !== 'weekly');
                dailyBtn.classList.toggle('text-foreground', currentCalendarView !== 'weekly');
                dailyBtn.classList.toggle('shadow-sm', currentCalendarView !== 'weekly');

                if (currentCalendarView === 'weekly') {
                    renderWeeklyView();
                    const startOfWeek = new Date(currentDate);
                    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(endOfWeek.getDate() + 6);
                    dateRange.textContent = `${startOfWeek.toLocaleDateString('pt-BR', {month: 'long', day: 'numeric'})} - ${endOfWeek.toLocaleDateString('pt-BR', {day: 'numeric', month: 'long', year: 'numeric'})}`;
                } else {
                    renderDailyView();
                    dateRange.textContent = `${currentDate.toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'})}`;
                }
            }
            
            function renderFullCalendar() {
                const container = document.getElementById('full-calendar-container');
                container.innerHTML = ''; 

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                const header = document.createElement('div');
                header.className = 'relative mb-1 flex h-9 items-center justify-center z-20';
                header.innerHTML = `
                    <div class="absolute top-0 inset-x-0 flex h-9 items-center justify-between z-10 px-1">
                         <button id="calendar-prev-month" class="size-9 p-0 inline-flex items-center justify-center whitespace-nowrap rounded-lg text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground text-muted-foreground/80">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                         </button>
                         <button id="calendar-next-month" class="size-9 p-0 inline-flex items-center justify-center whitespace-nowrap rounded-lg text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground text-muted-foreground/80">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                         </button>
                    </div>
                    <span class="text-sm font-medium text-foreground">${new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</span>
                `;
                container.appendChild(header);

                header.querySelector('#calendar-prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); fetchAndRenderAgenda(); });
                header.querySelector('#calendar-next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); fetchAndRenderAgenda(); });

                const weekdays = document.createElement('div');
                weekdays.className = 'grid grid-cols-7';
                ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].forEach(day => {
                    weekdays.innerHTML += `<div class="size-9 p-0 text-xs font-medium text-muted-foreground/80 flex items-center justify-center">${day}</div>`;
                });
                container.appendChild(weekdays);


                const daysGrid = document.createElement('div');
                daysGrid.className = 'grid grid-cols-7';
                
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                for (let i = 0; i < firstDayOfMonth; i++) daysGrid.appendChild(document.createElement('div'));

                for (let day = 1; day <= daysInMonth; day++) {
                    const thisDate = new Date(year, month, day);
                    const dayGroup = document.createElement('div');
                    dayGroup.className = 'group size-9 px-0 text-sm flex items-center justify-center';
                    
                    const dayButton = document.createElement('button');
                    dayButton.className = "relative flex size-9 items-center justify-center whitespace-nowrap rounded-lg p-0 text-foreground outline-offset-2 hover:bg-accent focus:outline-none focus-visible:z-10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-ring/70";
                    
                    if(thisDate.toDateString() === currentDate.toDateString()) {
                          dayButton.classList.add('bg-primary', 'text-primary-foreground', 'font-bold');
                    }
                    
                    dayButton.innerHTML = `<span>${day}</span>`;

                    if (allAppointments.some(apt => new Date(apt.data_inicio).toDateString() === thisDate.toDateString())) {
                          const dot = document.createElement('span');
                          dot.className = "pointer-events-none absolute bottom-1 start-1/2 z-10 size-[3px] -translate-x-1/2 rounded-full";
                          dot.classList.add(thisDate.toDateString() === currentDate.toDateString() ? 'bg-background' : 'bg-primary');
                          dayButton.appendChild(dot);
                    }
                     if (thisDate.toDateString() === today.toDateString()) {
                          dayButton.classList.add('border', 'border-primary');
                    }


                    dayButton.addEventListener('click', () => { 
                        currentDate = thisDate; 
                        renderAgendaView();
                    });
                    dayGroup.appendChild(dayButton);
                    daysGrid.appendChild(dayGroup);
                }
                container.appendChild(daysGrid);
            }
            
            function renderWeeklyView() {
                const header = document.getElementById('weekly-header');
                const body = document.getElementById('weekly-body');
                header.innerHTML = ''; body.innerHTML = '';

                const startOfWeek = new Date(currentDate); 
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                
                const weekDays = Array.from({length: 7}, (_, i) => { const d = new Date(startOfWeek); d.setDate(d.getDate() + i); return d; });
                
                weekDays.forEach(day => {
                    const isToday = day.toDateString() === new Date().toDateString();
                    header.innerHTML += `<div class="text-center py-2 border-b"><p class="text-xs text-muted-foreground">${day.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(0,1).toUpperCase()}</p><p class="text-lg font-bold mt-1 ${isToday ? 'bg-primary text-primary-foreground rounded-full w-8 h-8 mx-auto flex items-center justify-center' : ''}">${day.getDate()}</p></div>`;
                });

                const startHour = 8, endHour = 18, hourHeight = 80;
                let hourLinesHTML = '';
                for (let hour = startHour; hour <= endHour; hour++) {
                    hourLinesHTML += `<div class="relative" style="height: ${hourHeight}px;"><div class="absolute left-0 -top-2.5 -ml-12 text-right w-10"><span class="text-xs text-muted-foreground">${hour}:00</span></div><div class="h-full border-t"></div></div>`;
                }

                let appointmentsHTML = '<div class="absolute inset-0 grid grid-cols-7 ml-12">';
                weekDays.forEach((day, dayIndex) => {
                    appointmentsHTML += `<div class="relative border-r">`;
                    const dayAppointments = allAppointments.filter(apt => new Date(apt.data_inicio).toDateString() === day.toDateString());
                    dayAppointments.forEach((apt, aptIndex) => {
                        const startDate = new Date(apt.data_inicio);
                        const top = (startDate.getHours() + startDate.getMinutes() / 60 - startHour) * hourHeight;
                        const height = (60 / 60) * hourHeight - 2;
                        appointmentsHTML += `<div class="absolute w-[calc(100%-0.5rem)] ml-1" style="top: ${top}px; height: ${height}px;"><div class="appointment-item h-full p-1 rounded-md bg-primary/80 text-primary-foreground cursor-pointer hover:opacity-80 flex flex-col justify-center" data-appointment='${htmlEncode(JSON.stringify(apt))}'><p class="text-xs font-bold truncate px-1">${htmlEncode(apt.nome_cliente)}</p><p class="text-[10px] px-1">${formatTimestamp(apt.data_inicio)}</p></div></div>`;
                    });
                    appointmentsHTML += `</div>`;
                });
                appointmentsHTML += '</div>';

                body.innerHTML = `<div class="relative" style="height: ${(endHour - startHour + 1) * hourHeight}px"><div class="ml-12">${hourLinesHTML}</div>${appointmentsHTML}</div>`;
                body.querySelectorAll('.appointment-item').forEach(item => item.addEventListener('click', () => { if (item.dataset.appointment) showAppointmentDetailsView(JSON.parse(item.dataset.appointment), '#agendamentos'); }));
            }

            function renderDailyView() {
                const body = document.getElementById('daily-body');
                body.innerHTML = '';
                
                const startHour = 8, endHour = 18, hourHeight = 80;
                let hourLinesHTML = '';
                for (let hour = startHour; hour <= endHour; hour++) {
                    hourLinesHTML += `<div class="relative" style="height: ${hourHeight}px;"><div class="absolute left-0 -top-2.5 -ml-12 text-right w-10"><span class="text-xs text-muted-foreground">${hour}:00</span></div><div class="h-full border-t"></div></div>`;
                }

                let appointmentsHTML = '<div class="absolute inset-0 ml-12">';
                const dayAppointments = allAppointments.filter(apt => new Date(apt.data_inicio).toDateString() === currentDate.toDateString());
                dayAppointments.forEach((apt, aptIndex) => {
                    const startDate = new Date(apt.data_inicio);
                    const top = (startDate.getHours() + startDate.getMinutes() / 60 - startHour) * hourHeight;
                    const height = (60 / 60) * hourHeight - 4;
                    appointmentsHTML += `<div class="absolute w-[calc(100%-1rem)]" style="top: ${top}px; height: ${height}px; left: 1rem;"><div class="appointment-item h-full p-3 rounded-lg bg-primary/80 text-primary-foreground cursor-pointer hover:opacity-80 flex flex-col justify-center" data-appointment='${htmlEncode(JSON.stringify(apt))}'><p class="font-bold truncate">${htmlEncode(apt.nome_cliente)}</p><p class="text-sm">${formatTimestamp(apt.data_inicio)}</p></div></div>`;
                });
                appointmentsHTML += '</div>';

                body.innerHTML = `<div class="relative" style="height: ${(endHour - startHour + 1) * hourHeight}px"><div class="ml-12">${hourLinesHTML}</div>${appointmentsHTML}</div>`;
                body.querySelectorAll('.appointment-item').forEach(item => item.addEventListener('click', () => { if (item.dataset.appointment) showAppointmentDetailsView(JSON.parse(item.dataset.appointment), '#agendamentos'); }));
            }
            
            // -----------------------------------------------------------------------------
            // 8. SHADER ANIMATION
            // -----------------------------------------------------------------------------
            function initShaderAnimation() {
                const container = document.getElementById('shader-container');
                if (!container || !window.THREE) return;
                
                if (shaderAnimationScene && shaderAnimationScene.renderer) {
                    if(container.contains(shaderAnimationScene.renderer.domElement)) {
                       container.removeChild(shaderAnimationScene.renderer.domElement);
                    }
                    shaderAnimationScene.renderer.dispose();
                }

                const vertexShader = `void main() { gl_Position = vec4( position, 1.0 ); }`;
                const fragmentShader = `
                    precision highp float;
                    uniform vec2 resolution;
                    uniform float time;
                    uniform vec3 eleganceColor;

                    void main(void) {
                        vec2 uv = (gl_FragCoord.xy * 2.0 - resolution.xy) / min(resolution.x, resolution.y);
                        float t = time * 0.05;
                        float lineWidth = 0.002;

                        vec3 color = vec3(0.0);
                        for(int j = 0; j < 3; j++){
                            for(int i=0; i < 5; i++){
                                color[j] += lineWidth * float(i*i) / abs(fract(t - 0.01 * float(j) + float(i) * 0.01) * 5.0 - length(uv) + mod(uv.x + uv.y, 0.2));
                            }
                        }
                        
                        vec3 finalColor = mix(color, eleganceColor, 0.7);

                        gl_FragColor = vec4(finalColor, 1.0);
                    }
                `;

                const camera = new THREE.Camera();
                camera.position.z = 1;

                const scene = new THREE.Scene();
                const geometry = new THREE.PlaneGeometry(2, 2);

                const uniforms = {
                    time: { type: "f", value: 1.0 },
                    resolution: { type: "v2", value: new THREE.Vector2() },
                    eleganceColor: { type: "v3", value: new THREE.Color(0xf59e0b) }
                };

                const material = new THREE.ShaderMaterial({
                    uniforms: uniforms,
                    vertexShader: vertexShader,
                    fragmentShader: fragmentShader,
                });

                const mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);

                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setPixelRatio(window.devicePixelRatio);
                container.appendChild(renderer.domElement);

                const onWindowResize = () => {
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    renderer.setSize(width, height);
                    uniforms.resolution.value.x = renderer.domElement.width;
                    uniforms.resolution.value.y = renderer.domElement.height;
                };

                onWindowResize();
                window.addEventListener("resize", onWindowResize, false);

                let animationId;
                const animate = () => {
                    animationId = requestAnimationFrame(animate);
                    uniforms.time.value += 0.05;
                    renderer.render(scene, camera);
                    if (shaderAnimationScene) {
                       shaderAnimationScene.animationId = animationId;
                    }
                };
                
                shaderAnimationScene = { renderer, animationId: 0, removeListeners: () => window.removeEventListener("resize", onWindowResize) };
                animate();
            }

            // -----------------------------------------------------------------------------
            // 9. FUNCIONALIDADE: CONFIGURAÇÕES
            // -----------------------------------------------------------------------------
            
            const handleChangePassword = async (event) => {
                event.preventDefault();
                const msgEl = document.getElementById('password-change-message');
                msgEl.textContent = ''; msgEl.className = 'text-sm h-5';
                
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (newPassword !== confirmPassword) {
                    msgEl.textContent = 'As novas senhas não coincidem.'; msgEl.classList.add('text-red-500'); return;
                }
                if (newPassword.length < 6) {
                    msgEl.textContent = 'A nova senha deve ter no mínimo 6 caracteres.'; msgEl.classList.add('text-red-500'); return;
                }

                const sessionData = JSON.parse(localStorage.getItem('clinicSession') || sessionStorage.getItem('clinicSession'));
                if (sessionData.senha !== currentPassword) {
                    msgEl.textContent = 'A senha atual está incorreta.'; msgEl.classList.add('text-red-500'); return;
                }
                
                const { error } = await supabase.from('usuarios_site').update({ senha: newPassword }).eq('email', sessionData.email);

                if (error) {
                    msgEl.textContent = 'Erro ao atualizar a senha. Tente novamente.'; msgEl.classList.add('text-red-500');
                } else {
                    msgEl.textContent = 'Senha alterada com sucesso!'; msgEl.classList.add('text-green-500');
                    sessionData.senha = newPassword;
                    const storage = localStorage.getItem('clinicSession') ? localStorage : sessionStorage;
                    storage.setItem('clinicSession', JSON.stringify(sessionData));
                    document.getElementById('password-change-form').reset();
                }
            };


            // -----------------------------------------------------------------------------
            // 10. UTILITÁRIOS E FUNÇÕES AUXILIARES
            // -----------------------------------------------------------------------------
            const timeAgo = (date) => {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " anos atrás";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " meses atrás";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " dias atrás";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " horas atrás";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutos atrás";
                return Math.floor(seconds) + " segundos atrás";
            };
            const htmlEncode = (str) => typeof str !== 'string' ? '' : str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const getInitials = (name) => {
                if (!name) return '??';
                const cleanName = name.split('@')[0].replace(/[^a-zA-Z\s]/g, '').trim();
                if (!cleanName) return '??';
                const parts = cleanName.split(/\s+/);
                if (parts.length > 1) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                return parts[0].length > 1 ? parts[0].substring(0, 2).toUpperCase() : parts[0].toUpperCase();
            };
            const calculateAge = (birthdate) => {
                if (!birthdate) return null;
                try {
                    const birthDate = new Date(birthdate);
                    const ageDifMs = Date.now() - birthDate.getTime();
                    const ageDate = new Date(ageDifMs);
                    return Math.abs(ageDate.getUTCFullYear() - 1970);
                } catch (e) { return null; }
            };
            const formatTimestamp = (iso) => iso ? new Date(iso).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
            const togglePasswordVisibility = () => {
                const passwordInput = document.getElementById('password-input');
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                passwordToggle.querySelector('.eye-off').classList.toggle('hidden', isPassword);
                passwordToggle.querySelector('.eye').classList.toggle('hidden', !isPassword);
            };

            // -----------------------------------------------------------------------------
            // 11. EVENT LISTENERS & SIDEBAR LOGIC
            // -----------------------------------------------------------------------------

            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const navTexts = appSidebar.querySelectorAll('.nav-text');

            const expandSidebar = () => {
                if (window.innerWidth < 1024) return;
                appSidebar.classList.remove('lg:w-20');
                appSidebar.classList.add('w-64');
                mainContentWrapper.classList.remove('lg:pl-20');
                mainContentWrapper.classList.add('lg:pl-64');
                navTexts.forEach(text => text.classList.remove('hidden'));
            };

            const collapseSidebar = () => {
                if (window.innerWidth < 1024) return;
                appSidebar.classList.remove('w-64');
                appSidebar.classList.add('lg:w-20');
                mainContentWrapper.classList.remove('lg:pl-64');
                mainContentWrapper.classList.add('lg:pl-20');
                navTexts.forEach(text => text.classList.add('hidden'));
            };

            appSidebar.addEventListener('mouseenter', expandSidebar);
            appSidebar.addEventListener('mouseleave', collapseSidebar);
             if (window.innerWidth >= 1024) {
                collapseSidebar();
            }


            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('logout-link').addEventListener('click', (e) => { e.preventDefault(); showLogin(); });
            passwordToggle.addEventListener('click', togglePasswordVisibility);
            document.getElementById('password-change-form').addEventListener('submit', handleChangePassword);

            window.addEventListener('hashchange', () => showSection(window.location.hash));
            
            const handleNavClick = (e) => {
                const link = e.target.closest('a');
                if (link && link.hash) {
                    e.preventDefault();
                    window.location.hash = link.hash;
                    if (window.innerWidth < 768) { // Only for mobile sidebar
                        appSidebar.classList.add('hidden');
                        mobileMenuOverlay.classList.add('hidden');
                    }
                }
            };
            
            navLinks.addEventListener('click', handleNavClick);
            mobileNavLinks.addEventListener('click', handleNavClick);

            document.getElementById('user-profile-link-wrapper').addEventListener('click', (e) => {
                 const link = e.target.closest('a');
                 if (link && link.hash) {
                    e.preventDefault();
                    window.location.hash = link.hash;
                 }
            });

            mobileMenuButton.addEventListener('click', () => {
                appSidebar.classList.remove('hidden'); // Ensure it's visible for mobile
                appSidebar.classList.remove('lg:w-20');
                appSidebar.classList.add('w-64');
                navTexts.forEach(text => text.classList.remove('hidden'));
                mobileMenuOverlay.classList.remove('hidden');
            });
            mobileMenuOverlay.addEventListener('click', () => {
                appSidebar.classList.add('hidden');
                mobileMenuOverlay.classList.add('hidden');
            });
            

            const agendaSection = document.getElementById('agendamentos-section');
            if(agendaSection) {
                agendaSection.addEventListener('click', (e) => {
                     if (e.target.closest('#today-btn')) {
                        currentDate = new Date();
                        fetchAndRenderAgenda();
                     }
                     if (e.target.closest('#prev-week-btn')) {
                        currentDate.setDate(currentDate.getDate() - (currentCalendarView === 'daily' ? 1 : 7));
                        fetchAndRenderAgenda();
                     }
                     if (e.target.closest('#next-week-btn')) {
                        currentDate.setDate(currentDate.getDate() + (currentCalendarView === 'daily' ? 1 : 7));
                        fetchAndRenderAgenda();
                     }
                     if(e.target.matches('.view-toggle-btn')) {
                        currentCalendarView = e.target.dataset.view;
                        renderAgendaView();
                    }
                });
            }


            const newChatInput = document.getElementById('new-chat-input');
            const newSendButton = document.getElementById('new-send-button');

            if (newSendButton) newSendButton.addEventListener('click', sendMessage);
            if (newChatInput) newChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
            
            const chatSearchInput = document.getElementById('chat-search-input');
            if(chatSearchInput) {
                chatSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredChats = currentChats.filter(chat => chat.nomewpp.toLowerCase().includes(searchTerm) || chat.phone.includes(searchTerm));
                    renderChatList(filteredChats);
                });
            }

            const clientSearchInput = document.getElementById('client-search-input');
            if(clientSearchInput){
                 clientSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredClients = allClients.filter(client => client.nomewpp.toLowerCase().includes(searchTerm) || client.telefone.includes(searchTerm));
                    renderClientList(filteredClients);
                });
            }

            // -----------------------------------------------------------------------------
            // 12. INICIALIZAÇÃO DA APLICAÇÃO
            // -----------------------------------------------------------------------------
            
            initializeCharts();
            renderThemeToggle();
            checkSession();
        });
    </script>
</body>

</html>

